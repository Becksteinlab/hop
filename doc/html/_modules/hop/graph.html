

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>hop.graph &mdash; Hop 0.3.3 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.3.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Hop 0.3.3 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Hop 0.3.3 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for hop.graph</h1><div class="highlight"><pre>
<span class="c"># $Id$</span>
<span class="c"># Hop --- a framework to analyze solvation dynamics from MD simulations</span>
<span class="c"># Copyright (c) 2009 Oliver Beckstein &lt;orbeckst@gmail.com&gt;</span>
<span class="c">#</span>
<span class="c"># This program is free software: you can redistribute it and/or modify</span>
<span class="c"># it under the terms of the GNU General Public License as published by</span>
<span class="c"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c"># (at your option) any later version.</span>
<span class="c">#</span>
<span class="c"># This program is distributed in the hope that it will be useful,</span>
<span class="c"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c"># GNU General Public License for more details.</span>
<span class="c">#</span>
<span class="c"># You should have received a copy of the GNU General Public License</span>
<span class="c"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:mod:`hop.graph` module</span>
<span class="sd">=======================</span>

<span class="sd">Interprete the high density sites as graph (&#39;transport graph&#39;), with</span>
<span class="sd">the sites as vertices and transitions (sampled by the simulation) as</span>
<span class="sd">edges. The graph is directed.</span>

<span class="sd">Each edge (transition) is decorated with the dominant transition rate,</span>
<span class="sd">the number of events seen, and an instance of fit_func, which</span>
<span class="sd">represents the fitted function to the survival times.</span>

<span class="sd">Each vertex (site) is decorated with the average residency time (and stdev, N).</span>

<span class="sd">Typical use of the module::</span>

<span class="sd">  TN = TransportNetwork(hoppingTrajectory,density)</span>
<span class="sd">  hopgraph = TN.HoppingGraph()</span>
<span class="sd">  hopgraph.save(&#39;hopgraph&#39;)</span>

<span class="sd">The basic object is the :class:`hop.graph.HoppingGraph`; see its</span>
<span class="sd">documentation for further analysis methods.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">hop.constants</span><span class="o">,</span> <span class="nn">hop.trajectory</span>
<span class="kn">from</span> <span class="nn">hop.constants</span> <span class="kn">import</span> <span class="n">SITELABEL</span>
<span class="kn">import</span> <span class="nn">hop.utilities</span>
<span class="kn">from</span> <span class="nn">hop.utilities</span> <span class="kn">import</span> <span class="n">msg</span><span class="p">,</span><span class="n">set_verbosity</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">asiterable</span><span class="p">,</span> <span class="n">CustomProgressMeter</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="kn">as</span> <span class="nn">NX</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">cPickle</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">MDAnalysis.core.log</span> <span class="kn">import</span> <span class="n">ProgressMeter</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&quot;MDAnalysis.analysis.hop.graph&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="TransportNetwork"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.TransportNetwork">[docs]</a><span class="k">class</span> <span class="nc">TransportNetwork</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A framework for computing graphs from hopping trajectories.</span>

<span class="sd">    The unit of time is ps.</span>

<span class="sd">    The :class:`TransportNetwork` is an intermediate data structure</span>
<span class="sd">    that is mainly used in order to build a :class:`HoppingGraph` with</span>
<span class="sd">    the :meth:`TransportNetwork.HoppingGraph` method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">trajectory</span><span class="p">,</span><span class="n">density</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">sitelabels</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup a transport graph from a hopping trajectory instance.</span>

<span class="sd">        ::</span>
<span class="sd">            hops = hop.trajectory.HoppingTrajectory(hopdcd=&#39;whop.dcd&#39;,hoppsf=&#39;whop.psf&#39;)</span>
<span class="sd">            tn = TransportNetwork(hops)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trajectory</span><span class="p">,</span><span class="n">hop</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">HoppingTrajectory</span><span class="p">):</span>
            <span class="n">errmsg</span> <span class="o">=</span> <span class="s">&quot;&#39;trajectory&#39; must be a &lt;hop.trajectory.HoppingTrajectory&gt; instance.&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traj</span> <span class="o">=</span> <span class="n">trajectory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">hoptraj</span><span class="o">.</span><span class="n">numatoms</span>
        <span class="c"># TODO: use MDAnalysis unit conversion here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">hoptraj</span><span class="o">.</span><span class="n">delta</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">hoptraj</span><span class="o">.</span><span class="n">skip_timestep</span> \
                        <span class="o">*</span> <span class="n">hop</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">get_conversion_factor</span><span class="p">(</span><span class="s">&#39;time&#39;</span><span class="p">,</span><span class="s">&#39;AKMA&#39;</span><span class="p">,</span><span class="s">&#39;ps&#39;</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span> <span class="c"># ps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">totaltime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">totaltime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">NX</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Transport network between sites&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">density</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">density</span><span class="p">,</span><span class="n">hop</span><span class="o">.</span><span class="n">sitemap</span><span class="o">.</span><span class="n">Density</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;density must be a &lt;hop.sitemap.Density&gt; instance.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="n">density</span>  <span class="c"># only needed to pass down site_properties to hopgraph</span>

        <span class="k">if</span> <span class="n">sitelabels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s">&#39;sitelabels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sitelabels</span>

<div class="viewcode-block" id="TransportNetwork.graph_alltransitions"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.TransportNetwork.graph_alltransitions">[docs]</a>    <span class="k">def</span> <span class="nf">graph_alltransitions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructs the graph that contains all transitions in the trajectory.</span>

<span class="sd">        Populates TransportGraph.graph with a graph that contains all</span>
<span class="sd">        sites and one edge for each transition that was observed in</span>
<span class="sd">        the trajectory. Useful for an initial appraisal of the</span>
<span class="sd">        complexity of the problem.</span>

<span class="sd">        .. Warning:: Erases any previous contents of graph.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">izip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">NX</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Transitions between all sites, including interstitial and outliers&quot;</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">_x</span>      <span class="c"># s changes with the timestep (&#39;pointer&#39;)</span>
        <span class="n">slast</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>   <span class="c"># copy of the last frame</span>

        <span class="n">hops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">iterator</span><span class="p">()</span>
        <span class="n">hops</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>    <span class="c"># first frame is only needed for slast</span>
        <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">hops</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">izip</span><span class="p">(</span><span class="n">slast</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)))</span>
            <span class="n">slast</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>   <span class="c"># copy of the last frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s">&#39;sitelabels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="TransportNetwork.HoppingGraph"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.TransportNetwork.HoppingGraph">[docs]</a>    <span class="k">def</span> <span class="nf">HoppingGraph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">verbosity</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the HoppingGraph from the data and return it.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_residency_times</span><span class="p">(</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hopgraph</span>
</div>
    <span class="k">def</span> <span class="nf">compute_residency_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">verbosity</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_hops</span><span class="p">(</span><span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Building hopping graph with rate constants k1, k2 or k.&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;(Ignore &#39;Warning: ... maxfev = 800&#39;: then a single k is chosen automatically.)&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">site_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">site_properties</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">site_properties</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># should  add more trjdata attr: hoppsf,hopdcd,density(file)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hopgraph</span> <span class="o">=</span> <span class="n">HoppingGraph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_properties</span><span class="p">,</span>
                                     <span class="n">trjdata</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;dt&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span><span class="s">&#39;totaltime&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">totaltime</span><span class="p">,</span>
                                              <span class="s">&#39;time_unit&#39;</span><span class="p">:</span><span class="s">&#39;ps&#39;</span><span class="p">},</span>
                                     <span class="n">site_properties</span><span class="o">=</span><span class="n">site_properties</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_analyze_hops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Core function to compute the waiting times tau_ji for hops i-&gt;j</span>

<span class="sd">        :Results:</span>

<span class="sd">        self.graph</span>
<span class="sd">            directed graph of all transitions</span>
<span class="sd">        self.graph_properties</span>
<span class="sd">            Each edge (i,j) has a dictionary associated, containing</span>
<span class="sd">            the waiting times tau for hops from i --&gt; j, the barrier</span>
<span class="sd">            crossing times tbarrier (the time the particle was in the</span>
<span class="sd">            interstitial when hopping), the atom index numbers iatom,</span>
<span class="sd">            and the frames when site i was exited for the hop.</span>

<span class="sd">            iatom can be translated to the original atom serial</span>
<span class="sd">            numbers with the hopping trajectory psf.</span>

<span class="sd">        (Note: runs a few percent faster with verbosity=0)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c">#set_verbosity(verbosity) # not use with ProgressMeter</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s">&#39;sitelabels&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>   <span class="c"># 3 = outlier + 2</span>
                <span class="n">errmsg</span> <span class="o">=</span> <span class="s">&#39;TransportNetwork: Need at least 2 sites to analyze transitions: N=</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> \
                    <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s">&#39;sitelabels&#39;</span><span class="p">])</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">NX</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Transitions between sites&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph_properties</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>   <span class="c"># contains dicts for nodes and edges</span>

        <span class="n">hops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">iterator</span><span class="p">()</span>
        <span class="n">hops</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>    <span class="c"># make sure that we are on the first frame</span>

        <span class="n">snow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">_x</span>  <span class="c"># s changes with the timestep (&#39;pointer&#39;)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">snow</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>    <span class="c"># much faster than  numpy.array(snow,dtype=numpy.Int)</span>
        <span class="n">slast</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>        <span class="c"># unavoidable copy of the last frame</span>

        <span class="c"># state[i] = dict( s0, t0, t1) + slast, s</span>
        <span class="c">#  s0      assigned site        t0      time/frame for entering s0</span>
        <span class="c">#  last    site at t-1          t1      exit from s0</span>
        <span class="c">#  now     site at t           (t2      entering new site != s0)</span>
        <span class="c"># last == slast</span>
        <span class="c"># now  == s</span>
        <span class="c"># (A flat natoms x 5 int array may be faster but for the time being I need</span>
        <span class="c"># clean-ish code...)</span>
        <span class="c"># (could use a numpy.rec --- would do exactly what I want)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
        <span class="n">state</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[{</span><span class="s">&#39;s0&#39;</span><span class="p">:</span><span class="n">s</span><span class="p">[</span><span class="n">iatom</span><span class="p">],</span> <span class="s">&#39;t0&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="s">&#39;t1&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span> <span class="k">for</span> <span class="n">iatom</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span><span class="p">)]</span>
        <span class="n">pm</span> <span class="o">=</span> <span class="n">ProgressMeter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">n_frames</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                           <span class="n">format</span><span class="o">=</span><span class="s">&quot;Analyzing hops: frame </span><span class="si">%(step)5d</span><span class="s">/</span><span class="si">%(numsteps)d</span><span class="s">  [</span><span class="si">%(percentage)5.1f%%</span><span class="s">]</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">hops</span><span class="p">:</span>
            <span class="n">pm</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>
            <span class="c"># start from frame 2 (as we already used hops.next() above)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">snow</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

            <span class="c"># Bugs of the main loop:</span>
            <span class="c">#  * still counts (-1,1) transitions (outlier -&gt; bulk); currently they are</span>
            <span class="c">#    explicitly filtered when building the CombinedGraph</span>
            <span class="c">#  * Dan Willenbring reports that also (-1, N) show up.</span>
            <span class="c">#  * code is ugly and not optimized: should be possible to do this on all atoms at once</span>
            <span class="k">for</span> <span class="n">iatom</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span> <span class="o">==</span> <span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;outlier&#39;</span><span class="p">]:</span>
                    <span class="c"># outliers: count them as whence they came (typically, interstitial or bulk)</span>
                    <span class="n">s</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span> <span class="o">=</span> <span class="n">slast</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span> <span class="o">!=</span> <span class="n">state</span><span class="p">[</span><span class="n">iatom</span><span class="p">][</span><span class="s">&#39;s0&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">slast</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span> <span class="o">==</span> <span class="n">state</span><span class="p">[</span><span class="n">iatom</span><span class="p">][</span><span class="s">&#39;s0&#39;</span><span class="p">]:</span>
                        <span class="c"># particle exited site s0, so remember the exit time for the future:</span>
                        <span class="n">state</span><span class="p">[</span><span class="n">iatom</span><span class="p">][</span><span class="s">&#39;t1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">frame</span>
                    <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;interstitial&#39;</span><span class="p">]:</span>
                        <span class="c"># particle enters a new site s</span>
                        <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="n">iatom</span><span class="p">][</span><span class="s">&#39;s0&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;interstitial&#39;</span><span class="p">]:</span>
                            <span class="c"># s0 != interstitial ignores trajectories starting off-site,</span>
                            <span class="c"># for all others we collect data now, using the last known exit time:</span>
                            <span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="n">iatom</span><span class="p">][</span><span class="s">&#39;s0&#39;</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="n">iatom</span><span class="p">])</span>
                            <span class="n">tau</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">iatom</span><span class="p">][</span><span class="s">&#39;t1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">state</span><span class="p">[</span><span class="n">iatom</span><span class="p">][</span><span class="s">&#39;t0&#39;</span><span class="p">]</span>
                            <span class="n">tbarrier</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">frame</span> <span class="o">-</span> <span class="n">state</span><span class="p">[</span><span class="n">iatom</span><span class="p">][</span><span class="s">&#39;t1&#39;</span><span class="p">]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">graph_properties</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s">&#39;tau&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">graph_properties</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s">&#39;tbarrier&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tbarrier</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">graph_properties</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s">&#39;frame&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">graph_properties</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s">&#39;iatom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iatom</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">graph_properties</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;tau&#39;</span><span class="p">:[</span><span class="n">tau</span><span class="p">],</span><span class="s">&#39;tbarrier&#39;</span><span class="p">:[</span><span class="n">tbarrier</span><span class="p">],</span>
                                                               <span class="s">&#39;frame&#39;</span><span class="p">:[</span><span class="n">ts</span><span class="o">.</span><span class="n">frame</span><span class="p">],</span><span class="s">&#39;iatom&#39;</span><span class="p">:[</span><span class="n">iatom</span><span class="p">]}</span>
                        <span class="c">#else:</span>
                            <span class="c"># particle started from interstitial and it&#39;s the first time</span>
                            <span class="c"># on a site so we only re-start its clock (&#39;reset state&#39;)</span>
                            <span class="c"># pass</span>
                        <span class="c"># reset state</span>
                        <span class="n">state</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;s0&#39;</span><span class="p">:</span><span class="n">s</span><span class="p">[</span><span class="n">iatom</span><span class="p">],</span> <span class="s">&#39;t0&#39;</span><span class="p">:</span> <span class="n">ts</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="s">&#39;t1&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
            <span class="n">slast</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>   <span class="c"># copy of the last frame</span>

        <span class="c"># mop up last frame: we can&#39;t compute rates but at least use</span>
        <span class="c"># the residency time for anything that still sits on a site or</span>
        <span class="c"># sat on a site and is now back in the interstitial</span>
        <span class="k">for</span> <span class="n">iatom</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="n">iatom</span><span class="p">][</span><span class="s">&#39;s0&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;interstitial&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">iatom</span><span class="p">][</span><span class="s">&#39;s0&#39;</span><span class="p">]</span>          <span class="c"># last site visited</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">frame</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">frame</span> <span class="o">-</span> <span class="n">state</span><span class="p">[</span><span class="n">iatom</span><span class="p">][</span><span class="s">&#39;t0&#39;</span><span class="p">]</span>   <span class="c"># time since ENTERING the last site</span>
            <span class="n">tbarrier</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph_properties</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s">&#39;tau&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph_properties</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s">&#39;tbarrier&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tbarrier</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph_properties</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s">&#39;frame&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph_properties</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s">&#39;iatom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iatom</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph_properties</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;tau&#39;</span><span class="p">:[</span><span class="n">tau</span><span class="p">],</span><span class="s">&#39;tbarrier&#39;</span><span class="p">:[</span><span class="bp">None</span><span class="p">],</span>
                                               <span class="s">&#39;frame&#39;</span><span class="p">:[</span><span class="n">frame</span><span class="p">],</span><span class="s">&#39;iatom&#39;</span><span class="p">:[</span><span class="n">iatom</span><span class="p">]}</span>

        <span class="c"># convert times from frames to ps and use numpy arrays to organize data</span>
        <span class="c"># (less clear but easier to slice and dice)</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_properties</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">d</span><span class="p">[</span><span class="s">&#39;frame&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;frame&#39;</span><span class="p">])</span>
            <span class="n">d</span><span class="p">[</span><span class="s">&#39;iatom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;iatom&#39;</span><span class="p">])</span>
            <span class="n">d</span><span class="p">[</span><span class="s">&#39;tau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;tau&#39;</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="s">&#39;tbarrier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;tbarrier&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="s">&#39;tbarrier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;tbarrier&#39;</span><span class="p">])</span>
            <span class="c"># axis 0 in array is the event number: [tau,tbarrier,iatom,frame]</span>
        <span class="k">if</span> <span class="s">&#39;sitelabels&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>          <span class="c"># update cache</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s">&#39;sitelabels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s">&#39;sitelabels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

<div class="viewcode-block" id="TransportNetwork.compute_site_times"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.TransportNetwork.compute_site_times">[docs]</a>    <span class="k">def</span> <span class="nf">compute_site_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">verbosity</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the &#39;residency&#39; time of each water molecule on each site.</span>

<span class="sd">        The &#39;site time&#39; of a site i is computed as::</span>

<span class="sd">          theta[i] = 1/T_sim ( Sum_j tau[j,i] + Sum tau[i] )</span>

<span class="sd">        tau[j,i] is the waiting time for hops from i to j. tau[i] is</span>
<span class="sd">        the waiting time for molecules that are not observed to leave</span>
<span class="sd">        site i.</span>


<span class="sd">        The function updates self.theta[site] for each site with an</span>
<span class="sd">        array of residency times (in ps).</span>

<span class="sd">        It uses the residency times and thus requires</span>
<span class="sd">        compute_residency_times() was run previously.</span>

<span class="sd">        :TODO:</span>
<span class="sd">          Maybe use the barrier time as well (or a portion thereof,</span>
<span class="sd">          perhaps proportional to the barrier height (related to the</span>
<span class="sd">          kji) --- rate theory??)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hopgraph</span><span class="o">.</span><span class="n">properties</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">hop</span><span class="o">.</span><span class="n">MissingDataError</span><span class="p">(</span><span class="s">&quot;No hopgraph found. Run &#39;compute_residency_times()&#39; first.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>        <span class="c"># dict of arrays</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">props</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
                <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">edge</span>       <span class="c"># i --&gt; j</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">edge</span>         <span class="c"># molecule did not leave site</span>
            <span class="c"># could look at &#39;tbarrier&#39; as well</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">props</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s">&#39;tau&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s">&#39;tau&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>       <span class="c"># make a new array</span>
</div>
<div class="viewcode-block" id="TransportNetwork.compute_site_occupancy"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.TransportNetwork.compute_site_occupancy">[docs]</a>    <span class="k">def</span> <span class="nf">compute_site_occupancy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes occupancies from the residency times theta and updates self.occupancy.</span>

<span class="sd">        occupancy::</span>
<span class="sd">                      N_i</span>
<span class="sd">           o[i] = 1/T Sum theta[i,k]</span>
<span class="sd">                      k=1</span>

<span class="sd">        where T is the total trajectory time and the sum runs over</span>
<span class="sd">        all residency times that were recorded for the site i.</span>

<span class="sd">        :Attributes:</span>

<span class="sd">        self.occupancy</span>
<span class="sd">                         numpy array with occupancies, site label == index</span>
<span class="sd">        self.occupancy_error</span>
<span class="sd">                         numpy array with error estimates for</span>
<span class="sd">                         occupancies (Delta = Delta(theta)/T; this is</span>
<span class="sd">                         a biased estimate because Delta(theta) is</span>
<span class="sd">                         calculated with N instead of N-1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="c"># need to compute thetas first</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_site_times</span><span class="p">(</span><span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c"># array for accumulated site times</span>
        <span class="c"># assumptions: labels are integers from 0 to smax</span>
        <span class="n">smax</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s">&#39;sitelabels&#39;</span><span class="p">])</span> <span class="c"># exists after compute_site_times()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occupancy</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">smax</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>        <span class="c"># include 0 so that label matches index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_error</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">smax</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c"># error estimate (biased, N, not N-1)</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span><span class="n">thetas</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">occupancy</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">thetas</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">totaltime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_error</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">thetas</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">totaltime</span> <span class="c"># biased</span>
</div>
<div class="viewcode-block" id="TransportNetwork.plot_residency_times"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.TransportNetwork.plot_residency_times">[docs]</a>    <span class="k">def</span> <span class="nf">plot_residency_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">exclude_outliers</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot histograms of all sites</span>

<span class="sd">        plot_residency_times(&#39;sitetime.eps&#39;)</span>

<span class="sd">        pylab always writes the figure to the named file. If pylab is</span>
<span class="sd">        already running, display the graph with pylab.show().</span>

<span class="sd">        The histograms are normalized and the time values are the left</span>
<span class="sd">        edges of the bins.</span>

<span class="sd">        If bins=None then the number of bins is determined heuristically.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pylab</span>

        <span class="k">if</span> <span class="n">exclude_outliers</span><span class="p">:</span>
            <span class="n">firstSitePos</span> <span class="o">=</span> <span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;bulk&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">firstSitePos</span> <span class="o">=</span> <span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;interstitial&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">bins</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">nbins</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">bins</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">nbins</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">floor</span><span class="p">,</span><span class="n">ceil</span>

                <span class="n">nbins</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">/</span><span class="mf">10.0</span><span class="p">)</span>  <span class="c"># uniform dist: 10 counts per bins</span>
                <span class="n">minresolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
                <span class="n">trange</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                <span class="n">resolution</span> <span class="o">=</span> <span class="n">trange</span><span class="o">/</span><span class="n">nbins</span>

                <span class="k">if</span> <span class="n">nbins</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span> <span class="n">nbins</span> <span class="o">=</span> <span class="mi">5</span>
                <span class="k">if</span> <span class="n">resolution</span> <span class="o">&lt;</span> <span class="n">minresolution</span><span class="p">:</span>
                    <span class="n">nbins</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">trange</span><span class="o">/</span><span class="n">minresolution</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">nbins</span>

        <span class="n">pylab</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s">&#39;sitelabels&#39;</span><span class="p">][</span><span class="n">firstSitePos</span><span class="p">:]:</span>
            <span class="n">h</span><span class="p">,</span><span class="n">e</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">site</span><span class="p">],</span>
                                  <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">site</span><span class="p">]),</span><span class="n">normed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="n">h</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;site &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">site</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;residency time  theta/ps&#39;</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TransportNetwork.plot_site_occupancy"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.TransportNetwork.plot_site_occupancy">[docs]</a>    <span class="k">def</span> <span class="nf">plot_site_occupancy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                            <span class="n">exclude_sites</span><span class="o">=</span><span class="p">[</span><span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;interstitial&#39;</span><span class="p">],</span><span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;bulk&#39;</span><span class="p">]]):</span>
        <span class="sd">&quot;&quot;&quot;Plot site occupancy (from compute_site_occupancy().</span>

<span class="sd">        plot_site_occupancy(filename,exclude_sites=[0,1])</span>

<span class="sd">        filename         name of output file</span>
<span class="sd">        bins             bins for histogram (see numpy.histogram)</span>
<span class="sd">        exclude_site     list of site labels which are NOT plotted. Typically,</span>
<span class="sd">                         exclude interstitial and bulk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pylab</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">occupancy</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_site_occupancy</span><span class="p">()</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">occupancy</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">map</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">remove</span><span class="p">,</span> <span class="n">exclude_sites</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>      <span class="c"># BUG: fails on first non-existent site but should be ok</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">occ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy</span><span class="p">[</span><span class="n">labels</span><span class="p">]</span>
        <span class="n">occ_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_error</span><span class="p">[</span><span class="n">labels</span><span class="p">]</span>

        <span class="n">h</span><span class="p">,</span><span class="n">e</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">occ</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span><span class="n">normed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">edges</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">,[</span><span class="mi">2</span><span class="o">*</span><span class="n">e</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">e</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]])</span> <span class="c"># guess last upper edge</span>
        <span class="n">midpoints</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">pylab</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span><span class="n">occ</span><span class="p">,</span><span class="n">occ_err</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s">&#39;k.&#39;</span><span class="p">,</span><span class="n">capsize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;site label&#39;</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;site occupancy&#39;</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">midpoints</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="s">&#39;k-&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;site occupancy&#39;</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="s">&#39;normalized</span><span class="se">\n</span><span class="s">distribution&#39;</span><span class="p">,),</span><span class="s">&#39;best&#39;</span><span class="p">)</span>

        <span class="n">pylab</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="TransportNetwork.export"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.TransportNetwork.export">[docs]</a>    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="s">&#39;png&#39;</span><span class="p">,</span><span class="n">exclude_outliers</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Export the graph as dot file and as an image.</span>

<span class="sd">        export(filename)</span>

<span class="sd">        See https://networkx.lanl.gov/reference/pygraphviz/pygraphviz.agraph.AGraph-class.html#draw for possible output formats.</span>

<span class="sd">        See http://graphviz.org/doc/info/attrs.html for attributes.</span>

<span class="sd">        Note: On Mac OS X 10.3.9+fink the pygraphviz rendering is</span>
<span class="sd">        buggy and does not include node labels. Simply use the</span>
<span class="sd">        exported .dot file and use Mac OS X graphviz from</span>
<span class="sd">        http://www.pixelglow.com/graphviz/</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">pygraphviz</span>

        <span class="n">gfxname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">format</span><span class="p">)</span>
        <span class="n">dotname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;dot&#39;</span><span class="p">)</span>       <span class="c"># load into graphviz</span>

        <span class="n">G</span> <span class="o">=</span> <span class="n">pygraphviz</span><span class="o">.</span><span class="n">AGraph</span><span class="p">(</span><span class="n">directed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">())</span>

        <span class="n">G</span><span class="o">.</span><span class="n">graph_attr</span><span class="p">[</span><span class="s">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Water transport network in 1IFC&#39;</span>
        <span class="n">G</span><span class="o">.</span><span class="n">graph_attr</span><span class="p">[</span><span class="s">&#39;splines&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;true&#39;</span>
        <span class="n">G</span><span class="o">.</span><span class="n">graph_attr</span><span class="p">[</span><span class="s">&#39;fontcolor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;white&#39;</span>
        <span class="n">G</span><span class="o">.</span><span class="n">node_attr</span><span class="p">[</span><span class="s">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;circle&#39;</span>
        <span class="n">G</span><span class="o">.</span><span class="n">node_attr</span><span class="p">[</span><span class="s">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;black&#39;</span>
        <span class="n">G</span><span class="o">.</span><span class="n">edge_attr</span><span class="p">[</span><span class="s">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;black&#39;</span>
        <span class="n">G</span><span class="o">.</span><span class="n">edge_attr</span><span class="p">[</span><span class="s">&#39;dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;forward&#39;</span>

        <span class="n">G</span><span class="o">.</span><span class="n">layout</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="s">&#39;circo&#39;</span><span class="p">)</span>
        <span class="n">G</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dotname</span><span class="p">)</span>
        <span class="n">G</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">gfxname</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">)</span>  <span class="c"># buggy on Mac OS X</span>

</div></div>
<div class="viewcode-block" id="HoppingGraph"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph">[docs]</a><span class="k">class</span> <span class="nc">HoppingGraph</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A directed graph that describes the average movement of</span>
<span class="sd">    molecules between different well-defined sites by treating the</span>
<span class="sd">    sites as nodes and transitions as edges.</span>

<span class="sd">    :Attributes:</span>
<span class="sd">    graph</span>
<span class="sd">        graph with edges; edges contain rates, fit functions, etc</span>
<span class="sd">    properties</span>
<span class="sd">        raw data for edges</span>
<span class="sd">    trjdata</span>
<span class="sd">        metadata of the original trajectory</span>
<span class="sd">    site_properties</span>
<span class="sd">        density-derived node properties, imported from hop.sitemap.Density</span>
<span class="sd">    theta</span>
<span class="sd">        dict of nodes with residence times (see compute_site_times())</span>
<span class="sd">    occupancy_avg</span>
<span class="sd">        average occupancy with standard deviation (see compute_site_occupancy())</span>
<span class="sd">    occupancy_std</span>
<span class="sd">        (numpy array)</span>

<span class="sd">    :Methods:</span>
<span class="sd">    compute_site_occupancy()</span>
<span class="sd">        Computes occupancies from the residency times theta and</span>
<span class="sd">        updates self.occupancy_avg and self.occupancy_std.</span>
<span class="sd">    compute_site_times()</span>
<span class="sd">        Computes residency time theta.</span>
<span class="sd">    save()</span>
<span class="sd">        save graph as a pickled file</span>
<span class="sd">    load()</span>
<span class="sd">        reinstantiate graph from saved file; typically just use the</span>
<span class="sd">        constructor with the filename argument</span>
<span class="sd">    filter()</span>
<span class="sd">        make a filtered graph for further analysis and visualization;</span>
<span class="sd">        most plot/export functions require a filtered graph</span>
<span class="sd">    plot_fits()</span>
<span class="sd">        plot fits of the survival time against the data</span>
<span class="sd">    tabulate_k()</span>
<span class="sd">        table of rate constants</span>
<span class="sd">    export()</span>
<span class="sd">        export graph as a dot file that can be used with graphviz</span>
<span class="sd">    export3D()</span>
<span class="sd">        export graph as a psf/pdb file combination for visualization in VMD</span>

<span class="sd">    Properties for nodes are always stored as numpy arrays so that one</span>
<span class="sd">    can directly index with the node label (==site label), which is an</span>
<span class="sd">    integer from 0 to the number of nodes. Note that 0 is the</span>
<span class="sd">    interstitial (and only contains bogus data or None), and 1 is the</span>
<span class="sd">    bulk. The bulk site is often excluded from analysis because it is</span>
<span class="sd">    different in nature from the &#39;real&#39; sites defined as high density</span>
<span class="sd">    regions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">graph</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">properties</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">trjdata</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">site_properties</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Directed graph with edges containing the rate k_ji,number of observations and S(t) fit.</span>

<span class="sd">          h = HoppingGraph(graph,properties)</span>
<span class="sd">          h = HoppingGraph(filename=&#39;HoppingGraph.pickle&#39;)</span>

<span class="sd">        :Arguments:</span>
<span class="sd">        graph</span>
<span class="sd">           networkx graph with nodes (i) and edges (i,j)</span>
<span class="sd">        properties</span>
<span class="sd">           dictionary of edges: For each edge e, properties contains a</span>
<span class="sd">           dictionary, which contains under the key &#39;tau&#39; a list of</span>
<span class="sd">           observed waiting times tau_ji.  nodes are also listed if</span>
<span class="sd">           they do not participate in a transition</span>
<span class="sd">        trjdata</span>
<span class="sd">           dictionary describing properties of the trajectory</span>
<span class="sd">           such as time step &#39;dt&#39; or name of &#39;dcd&#39; and &#39;psf&#39;.</span>

<span class="sd">           Attributes that are in use:</span>
<span class="sd">              dt</span>
<span class="sd">                 time between saved snapshots in ps</span>
<span class="sd">              hoppsf</span>
<span class="sd">                 hopping trajectory psf file name</span>
<span class="sd">              hopdcd</span>
<span class="sd">                 hopping trajectory dcd file name</span>
<span class="sd">              density</span>
<span class="sd">                 pickle file of the density with the sites</span>
<span class="sd">              totaltime</span>
<span class="sd">                 length of trajectory in ps[*]_</span>

<span class="sd">           Not used:</span>
<span class="sd">              time_unit</span>
<span class="sd">                 &#39;ps&#39;</span>

<span class="sd">           .. _[*]: required for :meth:`compute_occupancy`</span>

<span class="sd">        site_properties</span>
<span class="sd">           list of site properties:</span>
<span class="sd">           :attr:`hop.sitemap.Density.site_properties` (add if you want graphs</span>
<span class="sd">           with mapped labels) (**Really required for most things...!**)</span>

<span class="sd">        When the graph is built from edges and properties then the</span>
<span class="sd">        rate constants are calculated. For graphs with many hopping</span>
<span class="sd">        events this can take a long time (hours...).</span>

<span class="sd">        The decorated and directed graph is accessible as :attr:`HoppingGraph.graph`</span>

<span class="sd">        :BUGS:</span>
<span class="sd">        * *trjdata* is  required for full functionality but it is currently the user&#39;s</span>
<span class="sd">          responsibility to fill it appropriately (although :meth:`TransportNetwork.compute_residency_times`</span>
<span class="sd">          already adds some data)</span>
<span class="sd">        * *site_properties* **are** required and must be added with the constructor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trjdata</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trjdata</span> <span class="o">=</span> <span class="n">trjdata</span>   <span class="c"># overwritten when load()ing unless none present in saved</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">site_properties</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">recarray</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span> <span class="o">=</span> <span class="n">site_properties</span>  <span class="c"># managed attribute; also builds equivalent_sites_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">graph</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">properties</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">NX</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Transitions between sites&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">properties</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes_iter</span><span class="p">())</span>  <span class="c"># nodes for completeness</span>
            <span class="c">#-------------------------------------------------------------------------------</span>
            <span class="c"># Compute rates for each edge from list of tau (can take a while!);</span>
            <span class="c"># here the format of an edge is defined: (from_site,to_site,rate_tuple)</span>
            <span class="n">ebunch</span> <span class="o">=</span> <span class="p">[(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_rate</span><span class="p">(</span><span class="n">properties</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="s">&#39;tau&#39;</span><span class="p">]))</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges_iter</span><span class="p">()]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">ebunch</span><span class="p">)</span>  <span class="c"># leaves out any nodes that have no edges</span>
            <span class="c">#-------------------------------------------------------------------------------</span>
        <span class="k">elif</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;provide edges and properties or a filename&#39;</span><span class="p">)</span>

    <span class="c"># convenience functions to access data in an edge (=hop)</span>
    <span class="c"># NX 1.x: edge = (from_site, to_site, {&#39;k&#39;: k, &#39;N&#39;:N, &#39;fit&#39;: fit_func})</span>
    <span class="c"># edge from graph.edges(data=True)</span>
<div class="viewcode-block" id="HoppingGraph.rate"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.rate">[docs]</a>    <span class="k">def</span> <span class="nf">rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">edge</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the fastest rate on an edge, in ns^-1&quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">waitingtime_fit</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c"># exp(-k*t)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c"># a exp(-k1*t) + (1-a)exp(-k2*t)</span>
            <span class="n">a</span><span class="p">,</span><span class="n">k1</span><span class="p">,</span><span class="n">k2</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">parameters</span>
            <span class="c">## select rate that contributes more:</span>
            <span class="c">##if a*k1 &gt; (1-a)*k2:</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">k1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">k2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Unknown waitingtime fit, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">k</span>   <span class="c"># 1/ps --&gt; 1/ns</span>
</div>
<div class="viewcode-block" id="HoppingGraph.number_of_hops"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.number_of_hops">[docs]</a>    <span class="k">def</span> <span class="nf">number_of_hops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">edge</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of transitions recorded.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s">&#39;N&#39;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="HoppingGraph.waitingtime_fit"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.waitingtime_fit">[docs]</a>    <span class="k">def</span> <span class="nf">waitingtime_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">edge</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the fit function for the edge&#39;s waiting time distribution.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s">&#39;fit&#39;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="HoppingGraph.from_site"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.from_site">[docs]</a>    <span class="k">def</span> <span class="nf">from_site</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">edge</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the originating site of hop.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="HoppingGraph.to_site"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.to_site">[docs]</a>    <span class="k">def</span> <span class="nf">to_site</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">edge</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the site to which a hop is directed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="HoppingGraph.is_from_bulk"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.is_from_bulk">[docs]</a>    <span class="k">def</span> <span class="nf">is_from_bulk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">edge</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if the edge originated in the bulk.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_site</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span> <span class="o">==</span> <span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;bulk&#39;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="HoppingGraph.site_properties"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.site_properties">[docs]</a>    <span class="k">def</span> <span class="nf">site_properties</span><span class="p">():</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;Site_properties, indexed by node label.</span>
<span class="s">              Setting this attribut also updates self.equivalent_sites_index.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">fget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__site_properties</span>
        <span class="k">def</span> <span class="nf">fset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__site_properties</span> <span class="o">=</span> <span class="n">x</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># recreate equivalent_sites_index (no need to store it)</span>
                <span class="n">Q</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">equivalence_label</span> <span class="o">&gt;</span> <span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;bulk&#39;</span><span class="p">]]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">equivalent_sites_index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">equivalence_label</span><span class="p">,</span><span class="n">Q</span><span class="o">.</span><span class="n">label</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="c"># should still work for densities without equivalence sites</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">equivalent_sites_index</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span></div>
    <span class="n">site_properties</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="o">**</span><span class="n">site_properties</span><span class="p">())</span>

<div class="viewcode-block" id="HoppingGraph.compute_site_times"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.compute_site_times">[docs]</a>    <span class="k">def</span> <span class="nf">compute_site_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">verbosity</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the &#39;residency&#39; time of each water molecule on each site.</span>

<span class="sd">        compute_site_times()</span>

<span class="sd">        The &#39;life time&#39; of a site i is computed as</span>

<span class="sd">          theta[i] = &lt;t[*,i]&gt;</span>

<span class="sd">        where t[*,i] stands for all waiting times t[j,i] for hops from</span>
<span class="sd">        site i to all other sites AND the waiting times t[i] of</span>
<span class="sd">        molecules that are not observed to leave site i.</span>

<span class="sd">        * The function updates self.theta[site] for each site with an</span>
<span class="sd">        array of residency times (in ps).</span>

<span class="sd">        * The life times are stored in self.lifetime_avg[site] and</span>
<span class="sd">          self.lifetime_std[site]</span>

<span class="sd">        TODO:</span>
<span class="sd">        * Maybe use the barrier time as well (or a portion thereof,</span>
<span class="sd">          perhaps proportional to the barrier height (related to the</span>
<span class="sd">          kji) --- rate theory??)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>        <span class="c"># dict of arrays</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
                <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">edge</span>       <span class="c"># i --&gt; j</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">edge</span>         <span class="c"># molecule did not leave site</span>
            <span class="c"># could look at &#39;tbarrier&#39; as well</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s">&#39;tau&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s">&#39;tau&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>       <span class="c"># make a new array</span>
        <span class="c"># array for accumulated site times</span>
        <span class="c"># assumptions: labels are integers from 0 to smax</span>
        <span class="n">smax</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lifetime_avg</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">smax</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>        <span class="c"># include 0 so that label matches index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lifetime_std</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">smax</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c"># error estimate (biased, N, not N-1)</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span><span class="n">thetas</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lifetime_avg</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">thetas</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lifetime_std</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">thetas</span><span class="p">)</span> <span class="c"># biased</span>
</div>
<div class="viewcode-block" id="HoppingGraph.compute_site_occupancy"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.compute_site_occupancy">[docs]</a>    <span class="k">def</span> <span class="nf">compute_site_occupancy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes occupancies from the residency times theta and updates self.occupancy.</span>

<span class="sd">        compute_site_occupancy()</span>

<span class="sd">        occupancy::</span>
<span class="sd">                        N_i</span>
<span class="sd">             o[i] = 1/T Sum theta[i,k]</span>
<span class="sd">                        k=1</span>

<span class="sd">           where T is the total trajectory time and the sum runs over</span>
<span class="sd">           all residency times that were recorded for the site i.</span>

<span class="sd">        attributes:</span>

<span class="sd">           self.occupancy_avg</span>
<span class="sd">                numpy array with occupancies, site label == index</span>
<span class="sd">           self.occupancy_std</span>
<span class="sd">                numpy array with error estimates for occupancies</span>
<span class="sd">                (Delta = Delta(theta)/T; this is a biased estimate because</span>
<span class="sd">                Delta(theta) is calculated with N instead of N-1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="c"># need to compute thetas first</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_site_times</span><span class="p">(</span><span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c"># array for accumulated site times</span>
        <span class="c"># assumptions: labels are integers from 0 to smax</span>
        <span class="n">smax</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_avg</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">smax</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>        <span class="c"># include 0 so that label matches index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_std</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">smax</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c"># error estimate (biased, N, not N-1)</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span><span class="n">thetas</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_avg</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">thetas</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjdata</span><span class="p">[</span><span class="s">&#39;totaltime&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_std</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">thetas</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjdata</span><span class="p">[</span><span class="s">&#39;totaltime&#39;</span><span class="p">]</span> <span class="c"># biased</span>
</div>
<div class="viewcode-block" id="HoppingGraph.save"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save HoppingGraph as a pickled python object.&quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;pickle&#39;</span><span class="p">,</span><span class="n">set_default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;wb&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fh</span><span class="p">,</span><span class="n">cPickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="HoppingGraph.load"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reinstantiate HoppingGraph from a pickled HoppingGraph (from save()).&quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;pickle&#39;</span><span class="p">,</span><span class="n">set_default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;rb&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c"># restore attributes from the temporary instance (works but not elegant...)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="s">&#39;graph&#39;</span><span class="p">,</span> <span class="s">&#39;properties&#39;</span><span class="p">,</span> <span class="s">&#39;filtered_graph&#39;</span><span class="p">,</span> <span class="s">&#39;trjdata&#39;</span><span class="p">,</span> \
                <span class="s">&#39;node_properties&#39;</span><span class="p">,</span><span class="s">&#39;occupancy_avg&#39;</span><span class="p">,</span><span class="s">&#39;occupancy_std&#39;</span><span class="p">,</span> <span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">attr</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="c"># managed attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">site_properties</span>
        <span class="k">del</span> <span class="n">h</span>

    <span class="c"># XXX: monkey patching, should do this with inheritance/mixin class</span></div>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">hop</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">filename_function</span>

<div class="viewcode-block" id="HoppingGraph.filter"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.filter">[docs]</a>    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">exclude</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a filtered version of the graph.</span>

<span class="sd">        For looking at most things:</span>
<span class="sd">        &gt;&gt;&gt; h.filter(exclude={&#39;outliers&#39;:True})</span>

<span class="sd">        For looking at exchange rates and plotting:</span>
<span class="sd">        &gt;&gt;&gt; h.filter(exclude={&#39;outliers&#39;:True, &#39;Nmin&#39;:5, &#39;unconnected&#39;:True})</span>

<span class="sd">        For export3D do not use the bulk site:</span>
<span class="sd">        &gt;&gt;&gt; h.filter(exclude={&#39;outliers&#39;:True,&#39;bulk&#39;:True})</span>

<span class="sd">        This method makes a copy of the hopping graph and applies the</span>
<span class="sd">        filter rules to the copy. Other output functions use this copy</span>
<span class="sd">        if it exists.</span>

<span class="sd">        exclude      dict of components to exclude. May contain</span>
<span class="sd">                     {&#39;outliers&#39;:True, &#39;Nmin&#39;:integer,</span>
<span class="sd">                      &#39;bulk&#39;: True, &#39;unconnected&#39;:True}</span>

<span class="sd">                     If outliers == True then all edges from the &#39;outlier&#39; node</span>
<span class="sd">                     are deleted previous to displaying the</span>
<span class="sd">                     graph. Those edges correspond to particles</span>
<span class="sd">                     starting in a region not covered by the intial</span>
<span class="sd">                     histogram boundaries and enter a mapped site at a</span>
<span class="sd">                     later point in time.</span>

<span class="sd">                     With Nmin, any node that has fewer than Nmin transition</span>
<span class="sd">                     is discarded.</span>

<span class="sd">                     unconnected == True finaly filters all nodes that have no</span>
<span class="sd">                     edges left</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">exclude</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c"># order matters for filters</span>
            <span class="k">if</span> <span class="s">&#39;Nmin&#39;</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s">&#39;N&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">exclude</span><span class="p">[</span><span class="s">&#39;Nmin&#39;</span><span class="p">]:</span>
                        <span class="n">G</span><span class="o">.</span><span class="n">remove_edge</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
                <span class="n">G</span><span class="o">.</span><span class="n">name</span> <span class="o">+=</span> <span class="s">&#39;, N&gt;=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">exclude</span><span class="p">[</span><span class="s">&#39;Nmin&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;outlier&#39;</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exclude</span><span class="p">[</span><span class="s">&#39;outlier&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;outlier&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">G</span><span class="p">:</span>
                    <span class="n">G</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;outlier&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;bulk&#39;</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exclude</span><span class="p">[</span><span class="s">&#39;bulk&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;bulk&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">G</span><span class="p">:</span>
                    <span class="n">G</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;bulk&#39;</span><span class="p">])</span>
                    <span class="n">G</span><span class="o">.</span><span class="n">name</span> <span class="o">+=</span> <span class="s">&#39;, bulk site omitted&#39;</span>
            <span class="k">if</span> <span class="s">&#39;unconnected&#39;</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exclude</span><span class="p">[</span><span class="s">&#39;unconnected&#39;</span><span class="p">]:</span>
                    <span class="n">delnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes_iter</span><span class="p">()</span> <span class="k">if</span> <span class="n">G</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="n">G</span><span class="o">.</span><span class="n">remove_nodes_from</span><span class="p">(</span><span class="n">delnodes</span><span class="p">)</span>
                    <span class="n">G</span><span class="o">.</span><span class="n">name</span> <span class="o">+=</span> <span class="s">&#39;, </span><span class="si">%d</span><span class="s"> sites omitted&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">delnodes</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">delnodes</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;&quot;exclude&quot; should have been a dict.&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="HoppingGraph.plot_fits"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.plot_fits">[docs]</a>    <span class="k">def</span> <span class="nf">plot_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nrow</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">dt</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">plottype</span><span class="o">=</span><span class="s">&#39;log&#39;</span><span class="p">,</span><span class="n">use_filtered_graph</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                  <span class="n">directory</span><span class="o">=</span><span class="s">&#39;survival_times&#39;</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="s">&#39;png&#39;</span><span class="p">,</span><span class="n">interactive</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                  <span class="n">verbosity</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot survival time fit against data.</span>

<span class="sd">        plot_fits(ncol=2)</span>

<span class="sd">        The time values are taken to cover all measured tau.</span>

<span class="sd">        ncol         number of columns</span>
<span class="sd">        nrow         number of rows per page</span>
<span class="sd">        plottype     &#39;linear&#39; or &#39;log&#39;</span>
<span class="sd">        dt           time step in ps; use value in self.trjdata[&#39;dt&#39;] or 1ps</span>
<span class="sd">        use_filtered_graph</span>
<span class="sd">                     True: use the filtered graph (see filter()),</span>
<span class="sd">                     False: use raw data.</span>
<span class="sd">        directory    save all pdf files under this directory</span>
<span class="sd">        format       file format for plot (png,eps,pdf... depends on matplotlib)</span>
<span class="sd">        interactive  False: do not display graphs on scren (default)</span>
<span class="sd">                     True: show graphs on screen, can be slow and probably</span>
<span class="sd">                     requires ipython as your python shell</span>
<span class="sd">        verbosity    chattiness level</span>

<span class="sd">        All N graphs are laid out in nrow x ncol grids on as many</span>
<span class="sd">        pages/figures as necessary.</span>

<span class="sd">        The pages are written as eps/pdf files using a fixed filename</span>
<span class="sd">        in the given directory (&#39;survival_times&#39; by default).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">math</span>
        <span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">errno</span>

        <span class="kn">import</span> <span class="nn">matplotlib</span>
        <span class="kn">from</span> <span class="nn">hop.utilities</span> <span class="kn">import</span> <span class="n">matplotlib_interactive</span>
        <span class="n">matplotlib_interactive</span><span class="p">(</span><span class="n">interactive</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

        <span class="n">set_verbosity</span><span class="p">(</span><span class="n">verbosity</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">os</span><span class="o">.</span><span class="n">error</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="c"># Is there a filtered graph we should use?</span>
        <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_graph</span><span class="p">(</span><span class="n">use_filtered_graph</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dt</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjdata</span><span class="p">[</span><span class="s">&#39;dt&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span><span class="ne">AttributeError</span><span class="p">):</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="mf">1.0</span>    <span class="c"># default guess of dt = 1 ps</span>
        <span class="k">def</span> <span class="nf">trange</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span><span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Linear 1d mesh covering all tau values + 2*dt more&quot;&quot;&quot;</span>
            <span class="n">tmin</span><span class="p">,</span><span class="n">tmax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">dt</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span><span class="n">tmax</span><span class="p">,</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plottype</span> <span class="ow">is</span> <span class="s">&quot;linear&quot;</span><span class="p">:</span>
            <span class="n">plotfunc</span> <span class="o">=</span> <span class="s">&#39;plot&#39;</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="s">&#39;best&#39;</span>
            <span class="n">fntempl</span> <span class="o">=</span> <span class="s">&#39;S_</span><span class="si">%02d</span><span class="s">&#39;</span>
            <span class="k">def</span> <span class="nf">tSrange</span><span class="p">(</span><span class="n">t_all</span><span class="p">,</span><span class="n">S</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;use all values of t for linear plots&quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="n">t_all</span>
        <span class="k">elif</span> <span class="n">plottype</span> <span class="ow">is</span> <span class="s">&quot;log&quot;</span><span class="p">:</span>
            <span class="n">plotfunc</span> <span class="o">=</span> <span class="s">&#39;semilogy&#39;</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="s">&#39;lower left&#39;</span>
            <span class="n">fntempl</span> <span class="o">=</span> <span class="s">&#39;S_</span><span class="si">%02d</span><span class="s">_log&#39;</span>
            <span class="k">def</span> <span class="nf">tSrange</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">S</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;only use values where S&gt;0&quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="n">t</span><span class="p">[</span><span class="n">S</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;plottype &quot;</span><span class="si">%s</span><span class="s">&quot; is not valid&#39;</span> <span class="o">%</span> <span class="n">plottype</span><span class="p">)</span>

        <span class="c"># extension determines plot output format</span>
        <span class="n">filename_templ</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span><span class="n">fntempl</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">format</span>

        <span class="c"># Layout all N plots on npage pages in a nrow x ncol grid.</span>
        <span class="n">nplots</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">number_of_edges</span><span class="p">()</span>
        <span class="n">npage</span> <span class="o">=</span> <span class="n">nrow</span> <span class="o">*</span> <span class="n">ncol</span>
        <span class="n">nfig</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="n">nplots</span><span class="o">/</span><span class="n">npage</span><span class="p">))</span>

        <span class="c"># erase all figures first</span>
        <span class="c"># (important in interactive sessions with figure pollution)</span>
        <span class="k">for</span> <span class="n">ifig</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nfig</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">ifig</span><span class="p">)</span>

        <span class="n">font</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;legend&#39;</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">font_manager</span><span class="o">.</span><span class="n">FontProperties</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="s">&#39;xx-small&#39;</span><span class="p">),</span> <span class="p">}</span>
        <span class="n">pm</span> <span class="o">=</span> <span class="n">CustomProgressMeter</span><span class="p">(</span><span class="n">nplots</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                 <span class="n">format</span><span class="o">=</span><span class="s">&quot;Preparing page </span><span class="si">%(other)2d</span><span class="s">, S(t) plot </span><span class="si">%(step)3d</span><span class="s">/</span><span class="si">%(numsteps)d</span><span class="s">  [</span><span class="si">%(percentage)5.1f%%</span><span class="s">].</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iplot</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">)):</span>
            <span class="c"># NX 1.x: e = (n1, n2, data) with data={&#39;k&#39;:k, &#39;N&#39;:N, &#39;fit&#39;:fit}</span>
            <span class="n">ifig</span> <span class="o">=</span> <span class="n">iplot</span><span class="o">/</span><span class="n">npage</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">isub</span> <span class="o">=</span> <span class="n">iplot</span> <span class="o">%</span> <span class="n">npage</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">pm</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">iplot</span><span class="p">,</span> <span class="n">ifig</span><span class="p">)</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">ifig</span><span class="p">)</span>  <span class="c"># , figsize=(8,11) letter 8.5&quot; x 11&quot;; use default</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span><span class="n">ncol</span><span class="p">,</span><span class="n">isub</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

            <span class="n">tau</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]][</span><span class="s">&#39;tau&#39;</span><span class="p">]</span>
            <span class="n">S</span> <span class="o">=</span> <span class="n">survivalfunction</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">trange</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
            <span class="n">tS</span> <span class="o">=</span> <span class="n">tSrange</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">S</span><span class="p">)</span>
            <span class="n">k</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">Sfit</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s">&#39;k&#39;</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s">&#39;N&#39;</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s">&#39;fit&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Sfit</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>         <span class="c"># get two rates if double exp</span>
                <span class="n">a</span><span class="p">,</span><span class="n">k1</span><span class="p">,</span><span class="n">k2</span> <span class="o">=</span> <span class="n">Sfit</span><span class="o">.</span><span class="n">parameters</span>
                <span class="n">kns</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">k1</span><span class="p">,</span><span class="n">k2</span><span class="p">])</span> <span class="c"># rate in 1/ns</span>
                <span class="n">k_legend</span> <span class="o">=</span> <span class="s">&quot;$k_{1}=</span><span class="si">%.1f</span><span class="s">/$ns [</span><span class="si">%.0f%%</span><span class="s">]</span><span class="se">\n</span><span class="s">$k_{2}=</span><span class="si">%.1f</span><span class="s">/$ns [</span><span class="si">%.0f%%</span><span class="s">]&quot;</span> <span class="o">%</span> \
                           <span class="p">(</span><span class="n">kns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">100</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">kns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">a</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kns</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="n">k</span>   <span class="c"># rate in 1/ns</span>
                <span class="n">k_legend</span> <span class="o">=</span> <span class="s">r&quot;$k=</span><span class="si">%.1f</span><span class="s">/$ns &quot;</span> <span class="o">%</span> <span class="n">kns</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">plotfunc</span><span class="p">)(</span><span class="n">tS</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">tS</span><span class="p">),</span><span class="s">&#39;k-&#39;</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">tau</span><span class="p">),</span><span class="s">&#39;k.&#39;</span><span class="p">)</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">plotfunc</span><span class="p">)(</span><span class="n">t</span><span class="p">,</span><span class="n">Sfit</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="s">&#39;r--&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="s">r&quot;$S(t)\/ </span><span class="si">%d</span><span class="s">\rightarrow</span><span class="si">%d</span><span class="s">$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="s">r&quot;$N=</span><span class="si">%d</span><span class="s">$&quot;</span> <span class="o">%</span> <span class="n">N</span><span class="p">,</span> <span class="n">k_legend</span><span class="p">),</span>
                      <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">numpoints</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="n">font</span><span class="p">[</span><span class="s">&#39;legend&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">ax</span><span class="o">.</span><span class="n">is_last_row</span><span class="p">()</span>  <span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;time $t$/ps&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ax</span><span class="o">.</span><span class="n">is_first_col</span><span class="p">()</span> <span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;$S(t)$&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ax</span><span class="o">.</span><span class="n">is_last_row</span><span class="p">()</span> <span class="ow">and</span> <span class="n">ax</span><span class="o">.</span><span class="n">is_last_col</span><span class="p">():</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">filename_templ</span> <span class="o">%</span> <span class="n">ifig</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
                <span class="c"># export as eps &amp; convert to pdf externally for older matplotlib</span>
                <span class="c"># (just use the default png!)</span>
                <span class="c">#os.system(&#39;epstopdf --outfile=%(pdf)s %(eps)s&#39; % locals())</span>
                <span class="c">#os.remove(eps)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Exported S(t) plot page </span><span class="si">%(ifig)d</span><span class="s"> to file </span><span class="si">%(filename)s</span><span class="s">.&quot;</span><span class="p">,</span> <span class="nb">locals</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="HoppingGraph.tabulate_k"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.tabulate_k">[docs]</a>    <span class="k">def</span> <span class="nf">tabulate_k</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of tuples (from, to, rate (in 1/ns), number of transitions).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">from_site</span><span class="p">(</span><span class="n">edge</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_site</span><span class="p">(</span><span class="n">edge</span><span class="p">),</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">(</span><span class="n">edge</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_hops</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span> <span class="p">)</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">)]</span>
</div>
<div class="viewcode-block" id="HoppingGraph.show_rates"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.show_rates">[docs]</a>    <span class="k">def</span> <span class="nf">show_rates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print the rates (in 1/ns) between sites, and the total number of observations.</span>

<span class="sd">        show_rates(file=filename)</span>

<span class="sd">        By default, prints to stdout but if *file* = filename then</span>
<span class="sd">        filename is opened and data are written to the file.</span>

<span class="sd">        A description of the fit function used to obtain the rate is</span>
<span class="sd">        also printed in the last column.</span>

<span class="sd">        Only the &quot;dominant&quot; rate is shown; see the fit_func</span>
<span class="sd">        description for cases when two rates were computed.</span>

<span class="sd">        .. SeeAlso:: :func:`HoppingGraph.tabulate_k`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%3d</span><span class="s"> --&gt; </span><span class="si">%3d</span><span class="s">   </span><span class="si">%6.1f</span><span class="s">  1/ns  </span><span class="si">%3d</span><span class="s">  </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">from_site</span><span class="p">(</span><span class="n">edge</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_site</span><span class="p">(</span><span class="n">edge</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">(</span><span class="n">edge</span><span class="p">),</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">number_of_hops</span><span class="p">(</span><span class="n">edge</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waitingtime_fit</span><span class="p">(</span><span class="n">edge</span><span class="p">)))</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="HoppingGraph.equivalent_sites_stats"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.equivalent_sites_stats">[docs]</a>    <span class="k">def</span> <span class="nf">equivalent_sites_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">elabels</span><span class="p">,</span><span class="n">equivalence</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Statistics about one or a list of equivalence sites.</span>

<span class="sd">        g.equivalent_sites_stats(elabels,equivalence=True)</span>

<span class="sd">        :Arguments:</span>
<span class="sd">        elabels         a single label or a list of node labels</span>
<span class="sd">        equivalence     True: interprete elabels as &#39;equivalence labels&#39;, i.e. the label</span>
<span class="sd">                        attached to a site common to two densities</span>
<span class="sd">                        False: elabels are labels local to the graph</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># TODO: return as a dict for processing</span>
        <span class="c">#       add graph attribute (default to 0 or None - or a reference to self?)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">elabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">elabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">elabels</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">equivalence</span><span class="p">:</span>
            <span class="n">nbunch</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">equivalent_sites_index</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">elabels</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nbunch</span> <span class="o">=</span> <span class="n">elabels</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nbunch</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">   elabel=</span><span class="si">%d</span><span class="s">   node=</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span><span class="o">.</span><span class="n">equivalence_name</span><span class="p">[</span><span class="n">node</span><span class="p">],</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span><span class="o">.</span><span class="n">equivalence_label</span><span class="p">[</span><span class="n">node</span><span class="p">],</span>
                 <span class="n">node</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;Node: &quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;---&quot;</span>
            <span class="k">print</span> <span class="s">&quot;In-edges:&quot;</span>
            <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">in_edges</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;Out-edges:&quot;</span>
            <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">out_edges</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
</div>
<div class="viewcode-block" id="HoppingGraph.stats"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.stats">[docs]</a>    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Statistics for the hopping graph.</span>

<span class="sd">          stats([data=dict]) --&gt; dict</span>

<span class="sd">        Without the data argument, the method just returns some</span>
<span class="sd">        interesting values gathered from the graph and the density. If</span>
<span class="sd">        a data dictionary is given, then the raw data are loaded into</span>
<span class="sd">        the dict and can be processed further by histogramming etc.</span>

<span class="sd">        :Arguments:</span>
<span class="sd">           data</span>
<span class="sd">               optional dictionary to hold raw data for processing;</span>
<span class="sd">               modified by method</span>

<span class="sd">        :Returns:  dictionary with expressive keys, holding the results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;site_properties&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&#39;Stats require site_properties annotation.&#39;</span><span class="p">)</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span>   <span class="c"># makes little sense to use filtered graph</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># get stats for all nodes; note that compound equivalence</span>
        <span class="c"># sites in graph have replaced original sites</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span>
        <span class="n">nodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;bulk&#39;</span><span class="p">])</span>  <span class="c"># exclude bulk from stats</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>

        <span class="c">#------------------------------------------------------------</span>
        <span class="c"># Graph stats</span>
        <span class="c">#------------------------------------------------------------</span>
        <span class="c"># general stats including bulk</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_order&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">graph</span><span class="o">.</span><span class="n">order</span><span class="p">()</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_edges&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">number_of_edges</span><span class="p">()</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_degree&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">graph</span><span class="o">.</span><span class="n">number_of_edges</span><span class="p">()</span><span class="o">/</span><span class="n">graph</span><span class="o">.</span><span class="n">order</span><span class="p">()</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_degree_in&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_degree_out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_degree&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_degree_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_degree_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_degree_in_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">in_degree</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_degree_in_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">in_degree</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_degree_out_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">out_degree</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_degree_out_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">out_degree</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="c"># general stats excluding bulk and bulk --&gt; site edges</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_order_nobulk&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">graph</span><span class="o">.</span><span class="n">order</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_edges_nobulk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_edges&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">graph</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;bulk&#39;</span><span class="p">])</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_degree_nobulk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_edges_nobulk&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_order_nobulk&#39;</span><span class="p">]</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_degree_nobulk_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_degree_nobulk_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_degree_in_nobulk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">in_degree</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_degree_out_nobulk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">out_degree</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_degree_in_nobulk_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">in_degree</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_degree_out_nobulk_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">out_degree</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_degree_in_nobulk_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">in_degree</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_degree_out_nobulk_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">out_degree</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="n">internal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_sites</span><span class="p">()</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_internal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">internal</span><span class="p">)</span>     <span class="c"># includes isolated sites</span>
        <span class="n">isolated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isolated_sites</span><span class="p">()</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;G_isolated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">isolated</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;G_nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;G_degree&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>         <span class="c"># NX 1.x: returns a dict, to</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;G_degree_in&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">in_degree</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>   <span class="c"># keep consistent with old behaviour of hop</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;G_degree_out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">out_degree</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="c"># add flat lists to data with values()</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;G_internal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">internal</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;G_isolated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isolated</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c">#------------------------------------------------------------</span>
        <span class="c"># kinetics stats</span>
        <span class="c">#------------------------------------------------------------</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;lifetime_avg&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_site_times</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;occupancy_avg&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_site_occupancy</span><span class="p">()</span>
        <span class="c"># lifetime (!= residence time)</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;site_lifetime_avg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lifetime_avg</span><span class="p">[</span><span class="n">nodes</span><span class="p">])</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;site_lifetime_med&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lifetime_avg</span><span class="p">[</span><span class="n">nodes</span><span class="p">])</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;site_lifetime_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lifetime_avg</span><span class="p">[</span><span class="n">nodes</span><span class="p">])</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;site_lifetime_max&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lifetime_avg</span><span class="p">[</span><span class="n">nodes</span><span class="p">])</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;site_lifetime_min&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lifetime_avg</span><span class="p">[</span><span class="n">nodes</span><span class="p">])</span>
        <span class="c"># occupancy from life times</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;site_occupancy_kin_avg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">occupancy_avg</span><span class="p">[</span><span class="n">nodes</span><span class="p">])</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;site_occupancy_kin_med&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">occupancy_avg</span><span class="p">[</span><span class="n">nodes</span><span class="p">])</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;site_occupancy_kin_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">occupancy_avg</span><span class="p">[</span><span class="n">nodes</span><span class="p">])</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;site_occupancy_kin_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">occupancy_avg</span><span class="p">[</span><span class="n">nodes</span><span class="p">])</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;site_occupancy_kin_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">occupancy_avg</span><span class="p">[</span><span class="n">nodes</span><span class="p">])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;site_lifetime_avg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lifetime_avg</span><span class="p">[</span><span class="n">nodes</span><span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;site_lifetime_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lifetime_std</span><span class="p">[</span><span class="n">nodes</span><span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;site_occupancy_kin_avg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_avg</span><span class="p">[</span><span class="n">nodes</span><span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;site_occupancy_kin_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_std</span><span class="p">[</span><span class="n">nodes</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c">#------------------------------------------------------------</span>
        <span class="c"># density stats</span>
        <span class="c">#------------------------------------------------------------</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span><span class="p">[</span><span class="n">nodes</span><span class="p">]</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;site_volume_avg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;site_volume_med&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;site_volume_avg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;site_occupancy_rho_avg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">occupancy_avg</span><span class="p">)</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;site_occupancy_rho_med&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">occupancy_avg</span><span class="p">)</span>
        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;site_occupancy_rho_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">occupancy_avg</span><span class="p">)</span>

        <span class="c"># re-derive N_equivalence_sites and N_subsites from site_properties</span>
        <span class="c"># see hop.sitemap.stats</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">[</span><span class="s">&#39;site_N_equivalence_sites&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">equivalence_label</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">stats</span><span class="p">[</span><span class="s">&#39;site_N_subsites&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span><span class="o">.</span><span class="n">equivalence_site</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c"># site_properties not fully defined; should perhaps raise...</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;site_properties not complete: </span><span class="si">%s</span><span class="s"> misses equivalence site data&#39;</span> <span class="o">%</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(),</span>       <span class="c"># let&#39;s hope filename is set...</span>
                          <span class="n">category</span><span class="o">=</span><span class="n">hop</span><span class="o">.</span><span class="n">MissingDataWarning</span><span class="p">)</span>
            <span class="n">stats</span><span class="p">[</span><span class="s">&#39;site_N_equivalence_sites&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">stats</span><span class="p">[</span><span class="s">&#39;site_N_subsites&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;site_volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">volume</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;site_occupancy_rho_avg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">occupancy_avg</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c">#------------------------------------------------------------</span>
        <span class="c"># rates stats</span>
        <span class="c">#------------------------------------------------------------</span>
        <span class="c"># * collect all rates except bulk --&gt; x</span>
        <span class="c"># * sort fast and slow rates separately (2 exp) and single rates (exp)</span>
        <span class="c"># TODO</span>

        <span class="k">return</span> <span class="n">stats</span>
</div>
<div class="viewcode-block" id="HoppingGraph.internal_sites"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.internal_sites">[docs]</a>    <span class="k">def</span> <span class="nf">internal_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns list of sites that have no connection to the bulk.&quot;&quot;&quot;</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span>
        <span class="n">nodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;bulk&#39;</span><span class="p">])</span>  <span class="c"># exclude bulk from stats, not strictly necessary</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
        <span class="n">is_internal</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">is_internal</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">asiterable</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="n">is_internal</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="HoppingGraph.isolated_sites"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.isolated_sites">[docs]</a>    <span class="k">def</span> <span class="nf">isolated_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns list of sites that have no other connections.&quot;&quot;&quot;</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span>
        <span class="n">is_isolated</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">nodes</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">asiterable</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="n">is_isolated</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="HoppingGraph.is_connected"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.is_connected">[docs]</a>    <span class="k">def</span> <span class="nf">is_connected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if node n1 has any connection to the site n2.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">has_successor</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">has_predecessor</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span><span class="n">n1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="HoppingGraph.is_internal"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.is_internal">[docs]</a>    <span class="k">def</span> <span class="nf">is_internal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if site n has no connection to the bulk.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;bulk&#39;</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="HoppingGraph.is_isolated"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.is_isolated">[docs]</a>    <span class="k">def</span> <span class="nf">is_isolated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if site n has no connections to other sites (ie its degree equals 0).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="HoppingGraph.connectedness"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.connectedness">[docs]</a>    <span class="k">def</span> <span class="nf">connectedness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return values that measure connectedness (can be used in occupancy field)&quot;&quot;&quot;</span>
        <span class="c"># XXX: quick hack... should be table-driven</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_isolated</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">0.01</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_internal</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">0.5</span>
        <span class="k">return</span> <span class="mf">1.0</span>
</div>
<div class="viewcode-block" id="HoppingGraph.rates"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.rates">[docs]</a>    <span class="k">def</span> <span class="nf">rates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">use_filtered_graph</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns k_tot, k_in, k_out (and N_*) for site n (bulk rates omitted from k).</span>

<span class="sd">        dictionary = rates(n,use_filtered=True)</span>

<span class="sd">        k_in  = sum_j k_nj  (&gt; 0)     j&lt;&gt;bulk</span>
<span class="sd">        k_out = sum_j k_jn  (&lt; 0)     j&lt;&gt;bulk</span>
<span class="sd">        k_tot = k_in + k_out</span>

<span class="sd">        Note that k_tot should be ~0 if a bulk rate is included</span>
<span class="sd">        because the graph should obey detailed balance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_graph</span><span class="p">(</span><span class="n">use_filtered_graph</span><span class="o">=</span><span class="n">use_filtered_graph</span><span class="p">)</span>
        <span class="n">k_in</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">in_edges</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                             <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_from_bulk</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span> <span class="p">)</span>
        <span class="n">k_out</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">out_edges</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">)]</span> <span class="p">)</span>
        <span class="n">k_tot</span> <span class="o">=</span> <span class="n">k_in</span> <span class="o">+</span> <span class="n">k_out</span>
        <span class="n">N_in</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_hops</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">in_edges</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">)]</span> <span class="p">)</span>
        <span class="n">N_out</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_hops</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">out_edges</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">)]</span> <span class="p">)</span>
        <span class="n">N_tot</span> <span class="o">=</span> <span class="n">N_in</span> <span class="o">+</span> <span class="n">N_out</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;k_tot&#39;</span><span class="p">:</span><span class="n">k_tot</span><span class="p">,</span><span class="s">&#39;k_in&#39;</span><span class="p">:</span><span class="n">k_in</span><span class="p">,</span><span class="s">&#39;k_out&#39;</span><span class="p">:</span><span class="n">k_out</span><span class="p">,</span>
                <span class="s">&#39;N_tot&#39;</span><span class="p">:</span><span class="n">N_tot</span><span class="p">,</span><span class="s">&#39;N_in&#39;</span><span class="p">:</span><span class="n">N_in</span><span class="p">,</span><span class="s">&#39;N_out&#39;</span><span class="p">:</span><span class="n">N_out</span><span class="p">}</span>
</div>
<div class="viewcode-block" id="HoppingGraph.show_site"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.show_site">[docs]</a>    <span class="k">def</span> <span class="nf">show_site</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sites</span><span class="p">,</span><span class="n">use_filtered_graph</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Display data about sites (list of site labels or single site).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">iterable</span><span class="p">(</span><span class="n">sites</span><span class="p">):</span>
            <span class="n">sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">sites</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_show_site</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">use_filtered_graph</span><span class="o">=</span><span class="n">use_filtered_graph</span><span class="p">)</span>
            <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_show_site</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">site</span><span class="p">,</span><span class="n">use_filtered_graph</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Display data about a single site.&quot;&quot;&quot;</span>
        <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_graph</span><span class="p">(</span><span class="n">use_filtered_graph</span><span class="p">)</span>
        <span class="n">rule</span> <span class="o">=</span> <span class="s">&quot;-&quot;</span><span class="o">*</span><span class="mi">50</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;Statistics for site </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">site</span><span class="p">)</span>
        <span class="n">equivalence_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span><span class="o">.</span><span class="n">equivalence_name</span><span class="p">[</span><span class="n">site</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">equivalence_name</span><span class="p">:</span>
            <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot; (common site &#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span> <span class="n">equivalence_name</span><span class="p">)</span>
        <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_filtered_graph</span><span class="p">:</span>
            <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;(Filtered graph &#39;</span><span class="si">%s</span><span class="s">&#39;)</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">G</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span><span class="p">[</span><span class="n">site</span><span class="p">]</span>
        <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;  occupancy    = </span><span class="si">%g</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sp</span><span class="o">.</span><span class="n">occupancy_avg</span><span class="p">)</span>
        <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;  site volume  = </span><span class="si">%g</span><span class="s"> A^3</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sp</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>
        <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;  internal site = </span><span class="si">%s</span><span class="s">    isolated site = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_internal</span><span class="p">(</span><span class="n">site</span><span class="p">),</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">is_isolated</span><span class="p">(</span><span class="n">site</span><span class="p">)))</span>

        <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">rule</span><span class="p">)</span>
        <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%11s</span><span class="s"> </span><span class="si">%12s</span><span class="s">  1/ns  </span><span class="si">%3s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;hop&quot;</span><span class="p">,</span><span class="s">&quot;rate in&quot;</span><span class="p">,</span><span class="s">&quot;N&quot;</span><span class="p">))</span>
        <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">rule</span><span class="p">)</span>
        <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;In-edges:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">in_edges</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">show_edge</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;Out-edges:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">out_edges</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">show_edge</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;Total rates, excluding bulk rate k(</span><span class="si">%d</span><span class="s">--&gt;</span><span class="si">%d</span><span class="s">):</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;bulk&#39;</span><span class="p">],</span><span class="n">site</span><span class="p">))</span>
        <span class="n">rates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">(</span><span class="n">site</span><span class="p">,</span><span class="n">use_filtered_graph</span><span class="p">)</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%11s</span><span class="s"> </span><span class="si">%+12.1f</span><span class="s">  1/ns  </span><span class="si">%+4d</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">fmt</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;k_in&#39;</span><span class="p">,</span><span class="n">rates</span><span class="p">[</span><span class="s">&#39;k_in&#39;</span><span class="p">],</span><span class="n">rates</span><span class="p">[</span><span class="s">&#39;N_in&#39;</span><span class="p">]))</span>
        <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">fmt</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;k_out&#39;</span><span class="p">,</span><span class="n">rates</span><span class="p">[</span><span class="s">&#39;k_out&#39;</span><span class="p">],</span><span class="n">rates</span><span class="p">[</span><span class="s">&#39;N_out&#39;</span><span class="p">]))</span>
        <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">rule</span><span class="p">)</span>
        <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">fmt</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;k_tot&#39;</span><span class="p">,</span><span class="n">rates</span><span class="p">[</span><span class="s">&#39;k_tot&#39;</span><span class="p">],</span><span class="n">rates</span><span class="p">[</span><span class="s">&#39;N_tot&#39;</span><span class="p">]))</span>
        <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">rule</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">edge</span><span class="p">):</span>
        <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%3d</span><span class="s"> --&gt; </span><span class="si">%3d</span><span class="s"> </span><span class="si">%12.1f</span><span class="s">  1/ns  </span><span class="si">%3d</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">from_site</span><span class="p">(</span><span class="n">edge</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_site</span><span class="p">(</span><span class="n">edge</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">(</span><span class="n">edge</span><span class="p">),</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">number_of_hops</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span> <span class="p">))</span>

<div class="viewcode-block" id="HoppingGraph.show_total_rates"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.show_total_rates">[docs]</a>    <span class="k">def</span> <span class="nf">show_total_rates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">use_filtered_graph</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Display total rates for all nodes (excluding bulk --&gt; site contributions).&quot;&quot;&quot;</span>
        <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;Total flux in ns^-1 for each site (excluding bulk --&gt; site)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_filtered_graph</span><span class="p">:</span>
            <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;(Filtered graph &#39;</span><span class="si">%s</span><span class="s">&#39;)</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_graph</span><span class="p">(</span><span class="n">use_filtered_graph</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">site</span> <span class="o">==</span> <span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;bulk&#39;</span><span class="p">]:</span> <span class="k">continue</span>
            <span class="n">rates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">(</span><span class="n">site</span><span class="p">,</span><span class="n">use_filtered_graph</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rates</span><span class="p">[</span><span class="s">&#39;k_tot&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>   <span class="n">marker</span> <span class="o">=</span> <span class="s">&#39;*&#39;</span>
            <span class="k">else</span><span class="p">:</span>           <span class="n">marker</span> <span class="o">=</span> <span class="s">&#39; &#39;</span>
            <span class="n">rates</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;site&#39;</span><span class="p">:</span><span class="n">site</span><span class="p">,</span><span class="s">&#39;marker&#39;</span><span class="p">:</span><span class="n">marker</span><span class="p">})</span>
            <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%(site)2d</span><span class="s">  </span><span class="si">%(marker)s</span><span class="s"> k_tot=</span><span class="si">%(k_tot)+9.1f</span><span class="s">    k_in=</span><span class="si">%(k_in)9.1f</span><span class="s">   k_out=</span><span class="si">%(k_out)9.1f</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">rates</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="HoppingGraph.export"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.export">[docs]</a>    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="s">&#39;XGMML&#39;</span><span class="p">,</span><span class="n">use_filtered_graph</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">use_mapped_labels</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Export the graph to a graph format or an image.</span>

<span class="sd">        export(&#39;hopgraph&#39;,format=&#39;XGMML&#39;,use_filtered_graph=True)</span>

<span class="sd">        :Arguments:</span>

<span class="sd">        filename     name for the output files; appropriate suffixes are added</span>
<span class="sd">                     automatically</span>
<span class="sd">        format       output format: graphs (XGMML or DOT) or image  (png, jpg, ps, svg)</span>
<span class="sd">        use_filtered_graph</span>
<span class="sd">                     By default, the filtered graph (see the filter() method) is</span>
<span class="sd">                     plotted. If set to False then the original HoppingGraph is</span>
<span class="sd">                     used instead.</span>
<span class="sd">        use_mapped_labels</span>
<span class="sd">                     If site_properties is provided then each node that has been</span>
<span class="sd">                     identified to exist in a reference network is coloured black</span>
<span class="sd">                     and the mapped label is printed instead of the graph label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">__exporters</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;XGMML&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_export_xgmml</span><span class="p">,</span>
                       <span class="s">&#39;DOT&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_export_dot</span><span class="p">,</span>
                       <span class="s">&#39;ps&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_export_image</span><span class="p">,</span>
                       <span class="s">&#39;svg&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_export_image</span><span class="p">,</span>
                       <span class="s">&#39;png&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_export_image</span><span class="p">,</span>
                       <span class="s">&#39;jpg&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_export_image</span><span class="p">,</span>
                       <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">__exporters</span><span class="p">[</span><span class="n">format</span><span class="p">](</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span><span class="n">use_filtered_graph</span><span class="o">=</span><span class="n">use_filtered_graph</span><span class="p">,</span>
                                <span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">,</span><span class="n">use_mapped_labels</span><span class="o">=</span><span class="n">use_mapped_labels</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Format &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">format</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; not supported, choose one of &quot;</span><span class="o">+</span>
                             <span class="nb">str</span><span class="p">(</span><span class="n">__exporters</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

</div>
    <span class="k">def</span> <span class="nf">_export_dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">use_filtered_graph</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">use_mapped_labels</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">otherargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Export the graph as dot file.</span>

<span class="sd">        export(&#39;graph&#39;)</span>

<span class="sd">        :Arguments:</span>

<span class="sd">        filename     name for the output files; appropriate suffixes are added</span>
<span class="sd">                     automatically</span>
<span class="sd">        use_filtered_graph</span>
<span class="sd">                     By default, the filtered graph (see the filter() method) is</span>
<span class="sd">                     plotted. If set to False then the original HoppingGraph is</span>
<span class="sd">                     used instead.</span>
<span class="sd">        use_mapped_labels</span>
<span class="sd">                     If site_properties is provided then each node that has been</span>
<span class="sd">                     identified to exist in a reference network is coloured black</span>
<span class="sd">                     and the mapped label is printed instead of the graph label.</span>

<span class="sd">        The graph is only written to an image file if an image format</span>
<span class="sd">        is supplied. See</span>
<span class="sd">        https://networkx.lanl.gov/reference/pygraphviz/pygraphviz.agraph.AGraph-class.html#draw</span>
<span class="sd">        for possible output formats but png, jpg, ps are safe bets.</span>

<span class="sd">        See http://graphviz.org/doc/info/attrs.html for attributes.</span>

<span class="sd">        Note: On Mac OS X 10.3.9+fink the pygraphviz rendering is</span>
<span class="sd">        buggy and does not include node labels. Simply use the</span>
<span class="sd">        exported .dot file and use Mac OS X graphviz from</span>
<span class="sd">        http://www.pixelglow.com/graphviz/</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dotname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;dot&#39;</span><span class="p">)</span>       <span class="c"># load into graphviz</span>
        <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_AGraph</span><span class="p">(</span><span class="n">use_filtered_graph</span><span class="o">=</span><span class="n">use_filtered_graph</span><span class="p">,</span><span class="n">use_mapped_labels</span><span class="o">=</span><span class="n">use_mapped_labels</span><span class="p">)</span>
        <span class="n">G</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dotname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_export_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="s">&#39;png&#39;</span><span class="p">,</span><span class="n">use_filtered_graph</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">use_mapped_labels</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                      <span class="o">**</span><span class="n">otherargs</span><span class="p">):</span>
        <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_AGraph</span><span class="p">(</span><span class="n">use_filtered_graph</span><span class="o">=</span><span class="n">use_filtered_graph</span><span class="p">,</span><span class="n">use_mapped_labels</span><span class="o">=</span><span class="n">use_mapped_labels</span><span class="p">)</span>
        <span class="n">gfxname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">format</span><span class="p">)</span>
        <span class="n">G</span><span class="o">.</span><span class="n">layout</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="n">otherargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;layouter&#39;</span><span class="p">,</span> <span class="s">&#39;dot&#39;</span><span class="p">))</span>
        <span class="n">G</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">gfxname</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">)</span>  <span class="c"># buggy on Mac OS X</span>

    <span class="k">def</span> <span class="nf">_make_AGraph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">use_filtered_graph</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">use_mapped_labels</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns AGraph (&#39;attributed graph&#39;) of the filtered or current graph.&quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">pygraphviz</span>

        <span class="k">if</span> <span class="n">use_mapped_labels</span> <span class="ow">and</span> \
           <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;site_properties&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&#39;Mapped site labels require site_properties annotation.&#39;</span><span class="p">)</span>

        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_graph</span><span class="p">(</span><span class="n">use_filtered_graph</span><span class="p">)</span>

        <span class="n">G</span> <span class="o">=</span> <span class="n">pygraphviz</span><span class="o">.</span><span class="n">AGraph</span><span class="p">(</span><span class="n">directed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">edges_iter</span><span class="p">())</span> <span class="c"># n1 n2</span>

        <span class="c"># attributes: http://www.graphviz.org/doc/info/attrs.html</span>
        <span class="c"># colors: http://www.graphviz.org/doc/info/colors.html</span>
        <span class="n">G</span><span class="o">.</span><span class="n">graph_attr</span><span class="p">[</span><span class="s">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#39;, k in 1/ns (N)&#39;</span>
        <span class="n">G</span><span class="o">.</span><span class="n">graph_attr</span><span class="p">[</span><span class="s">&#39;splines&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;true&#39;</span>
        <span class="n">G</span><span class="o">.</span><span class="n">graph_attr</span><span class="p">[</span><span class="s">&#39;fontcolor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;black&#39;</span>
        <span class="n">G</span><span class="o">.</span><span class="n">node_attr</span><span class="p">[</span><span class="s">&#39;fontcolor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;white&#39;</span>
        <span class="n">G</span><span class="o">.</span><span class="n">node_attr</span><span class="p">[</span><span class="s">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;black&#39;</span>
        <span class="n">G</span><span class="o">.</span><span class="n">node_attr</span><span class="p">[</span><span class="s">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;circle&#39;</span>
        <span class="n">G</span><span class="o">.</span><span class="n">node_attr</span><span class="p">[</span><span class="s">&#39;fillcolor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;gray76&#39;</span>    <span class="c"># middle gray</span>
        <span class="n">G</span><span class="o">.</span><span class="n">node_attr</span><span class="p">[</span><span class="s">&#39;style&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;filled&#39;</span>
        <span class="n">G</span><span class="o">.</span><span class="n">edge_attr</span><span class="p">[</span><span class="s">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;gray36&#39;</span>        <span class="c"># darker gray</span>
        <span class="n">G</span><span class="o">.</span><span class="n">edge_attr</span><span class="p">[</span><span class="s">&#39;dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;forward&#39;</span>

        <span class="c"># attach k_ji to edge (printed in 1/ns), number of transitions in ()</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>    <span class="c"># TODO: NX 1.x : do we need data=True here?</span>
            <span class="n">u</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">e</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>        <span class="c"># need nodes as integers</span>
            <span class="n">k</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">fit</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s">&#39;k&#39;</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s">&#39;N&#39;</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s">&#39;fit&#39;</span><span class="p">]</span>   <span class="c"># extract k from HoppingGraph</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fit</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>         <span class="c"># get two rates if double exp</span>
                <span class="n">a</span><span class="p">,</span><span class="n">k1</span><span class="p">,</span><span class="n">k2</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">parameters</span>
                <span class="n">kns</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="n">k1</span><span class="p">,</span><span class="n">k2</span><span class="p">])</span> <span class="c"># rate in 1/ns</span>
                <span class="n">k_dominant</span> <span class="o">=</span> <span class="n">kns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>              <span class="c"># only display fastest rate</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">k_dominant</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="n">k</span>              <span class="c"># rate in 1/ns</span>
            <span class="n">k_legend</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(k_dominant).1f</span><span class="s"> (</span><span class="si">%(N)d</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="nb">locals</span><span class="p">()</span>
            <span class="n">e</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s">&#39;headlabel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k_legend</span>
            <span class="k">if</span> <span class="n">use_mapped_labels</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">:</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">mapped_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span><span class="o">.</span><span class="n">equivalence_name</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">mapped_label</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_label</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s">&#39;fillcolor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;red&#39;</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s">&#39;fontcolor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;white&#39;</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">pass</span>
        <span class="k">return</span> <span class="n">G</span>


    <span class="k">def</span> <span class="nf">_export_xgmml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">use_filtered_graph</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="o">**</span><span class="n">otherargs</span><span class="p">):</span>
        <span class="c"># quick hack</span>
        <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_graph</span><span class="p">(</span><span class="n">use_filtered_graph</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;xgmml&#39;</span><span class="p">)</span>
        <span class="n">xattr</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span><span class="s">&#39;HoppingGraph&#39;</span><span class="p">,</span> <span class="s">&#39;label&#39;</span><span class="p">:</span><span class="n">G</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;description&#39;</span><span class="p">:</span><span class="n">G</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                 <span class="s">&#39;softwareVersion&#39;</span><span class="p">:</span> <span class="s">&quot;$Id$&quot;</span><span class="p">,</span>
                 <span class="p">}</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
                  <span class="sd">&quot;&quot;&quot;&lt;!DOCTYPE graph PUBLIC &quot;-//John Punin//DTD graph description//EN&quot; &quot;http://www.cs.rpi.edu/~puninj/XGMML/xgmml.dtd&quot;&gt;\n&quot;&quot;&quot;</span>
                  <span class="sd">&quot;&quot;&quot;&lt;graph label=&quot;%(label)s&quot; directed=&quot;1&quot; id=&quot;%(id)s&quot; &quot;&quot;&quot;</span>
                  <span class="sd">&quot;&quot;&quot;xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; &quot;&quot;&quot;</span>
                  <span class="sd">&quot;&quot;&quot;xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot; &quot;&quot;&quot;</span>
                  <span class="sd">&quot;&quot;&quot;xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot; &quot;&quot;&quot;</span>
                  <span class="sd">&quot;&quot;&quot;xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot; &quot;&quot;&quot;</span>
                  <span class="sd">&quot;&quot;&quot;xmlns=&quot;http://www.cs.rpi.edu/XGMML&quot; &quot;&quot;&quot;</span>
                  <span class="sd">&quot;&quot;&quot;Vendor=&quot;hop.graph.HoppingGraph._export_xgmml&quot;&gt;\n&quot;&quot;&quot;</span>
                  <span class="sd">&quot;&quot;&quot;\t&lt;att name=&quot;documentVersion&quot; value=&quot;1.0&quot;/&gt;\n&quot;&quot;&quot;</span>
                  <span class="sd">&quot;&quot;&quot;\t&lt;att name=&quot;softwareVersion&quot; value=&quot;%(softwareVersion)s&quot;/&gt;\n&quot;&quot;&quot;</span>
                  <span class="sd">&quot;&quot;&quot;\t&lt;att name=&quot;description&quot; value=&quot;=%(description)s&quot;/&gt;\n&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">xattr</span><span class="p">)</span>

        <span class="c"># distance of site center from geometrical center</span>
        <span class="c"># (a bit hackish so that we only include real sites)</span>
        <span class="n">sitecenters</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span><span class="o">.</span><span class="n">center</span><span class="p">[</span><span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;bulk&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:]])</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sitecenters</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cdist</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">sitecenters</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="c"># add back interstitial and bulk so that site label directly indexes into cdist</span>
        <span class="n">centerdistance</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">([</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;bulk&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">cdist</span><span class="p">)</span> <span class="p">)</span>
        <span class="c"># del cdist, center, sitecenters</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
            <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">site</span> <span class="o">=</span> <span class="n">k</span>
            <span class="n">xattr</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span><span class="n">site</span><span class="p">,</span><span class="s">&#39;label&#39;</span><span class="p">:</span><span class="n">label</span><span class="p">,</span>
                     <span class="s">&#39;equivalence_label&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span><span class="o">.</span><span class="n">equivalence_name</span><span class="p">[</span><span class="n">site</span><span class="p">],</span>
                     <span class="s">&#39;volume&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span><span class="o">.</span><span class="n">volume</span><span class="p">[</span><span class="n">site</span><span class="p">],</span>
                     <span class="s">&#39;occupancy_avg&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span><span class="o">.</span><span class="n">occupancy_avg</span><span class="p">[</span><span class="n">site</span><span class="p">],</span>
                     <span class="s">&#39;distance&#39;</span><span class="p">:</span><span class="n">centerdistance</span><span class="p">[</span><span class="n">site</span><span class="p">],</span>
                     <span class="s">&#39;has_bulkconnection&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span><span class="p">(</span><span class="n">site</span><span class="p">,</span><span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;bulk&#39;</span><span class="p">]),</span>
                     <span class="p">}</span>
            <span class="k">if</span> <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;equivalence_label&#39;</span><span class="p">]:</span>
                <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t</span><span class="s">&lt;node id=&quot;</span><span class="si">%(id)d</span><span class="s">&quot; label=&quot;</span><span class="si">%(label)s</span><span class="s">/</span><span class="si">%(equivalence_label)s</span><span class="s">&quot;&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">xattr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t</span><span class="s">&lt;node id=&quot;</span><span class="si">%(id)d</span><span class="s">&quot; label=&quot;</span><span class="si">%(label)s</span><span class="s">&quot;&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">xattr</span><span class="p">)</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t</span><span class="s">&lt;att type=&quot;real&quot; name=&quot;volume&quot; value=&quot;</span><span class="si">%(volume)g</span><span class="s">&quot;/&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">xattr</span><span class="p">)</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t</span><span class="s">&lt;att type=&quot;real&quot; name=&quot;occupancy&quot; value=&quot;</span><span class="si">%(occupancy_avg)g</span><span class="s">&quot;/&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">xattr</span><span class="p">)</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t</span><span class="s">&lt;att type=&quot;real&quot; name=&quot;distance&quot; value=&quot;</span><span class="si">%(distance)g</span><span class="s">&quot;/&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>  <span class="o">%</span> <span class="n">xattr</span><span class="p">)</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t</span><span class="s">&lt;att type=&quot;integer&quot; name=&quot;has_bulkconnection&quot; value=&quot;</span><span class="si">%(has_bulkconnection)d</span><span class="s">&quot;/&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">xattr</span><span class="p">)</span>
            <span class="c">### xml.write(&quot;&quot;&quot;\t\t&lt;att type=&quot;&quot; name=&quot;&quot; value=&quot;&quot;/&gt;\n&quot;&quot;&quot;)</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t</span><span class="s">&lt;/node&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">u</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_site</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_site</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>   <span class="c"># === u,v = e[:2]</span>
            <span class="n">xattr</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;u&#39;</span><span class="p">:</span><span class="n">u</span><span class="p">,</span><span class="s">&#39;v&#39;</span><span class="p">:</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;label&#39;</span><span class="p">:</span><span class="s">&quot;</span><span class="si">%d</span><span class="s"> -&gt; </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">),</span><span class="s">&#39;id&#39;</span><span class="p">:</span><span class="s">&quot;</span><span class="si">%d</span><span class="s"> -&gt; </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">)}</span>
            <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_hops</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t</span><span class="s">&lt;edge source=&quot;</span><span class="si">%(u)d</span><span class="s">&quot; target=&quot;</span><span class="si">%(v)d</span><span class="s">&quot; label=&quot;</span><span class="si">%(label)s</span><span class="s">&quot;&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">xattr</span><span class="p">)</span>
<span class="c">##                      &quot;&quot;&quot;label=&quot;%(label)s&quot; id=&quot;%(id)s&quot;&gt;\n&quot;&quot;&quot; % xattr)</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t</span><span class="s">&lt;att type=&quot;string&quot; name=&quot;EDGE_TYPE&quot; value=&quot;DirectedEdge&quot;/&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t</span><span class="s">&lt;att type=&quot;string&quot; name=&quot;interaction&quot; value=&quot;DirectedEdge&quot;/&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t</span><span class="s">&lt;att type=&quot;integer&quot; name=&quot;N&quot; value=&quot;</span><span class="si">%(N)d</span><span class="s">&quot;/&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">xattr</span><span class="p">)</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t</span><span class="s">&lt;att type=&quot;real&quot; name=&quot;rate&quot; value=&quot;</span><span class="si">%(rate)f</span><span class="s">&quot;/&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">xattr</span><span class="p">)</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t</span><span class="s">&lt;/edge&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;&lt;/graph&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<div class="viewcode-block" id="HoppingGraph.export3D"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.export3D">[docs]</a>    <span class="k">def</span> <span class="nf">export3D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">density</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">use_filtered_graph</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Export pdb and psf file for visualization in 3D.</span>

<span class="sd">        &gt;&gt;&gt; h.export3D()</span>
<span class="sd">        Uses h.site_properties if it exists.</span>

<span class="sd">        &gt;&gt;&gt; h.export3D(density)</span>
<span class="sd">        Uses a (hopefully matching) Density object to pull in site_properties.</span>


<span class="sd">        :Arguments:</span>
<span class="sd">        density      hop.sitemap.Density with full site_properties</span>
<span class="sd">        filename     prefix for output files: &lt;filename&gt;.psf and &lt;filename&gt;.pdb</span>
<span class="sd">        use_filtered_graph</span>
<span class="sd">                     define a filtered graph with h.filter() first</span>

<span class="sd">        The method writes a psf and a pdb file from the graph, suitable</span>
<span class="sd">        for visualization in, for instance, VMD.</span>

<span class="sd">        Sites are represented as residues of resname &#39;NOD&#39;; each site</span>
<span class="sd">        is marked by one &#39;ATOM&#39; (of type CA) at the center of geometry</span>
<span class="sd">        of the site. Edges are bonds between those pseudo atoms.</span>

<span class="sd">        #Currently: B-factor 1 if common site label exist, 0 otherwis</span>
<span class="sd">        #           occupancy: avg site occupancy</span>
<span class="sd">        # (but this should become customizable)</span>

<span class="sd">        One should use a filtered graph with the bulk site removed for</span>
<span class="sd">        visualization.</span>

<span class="sd">        Bugs:</span>
<span class="sd">        * with a filtered graph, the degree is the one of the filtered</span>
<span class="sd">          graph and not of the real underlying graph</span>
<span class="sd">        * cannot yet select what to display in B-factor and occupancy field:</span>
<span class="sd">          choose from: [&#39;identity&#39;,&#39;occupancy&#39;,&#39;degree&#39;,&#39;volume&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">density</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;site_properties&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&#39;Requires site_properties or a Density instance.&#39;</span><span class="p">)</span>
            <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">props</span> <span class="o">=</span> <span class="n">density</span><span class="o">.</span><span class="n">site_properties</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;density must be a hop.sitemap.Density instance&#39;</span><span class="p">)</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_graph</span><span class="p">(</span><span class="n">use_filtered_graph</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write_psf</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span><span class="n">props</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>        <span class="c"># atoms are numbered consecutively...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_pdb</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span><span class="n">props</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>  <span class="c"># ..and residues correspond to sites</span>
</div>
    <span class="k">def</span> <span class="nf">write_pdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">graph</span><span class="p">,</span><span class="n">props</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">Bio.PDB</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">Bio</span><span class="o">.</span><span class="n">PDB</span><span class="o">.</span><span class="n">StructureBuilder</span><span class="o">.</span><span class="n">StructureBuilder</span><span class="p">()</span>
        <span class="n">B</span><span class="o">.</span><span class="n">init_structure</span><span class="p">(</span><span class="s">&#39;graph&#39;</span><span class="p">)</span>
        <span class="n">B</span><span class="o">.</span><span class="n">init_model</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">B</span><span class="o">.</span><span class="n">init_seg</span><span class="p">(</span><span class="s">&#39;GRPH&#39;</span><span class="p">)</span>
        <span class="n">B</span><span class="o">.</span><span class="n">init_chain</span><span class="p">(</span><span class="s">&#39;A&#39;</span><span class="p">)</span>
        <span class="c"># note that empty fields MUST be written as a blank &#39; &#39; (ie a single space)</span>
        <span class="c"># or they are interpreted as altLoc specifiers named &#39;&#39; (weird...)</span>
        <span class="c"># ATOM numbering is done consecutively here and in write_psf() and</span>
        <span class="c"># there is only a single atom per residue.</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">:</span>   <span class="c"># node is the label==resid and it must be an integer</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">center</span>
            <span class="n">vol</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">volume</span>
            <span class="n">occ</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">occupancy_avg</span>
            <span class="n">degree</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>           <span class="c">## TODO w/filtered (may be off by 1)</span>
            <span class="c"># write common atoms as N, different as CA (HACK...)</span>
            <span class="n">commonlabel</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">equivalence_name</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">commonlabel</span><span class="p">:</span>
                <span class="n">identity</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">aname</span> <span class="o">=</span> <span class="s">&#39;N&#39;</span>
                <span class="n">atype</span> <span class="o">=</span> <span class="s">&#39;N&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">identity</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">aname</span> <span class="o">=</span> <span class="s">&#39;CA&#39;</span>       <span class="c"># choose the same identifiers as in pdb</span>
                <span class="n">atype</span> <span class="o">=</span> <span class="s">&#39;CA&#39;</span>       <span class="c"># choose the same identifiers as in pdb</span>
            <span class="n">pdb_occupancy</span> <span class="o">=</span> <span class="n">occ</span>     <span class="c"># should be able to choose from volume, occupancy, degree, identity</span>
            <span class="c"># connectedness: 1: standard site, 0.5: internal (no bulk), 0.01: isolated</span>
            <span class="c"># (should do this as separate residues)</span>
            <span class="n">pdb_beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connectedness</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="n">B</span><span class="o">.</span><span class="n">init_residue</span><span class="p">(</span><span class="s">&#39;NOD&#39;</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="n">node</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">)</span> <span class="c"># choose same identifiers as in write_psf</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">B</span><span class="o">.</span><span class="n">init_atom</span><span class="p">(</span><span class="n">aname</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">pdb_beta</span><span class="p">,</span><span class="n">pdb_occupancy</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="n">atype</span><span class="p">,</span> <span class="n">element</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c"># newer version of Biopython ?</span>
                <span class="n">B</span><span class="o">.</span><span class="n">init_atom</span><span class="p">(</span><span class="n">aname</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">pdb_beta</span><span class="p">,</span><span class="n">pdb_occupancy</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="n">atype</span><span class="p">)</span>
        <span class="n">io</span><span class="o">=</span><span class="n">Bio</span><span class="o">.</span><span class="n">PDB</span><span class="o">.</span><span class="n">PDBIO</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">get_structure</span><span class="p">()</span>
        <span class="n">io</span><span class="o">.</span><span class="n">set_structure</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">pdbfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;pdb&#39;</span><span class="p">)</span>
        <span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">)</span>

<div class="viewcode-block" id="HoppingGraph.write_psf"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.write_psf">[docs]</a>    <span class="k">def</span> <span class="nf">write_psf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">graph</span><span class="p">,</span><span class="n">props</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pseudo psf with nodes as atoms and edges as bonds&quot;&quot;&quot;</span>
        <span class="c"># Standard no CHEQ format for a Charmm PSF file:</span>
        <span class="n">psf_ATOM_format</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%(iatom)8d</span><span class="s"> </span><span class="si">%(segid)4s</span><span class="s"> </span><span class="si">%(resid)-4d</span><span class="s"> </span><span class="si">%(resname)4s</span><span class="s"> &#39;</span><span class="o">+</span>\
                          <span class="s">&#39;</span><span class="si">%(name)-4s</span><span class="s"> </span><span class="si">%(type)4s</span><span class="s"> </span><span class="si">%(charge)-14.6f%(mass)-14.4f%(imove)8d</span><span class="se">\n</span><span class="s">&#39;</span>

        <span class="n">psffilename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;psf&#39;</span><span class="p">)</span>
        <span class="n">psf</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">psffilename</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">psf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;PSF</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">psf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%7d</span><span class="s"> !NTITLE</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">psf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;* Graph topology written by</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span>\
                  <span class="s">&#39;* $Id$</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">psf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="c"># ATOMS</span>
        <span class="n">psf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%6d</span><span class="s"> !NATOM</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">graph</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">())</span>
        <span class="n">segid</span> <span class="o">=</span> <span class="s">&#39;GRPH&#39;</span>     <span class="c"># choose the same identifiers as in pdb</span>
        <span class="n">resname</span> <span class="o">=</span> <span class="s">&#39;NOD&#39;</span>    <span class="c"># choose the same identifiers as in pdb</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">imove</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c"># no fixed &#39;atoms&#39;</span>
        <span class="n">node2iatom</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c"># needed for BONDS</span>
        <span class="k">for</span> <span class="n">iatom</span><span class="p">,</span><span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes_iter</span><span class="p">()):</span>
            <span class="c"># atom numbering starts at 1, so iatom+1</span>
            <span class="n">iatom</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">node2iatom</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">iatom</span>
            <span class="c"># write common atoms as N, different as CA (HACK...)</span>
            <span class="n">commonlabel</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">equivalence_name</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">commonlabel</span><span class="p">:</span>
                <span class="n">identity</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">aname</span> <span class="o">=</span> <span class="s">&#39;N&#39;</span>
                <span class="n">atype</span> <span class="o">=</span> <span class="s">&#39;N&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">identity</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">aname</span> <span class="o">=</span> <span class="s">&#39;CA&#39;</span>       <span class="c"># choose the same identifiers as in pdb</span>
                <span class="n">atype</span> <span class="o">=</span> <span class="s">&#39;CA&#39;</span>       <span class="c"># choose the same identifiers as in pdb</span>
            <span class="n">psf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">psf_ATOM_format</span> <span class="o">%</span>
                      <span class="p">{</span><span class="s">&#39;iatom&#39;</span><span class="p">:</span><span class="n">iatom</span><span class="p">,</span> <span class="s">&#39;segid&#39;</span><span class="p">:</span><span class="n">segid</span><span class="p">,</span> <span class="s">&#39;resid&#39;</span><span class="p">:</span><span class="n">node</span><span class="p">,</span>
                       <span class="s">&#39;resname&#39;</span><span class="p">:</span><span class="n">resname</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span><span class="n">aname</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">:</span><span class="n">atype</span><span class="p">,</span>
                       <span class="s">&#39;charge&#39;</span><span class="p">:</span><span class="n">charge</span><span class="p">,</span> <span class="s">&#39;mass&#39;</span><span class="p">:</span><span class="n">mass</span><span class="p">,</span><span class="s">&#39;imove&#39;</span><span class="p">:</span><span class="n">imove</span><span class="p">}</span> <span class="p">)</span>
        <span class="c"># BONDS: fortran fmt03=&#39;(8I8)&#39;</span>
        <span class="c"># (note: write directed bonds and one atom per residue/node)</span>
        <span class="n">psf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%6d</span><span class="s"> !NBOND: bonds</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">graph</span><span class="o">.</span><span class="n">number_of_edges</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">edges_iter</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">)):</span>
            <span class="n">psf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%8i%8i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node2iatom</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">node2iatom</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">psf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">psf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="c"># ignore all the other sections (don&#39;t make sense anyway)</span>
        <span class="n">psf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="HoppingGraph.select_graph"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.HoppingGraph.select_graph">[docs]</a>    <span class="k">def</span> <span class="nf">select_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">use_filtered_graph</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns filtered graph for True argument, or the raw graph otherwise)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">use_filtered_graph</span><span class="p">:</span>
            <span class="c"># Is there a filtered graph we should be using?</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_graph</span>
                <span class="n">graph</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;No filtered graph defined; create one with </span><span class="si">%s</span><span class="s">.filter().&#39;</span> <span class="o">%</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span>
        <span class="k">return</span> <span class="n">graph</span>
</div>
    <span class="k">def</span> <span class="nf">_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">taus</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&#39;survivalfunction&#39;</span><span class="p">,</span><span class="n">block_w</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the rate i--&gt; j, k_ji, from the hopping times tau_ji.</span>

<span class="sd">        :Returns: dict(kij=*kji*, N=*N*, fit=*fit*)</span>

<span class="sd">                  - *kji* : rate constant in 1/ps</span>
<span class="sd">                  - *N* : number of events</span>
<span class="sd">                  - *fit* : instance of :class:`fit_func`</span>

<span class="sd">        :Arguments:</span>
<span class="sd">            *taus*</span>
<span class="sd">                array of all waiting times</span>
<span class="sd">            *method*</span>
<span class="sd">               &#39;survivalfunction&#39;</span>
<span class="sd">                    compute as a fit of a*exp(-k1*t)+(1-a)*exp(-k2*t) or exp(-k*t)</span>
<span class="sd">                    to the survival function S(t); the double exp is tried first</span>
<span class="sd">                    and then decided heuristically if a single exp is a better choice.</span>
<span class="sd">                    Heuristics: Use single exp if</span>

<span class="sd">                    * number of data points is &lt;= 10</span>
<span class="sd">                    * double exp asymmetry abs(0.5-a) &gt; 0.49</span>
<span class="sd">                    * k1&lt;0 or k2&lt;0</span>

<span class="sd">        :Bugs:</span>
<span class="sd">          - Does not switch to single exponential if double exponential fit fails</span>
<span class="sd">            to converge.</span>

<span class="sd">        .. Notes:: Should probably use the integral of the double-exponential fit as an</span>
<span class="sd">          approximation for the rate constant instead of just using the slower</span>
<span class="sd">          one (G. Hummer, pers. comm.)</span>

<span class="sd">        :TODO: Implement k from integral as new method &#39;integral&#39; and also</span>
<span class="sd">               compare to the calculation from the exponential fits::</span>

<span class="sd">                single exp:</span>
<span class="sd">                        f(t) = exp(-kt)</span>
<span class="sd">                        k = [integral_0^\infty dt f(t)] ^ -1 = k</span>

<span class="sd">                double exponential:</span>
<span class="sd">                        f(t) = a exp(-k1 t) + (1-a) exp(-k2 t)</span>
<span class="sd">                        k_comb =  [integral_0^\infty dt f(t)] ^ -1 = [a/k1 + (1-a)/k2]^-1</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="s">&#39;survivalfunction&#39;</span><span class="p">:</span>
            <span class="c"># TODO: use time step for sampling step ?</span>
            <span class="c"># TODO: coarser dt for long runs, eg dt = 10 ... 100!!</span>
            <span class="c">#       This can blow up in memory in survivalfunction() because of too many t (len(x) big!)</span>
            <span class="c">#       or use an interpolated survival function</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="mf">1.0</span>                                 <span class="c"># 1.0 == dt in sim  # TODO: adapt dt</span>
            <span class="n">tmax</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">taus</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">dt</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">taus</span><span class="p">)</span>                            <span class="c"># perhaps sample N times from S ???</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dt</span><span class="p">)</span>            <span class="c"># ... just do lin mesh</span>
            <span class="n">S</span> <span class="o">=</span> <span class="n">survivalfunction</span><span class="p">(</span><span class="n">taus</span><span class="p">,</span><span class="n">block_w</span><span class="o">=</span><span class="n">block_w</span><span class="p">)</span>
            <span class="n">enough_data</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">taus</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">is_single_exp</span> <span class="o">=</span> <span class="bp">False</span>                    <span class="c"># try double exp first</span>
            <span class="k">if</span> <span class="n">enough_data</span><span class="p">:</span>                          <span class="c"># only attempt exp2 with &gt;10 data points</span>
                <span class="n">fit</span> <span class="o">=</span> <span class="n">fitExp2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>                <span class="c"># a*exp(-k1*x) + (1-a)*exp(-k2*x)</span>
                <span class="n">a</span><span class="p">,</span><span class="n">k1</span><span class="p">,</span><span class="n">k2</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">parameters</span>
                <span class="c"># heuristics to decide if double exp fit is good</span>
                <span class="n">is_single_exp</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.49</span>  <span class="c">#=0.5 - 0.01  # very asymmetric fit</span>
                <span class="n">all_k</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">k1</span><span class="p">,</span><span class="n">k2</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">all_k</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>             <span class="c"># at least one k&lt;0: no sum of exp</span>
                    <span class="n">is_single_exp</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">all_k</span><span class="p">[</span><span class="n">all_k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>       <span class="c"># select dominant (fast) rate</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">enough_data</span> <span class="ow">or</span> <span class="n">is_single_exp</span><span class="p">:</span>
                <span class="n">fit</span> <span class="o">=</span> <span class="n">fitExp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>                 <span class="c"># exp(-k*x)</span>
                <span class="n">k</span><span class="p">,</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">parameters</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">NotImplemented</span><span class="p">(</span><span class="s">&#39;Method &quot;</span><span class="si">%s</span><span class="s">&quot; is not implemented.&#39;</span> <span class="o">%</span> <span class="n">method</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="n">fit</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CombinedGraph"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.CombinedGraph">[docs]</a><span class="k">class</span> <span class="nc">CombinedGraph</span><span class="p">(</span><span class="n">HoppingGraph</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Hybrid graph between hop graphs that share common nodes.&quot;&quot;&quot;</span>
    <span class="n">_export_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;XGMML&#39;</span><span class="p">,</span><span class="s">&#39;dot&#39;</span><span class="p">]</span>     <span class="c"># graph formats in export()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">g0</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">g1</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">g0</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">g1</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">g0</span><span class="p">,</span><span class="n">HoppingGraph</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">g1</span><span class="p">,</span><span class="n">HoppingGraph</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;g0 and g1 must be &lt;hop.graph.HoppingGraph&gt;s.&quot;</span><span class="p">)</span>
            <span class="c"># build combined graph</span>
            <span class="c"># 1) add nodes to new graph. Use site_properties.equivalence_name or &#39;1.LABEL&#39;, &#39;2.LABEL&#39;</span>
            <span class="c">#    --&gt; make a dict for label --&gt; combined graph label</span>
            <span class="c"># 2) add edges (allow multiple edges) and mark up edge</span>
            <span class="c">#    (can I do multiple parallel edges with pygraphviz ??)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">filename</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">NX</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Hybrid graph&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span> <span class="o">=</span> <span class="p">[</span><span class="n">g0</span><span class="p">,</span><span class="n">g1</span><span class="p">]</span>  <span class="c"># all graphs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">g_labels</span> <span class="o">=</span> <span class="bp">None</span>   <span class="c"># shape = (2,size of combined graph), one col per graph</span>
                          <span class="c"># g_labels[igraph,combined_label] --&gt; original label in igraph</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node_properties</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># will become a numpy.recarray</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edge_properties</span> <span class="o">=</span> <span class="p">{}</span>   <span class="c"># indexed by (u,v) = dict(common=common?, plist=[p0, p1])</span>

            <span class="c"># fix: bulk sites should be common, too:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">site_properties</span><span class="o">.</span><span class="n">equivalence_name</span><span class="p">[</span><span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;bulk&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="s">&#39;bulk&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">site_properties</span><span class="o">.</span><span class="n">equivalence_name</span><span class="p">[</span><span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;bulk&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="s">&#39;bulk&#39;</span>

            <span class="c"># fix: in rare circumstances, an outlier (-1) hop (1,-1) or (-1,1) is recorded</span>
            <span class="c"># so we prune the outlier node --- TODO: check trajectory _coord2hop !!</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;outlier&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="n">NX</span><span class="o">.</span><span class="n">NetworkXError</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="c"># Set up temporary list to build arrays, start with interstitial at pos = 0</span>
            <span class="c"># tmp list for graph labels with (g0_label, g1_label) for each new label:</span>
            <span class="n">g_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">None</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">))]</span>
            <span class="c"># temp list to build recarray: new label, descr, common?, graphmask</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="p">[(</span><span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;interstitial&#39;</span><span class="p">],</span><span class="s">&#39;interstitial&#39;</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="mi">0</span><span class="p">)]</span>
            <span class="n">ICOMLABL</span> <span class="o">=</span> <span class="mi">1</span>               <span class="c"># index for common label in properties at pos 1</span>
            <span class="n">ICOMMON</span> <span class="o">=</span> <span class="mi">2</span>                <span class="c"># True if common to all graphs, False otherwise</span>
            <span class="n">IGRAPHS</span> <span class="o">=</span> <span class="mi">3</span>                <span class="c"># bit field (mask) containing graph numbers as sum 2**igraph</span>
            <span class="n">commonlabel2newnode</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c"># helper for finding common sites</span>
            <span class="n">inode</span> <span class="o">=</span> <span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;bulk&#39;</span><span class="p">]</span>     <span class="c"># new node labels for hybrid graph start at &#39;bulk&#39;</span>
            <span class="k">for</span> <span class="n">ig</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">):</span>
                <span class="n">node2commonlabel</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">site_properties</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                                            <span class="n">g</span><span class="o">.</span><span class="n">site_properties</span><span class="o">.</span><span class="n">equivalence_name</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">graph</span><span class="p">:</span>
                    <span class="n">commonlabel</span> <span class="o">=</span> <span class="n">node2commonlabel</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">newnode</span> <span class="o">=</span> <span class="n">inode</span>
                    <span class="n">inode</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">commonlabel</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">commonlabel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">commonlabel2newnode</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">newnode</span><span class="p">)</span>
                            <span class="n">commonlabel2newnode</span><span class="p">[</span><span class="n">commonlabel</span><span class="p">]</span> <span class="o">=</span> <span class="n">newnode</span>  <span class="c"># remember common site&#39;s inode</span>
                        <span class="k">else</span><span class="p">:</span>
                           <span class="n">newnode</span> <span class="o">=</span> <span class="n">commonlabel2newnode</span><span class="p">[</span><span class="n">commonlabel</span><span class="p">]</span>
                           <span class="n">inode</span> <span class="o">-=</span> <span class="mi">1</span>  <span class="c"># after all, don&#39;t need a new node</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">properties</span><span class="p">[</span><span class="n">newnode</span><span class="p">]</span> <span class="c"># build properties[] in parallel with g_labels[]</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="n">properties</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">newnode</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>   <span class="c"># basic record: node,com.label,common?,g</span>
                        <span class="n">g_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">None</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">)))</span>
                    <span class="n">g_labels</span><span class="p">[</span><span class="n">newnode</span><span class="p">][</span><span class="n">ig</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>  <span class="c"># lookup for node in graph ig</span>
                    <span class="n">properties</span><span class="p">[</span><span class="n">newnode</span><span class="p">][</span><span class="n">ICOMLABL</span><span class="p">]</span> <span class="o">=</span> <span class="n">commonlabel</span>
                    <span class="n">properties</span><span class="p">[</span><span class="n">newnode</span><span class="p">][</span><span class="n">ICOMMON</span><span class="p">]</span> <span class="o">=</span> <span class="n">commonlabel</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span> <span class="c"># convenience flag</span>
                    <span class="n">properties</span><span class="p">[</span><span class="n">newnode</span><span class="p">][</span><span class="n">IGRAPHS</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">2</span><span class="o">**</span><span class="n">ig</span>            <span class="c"># bit field indicating the original graph</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node_properties</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">fromrecords</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="s">&#39;label,equivalence_name,common,graphmask&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">g_labels</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">g_labels</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">properties</span>
            <span class="k">del</span> <span class="n">g_labels</span>

            <span class="n">site_properties</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c"># temporary list to build rec array</span>
            <span class="k">for</span> <span class="n">np</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_properties</span><span class="p">:</span>
                <span class="c"># all but interstitial == [None,None] should have at least one entry in gNnodes</span>
                <span class="n">gNnodes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">ig</span><span class="p">,</span><span class="n">g_label</span><span class="p">)</span> \
                                <span class="k">for</span> <span class="n">ig</span><span class="p">,</span><span class="n">g_label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g_labels</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">label</span><span class="p">])</span> <span class="k">if</span> <span class="n">g_label</span><span class="p">])</span>
                <span class="n">volume</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">occupancy_avg</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">occupancy_std</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">center</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">])</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">ig</span><span class="p">,</span><span class="n">gNnode</span> <span class="ow">in</span> <span class="n">gNnodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">[</span><span class="n">ig</span><span class="p">]</span><span class="o">.</span><span class="n">site_properties</span><span class="p">[</span><span class="n">gNnode</span><span class="p">]</span>
                    <span class="n">volume</span> <span class="o">+=</span> <span class="n">sp</span><span class="o">.</span><span class="n">volume</span>
                    <span class="n">occupancy_avg</span> <span class="o">+=</span> <span class="n">sp</span><span class="o">.</span><span class="n">occupancy_avg</span>
                    <span class="n">occupancy_std</span> <span class="o">+=</span> <span class="n">sp</span><span class="o">.</span><span class="n">occupancy_std</span><span class="o">**</span><span class="mi">2</span>
                    <span class="n">center</span> <span class="o">+=</span> <span class="n">sp</span><span class="o">.</span><span class="n">center</span>
                <span class="n">N</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gNnodes</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">volume</span> <span class="o">/=</span> <span class="n">N</span>
                    <span class="n">occupancy_avg</span> <span class="o">/=</span> <span class="n">N</span>
                    <span class="n">occupancy_std</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">occupancy_std</span><span class="p">)</span>
                    <span class="n">center</span> <span class="o">/=</span> <span class="n">N</span>
                    <span class="n">equivalence_name</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">equivalence_name</span>  <span class="c"># redundant</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c"># interstitial, just fill in bogus zero values</span>
                    <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;interstitial&#39;</span><span class="p">])</span>
                    <span class="n">center</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># seems necessary so that the rec array is automatically built?!</span>
                                   <span class="c"># (forces a |o4 list instead of 2D array)</span>
                                   <span class="c"># (BUG: all fails if there&#39;s no interstitial!!!</span>
                                   <span class="c">#   Need to construct rec array properly, define type, then fill array)</span>
                    <span class="n">equivalence_name</span> <span class="o">=</span> <span class="s">&#39;interstitial&#39;</span>
                <span class="n">site_properties</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">label</span><span class="p">,</span><span class="n">volume</span><span class="p">,</span><span class="n">occupancy_avg</span><span class="p">,</span><span class="n">occupancy_std</span><span class="p">,</span><span class="n">center</span><span class="p">,</span><span class="n">equivalence_name</span><span class="p">,</span><span class="n">distance</span><span class="p">))</span>
            <span class="c"># site_properties</span>
            <span class="c"># (This is not the same site_properties that is used for</span>
            <span class="c"># equivalence sites.)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">fromrecords</span><span class="p">(</span><span class="n">site_properties</span><span class="p">,</span>
                                                         <span class="n">names</span><span class="o">=</span><span class="s">&#39;label,volume,occupancy_avg,occupancy_std,center,equivalence_name,distance&#39;</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">site_properties</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span><span class="o">.</span><span class="n">center</span><span class="p">[</span><span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;interstitial&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">])</span> <span class="c"># hack for distance</span>

            <span class="c"># build graph-indexed list of hopgraph-derived occupancies:</span>
            <span class="c"># g_occupancy_avg, g_occupancy_std. shape = (order(2,combined_graph)) (cf g_label)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">g_occupancy_avg</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">g_occupancy_std</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ig</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">):</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="s">&#39;occupancy_avg&#39;</span><span class="p">):</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">compute_site_occupancy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">g_occupancy_avg</span><span class="p">[</span><span class="n">ig</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph2combined</span><span class="p">(</span><span class="n">ig</span><span class="p">,</span><span class="n">nodes</span><span class="p">)]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">occupancy_avg</span><span class="p">[</span><span class="n">nodes</span><span class="p">]</span>

            <span class="c"># compute distance of site from center of geometry of all sites (excl interstitial &amp; bulk)</span>
            <span class="n">centers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span><span class="o">.</span><span class="n">center</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">centers</span><span class="p">[</span><span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;bulk&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>  <span class="c"># sites start after &#39;bulk&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span><span class="o">.</span><span class="n">distance</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">centers</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span> <span class="o">-</span> <span class="n">c0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

            <span class="k">def</span> <span class="nf">_joined_dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="c"># needed below: build new dict from old dict and new key=value pairs</span>
                <span class="n">_d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">_d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">_d</span>

            <span class="c"># add edges</span>
            <span class="k">for</span> <span class="n">ig</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">):</span>
                <span class="c"># add graph number to properties to make edge unique</span>
                <span class="c"># store the graph number in the NX 1.x edge dict as &#39;graph&#39;</span>
                <span class="n">ebunch</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph2combined</span><span class="p">(</span><span class="n">ig</span><span class="p">,</span><span class="n">u</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph2combined</span><span class="p">(</span><span class="n">ig</span><span class="p">,</span><span class="n">v</span><span class="p">),</span>
                           <span class="n">_joined_dict</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">ig</span><span class="p">))</span>
                          <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges_iter</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">)]</span>
                <span class="c"># original pre NX 1.x implementation: p&#39; &lt;-- p + (ig,)</span>
                <span class="c"># &quot;(p&#39;[3] == ig)&quot;</span>
                <span class="c">#ebunch = [(self._graph2combined(ig,u), self._graph2combined(ig,v),</span>
                <span class="c">#          p+(ig,) )  for u,v,p in g.graph.edges_iter()]</span>
                <span class="c"># Probably means that p[3] would always contain the graph number, p[:3]</span>
                <span class="c"># would be other stuff ... k,N,fit ? -- OB 2010-06-28</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">ebunch</span><span class="p">)</span>
            <span class="c"># record common edges in edge_properties</span>
            <span class="k">def</span> <span class="nf">edge_is_common</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>
                <span class="n">u0</span><span class="p">,</span><span class="n">v0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">,[</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">]]</span>
                <span class="n">u1</span><span class="p">,</span><span class="n">v1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">,[</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">]]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">u0</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">u1</span><span class="p">,</span><span class="n">v1</span><span class="p">]):</span>  <span class="c"># get one or more None if node not common</span>
                    <span class="k">return</span> <span class="bp">False</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">has_edge</span><span class="p">(</span><span class="n">u0</span><span class="p">,</span><span class="n">v0</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">has_edge</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span><span class="n">v1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges_iter</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_properties</span><span class="o">.</span><span class="n">has_key</span><span class="p">((</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">edge_properties</span><span class="p">[(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">)][</span><span class="s">&#39;plist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;graph&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">edge_properties</span><span class="p">[(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;common&#39;</span><span class="p">:</span> <span class="n">edge_is_common</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">),</span>
                                                   <span class="s">&#39;plist&#39;</span><span class="p">:[</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;graph&#39;</span><span class="p">]],}</span>
        <span class="k">elif</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Two HoppingGraphs or a filename is required.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_graph2combined</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">igraph</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;translate graph &lt;igraph&gt; node label(s) &lt;x&gt; to node label(s) of combined hybrid graph&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g2c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph2combined_dict</span><span class="p">[</span><span class="n">igraph</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>   <span class="c"># build cached dictionary first time</span>
            <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">izip</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_graph2combined_dict</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ig</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">)):</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_graph2combined_dict</span><span class="p">[</span><span class="n">ig</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">izip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g_labels</span><span class="p">[</span><span class="n">ig</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">node_properties</span><span class="o">.</span><span class="n">label</span><span class="p">))</span>
            <span class="n">g2c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph2combined_dict</span><span class="p">[</span><span class="n">igraph</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">g2c</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>        <span class="c"># return scalar</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">g2c</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_combined2graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">igraph</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;translate  node label(s) &lt;y&gt; of combined hybrid graph to graph &lt;igraph&gt; node label(s)&quot;&quot;&quot;</span>
        <span class="c"># or use self._graph2combined_dict[igraph] and invert... copy and paste for now:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">c2g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combined2graph_dict</span><span class="p">[</span><span class="n">igraph</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>   <span class="c"># build cached dictionary first time</span>
            <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">izip</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_combined2graph_dict</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ig</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">)):</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_combined2graph_dict</span><span class="p">[</span><span class="n">ig</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">izip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_properties</span><span class="o">.</span><span class="n">label</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">g_labels</span><span class="p">[</span><span class="n">ig</span><span class="p">]))</span>
            <span class="n">c2g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combined2graph_dict</span><span class="p">[</span><span class="n">igraph</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">c2g</span><span class="p">[</span><span class="n">y</span><span class="p">]</span>        <span class="c"># return scalar</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c2g</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">y</span><span class="p">])</span>

<div class="viewcode-block" id="CombinedGraph.site_properties"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.CombinedGraph.site_properties">[docs]</a>    <span class="k">def</span> <span class="nf">site_properties</span><span class="p">():</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s">&quot;site_properties of the combined graph, indexed by node label.&quot;</span>
        <span class="k">def</span> <span class="nf">fget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__site_properties</span>
        <span class="k">def</span> <span class="nf">fset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__site_properties</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span></div>
    <span class="n">site_properties</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="o">**</span><span class="n">site_properties</span><span class="p">())</span>

<div class="viewcode-block" id="CombinedGraph.is_connected"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.CombinedGraph.is_connected">[docs]</a>    <span class="k">def</span> <span class="nf">is_connected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">igraph</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if nodes n1 and n2 in graph igraph are connected.&quot;&quot;&quot;</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">[</span><span class="n">igraph</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">graph</span><span class="o">.</span><span class="n">has_successor</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">graph</span><span class="o">.</span><span class="n">has_predecessor</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span><span class="n">n1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CombinedGraph.load"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.CombinedGraph.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reinstantiate CombinedGraph from a pickled CombinedGraph (from save()).&quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;pickle&#39;</span><span class="p">,</span><span class="n">set_default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;rb&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c"># restore attributes from the temporary instance (works but not elegant...)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">graph</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="s">&#39;filtered_graph&#39;</span><span class="p">,</span> <span class="s">&#39;graphs&#39;</span><span class="p">,</span> <span class="s">&#39;g_labels&#39;</span><span class="p">,</span> \
                <span class="s">&#39;node_properties&#39;</span><span class="p">,</span> <span class="s">&#39;edge_properties&#39;</span><span class="p">,</span> \
                <span class="s">&#39;g_occupancy_avg&#39;</span><span class="p">,</span> <span class="s">&#39;g_occupancy_std&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">attr</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="c"># managed attributes (evaluate for side effects)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">site_properties</span>
        <span class="k">del</span> <span class="n">h</span>
</div>
<div class="viewcode-block" id="CombinedGraph.stats"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.CombinedGraph.stats">[docs]</a>    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">igraph</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Statistics for the hopping graph.</span>

<span class="sd">        d = stats(igraph,[data=dict])</span>

<span class="sd">        Without the data argument, the method just returns some</span>
<span class="sd">        interesting values gathered from the graph igraph and the density. If</span>
<span class="sd">        a data dictionary is given, then the raw data are loaded into</span>
<span class="sd">        the dict and can be processed further by histogramming etc.</span>

<span class="sd">        :Arguments:</span>
<span class="sd">        igraph        number of the graph</span>
<span class="sd">        data          optional dictionary to hold raw data for</span>
<span class="sd">                      processing; modified by method</span>

<span class="sd">        :Returns:</span>
<span class="sd">        d             dictionary with expressive keys, holding the results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">[</span><span class="n">igraph</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;igraph must be one of &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">))))</span>

</div>
<div class="viewcode-block" id="CombinedGraph.plot"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.CombinedGraph.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">igraph</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="s">&#39;png&#39;</span><span class="p">,</span><span class="n">use_filtered_graph</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">label_sites</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
             <span class="n">prog</span><span class="o">=</span><span class="s">&#39;neato&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_node_size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">drawargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot filtered graph using matplotlib.</span>

<span class="sd">        :Arguments:</span>
<span class="sd">        igraph         number of the graph (0 or 1)</span>
<span class="sd">        filename       file to write to</span>
<span class="sd">        format         any format that matplotlib allows and pdf</span>
<span class="sd">        use_filtered_graph</span>
<span class="sd">                       use a previously defined filtered graph (should be True)</span>
<span class="sd">        label_sites    {&#39;all&#39;:False, &#39;common&#39;:True, &#39;none&#39;:False} switches that determine</span>
<span class="sd">                       which labels to add to the nodes</span>
<span class="sd">        prog           layout program, can be any of the graphviz programs</span>
<span class="sd">                       &#39;dot&#39;,&#39;neato&#39;,&#39;twopi&#39;,&#39;circo&#39;,&#39;fdp&#39;,&#39;nop&#39;</span>
<span class="sd">        cmap           matplotlib color map: nodes are colored by distance of the site from</span>
<span class="sd">                       the geometric center of all sites (excluding bulk)</span>
<span class="sd">        max_node_size  maximum node size (in point**2, q.v. matplotlib.scatter())</span>
<span class="sd">        interactive    True: display graph. False: only save to file (eg if no X11)</span>
<span class="sd">        **drawargs     additional keyword arguments to networkx.draw() (q.v.)</span>
<span class="sd">                       eg &#39;linewidths=(0.01,)&#39; for vanishing outlines.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Layout the combined graph and then plot each graph</span>
        <span class="c"># separately but using the positions of the nodes of the</span>
        <span class="c"># combined graph layout.</span>
        <span class="kn">import</span> <span class="nn">pylab</span>
        <span class="kn">from</span> <span class="nn">hop.utilities</span> <span class="kn">import</span> <span class="n">matplotlib_interactive</span>
        <span class="n">matplotlib_interactive</span><span class="p">(</span><span class="n">interactive</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">label_sites</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">label_sites</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">common</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="nb">all</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">none</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="n">pylab</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">,</span><span class="n">edge</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

        <span class="n">graphviz_progs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;dot&#39;</span><span class="p">,</span><span class="s">&#39;neato&#39;</span><span class="p">,</span><span class="s">&#39;twopi&#39;</span><span class="p">,</span><span class="s">&#39;circo&#39;</span><span class="p">,</span><span class="s">&#39;fdp&#39;</span><span class="p">,</span><span class="s">&#39;nop&#39;</span><span class="p">]</span>
        <span class="n">graphnumbers</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">igraph</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graphnumbers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Selected active graph &lt;igraph&gt; must be one of &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">graphnumbers</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">prog</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graphviz_progs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Layout program &lt;prog&gt; must be one of &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">graphviz_progs</span><span class="p">))</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_graph</span><span class="p">(</span><span class="n">use_filtered_graph</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">NX</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">graph</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>  <span class="c"># need to clean up graph first --&gt; H is tmp graph</span>
        <span class="n">H</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">([</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes_iter</span><span class="p">()])</span>
        <span class="c"># XXX: NX 1.x: original (u,v,{&#39;graph&#39;:str(p[3])}) -- is the following correct, what was p[3] ??</span>
        <span class="n">H</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">([(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,{</span><span class="s">&#39;graph&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;graph&#39;</span><span class="p">])})</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges_iter</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">)])</span> <span class="c"># clean up; str!</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="n">NX</span><span class="o">.</span><span class="n">pygraphviz_layout</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">prog</span><span class="o">=</span><span class="n">prog</span><span class="p">)</span>  <span class="c"># combined graph layout</span>

        <span class="k">def</span> <span class="nf">subgraph</span><span class="p">(</span><span class="n">ig</span><span class="p">,</span><span class="n">H</span><span class="o">=</span><span class="n">H</span><span class="p">):</span>
            <span class="n">G</span> <span class="o">=</span> <span class="n">NX</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">([</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">H</span><span class="o">.</span><span class="n">nodes_iter</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_properties</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">graphmask</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="o">**</span><span class="n">ig</span><span class="p">])</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">([(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="n">H</span><span class="o">.</span><span class="n">edges_iter</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;graph&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="n">ig</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">G</span>
        <span class="n">G</span> <span class="o">=</span> <span class="p">[</span><span class="n">subgraph</span><span class="p">(</span><span class="n">ig</span><span class="p">)</span> <span class="k">for</span> <span class="n">ig</span> <span class="ow">in</span> <span class="n">graphnumbers</span><span class="p">]</span>

        <span class="c"># labels</span>
        <span class="k">if</span> <span class="s">&#39;none&#39;</span> <span class="ow">in</span> <span class="n">label_sites</span> <span class="ow">and</span> <span class="n">label_sites</span><span class="p">[</span><span class="s">&#39;none&#39;</span><span class="p">]:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">(),[</span><span class="s">&#39;&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">graph</span><span class="o">.</span><span class="n">order</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span><span class="o">.</span><span class="n">equivalence_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>         <span class="c"># sets dtype to |S12</span>
            <span class="n">disjoint_sites</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_properties</span><span class="o">.</span><span class="n">common</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;all&#39;</span> <span class="ow">in</span> <span class="n">label_sites</span> <span class="ow">and</span> <span class="n">label_sites</span><span class="p">[</span><span class="s">&#39;all&#39;</span><span class="p">]:</span>
                <span class="n">labels</span><span class="p">[</span><span class="n">disjoint_sites</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_properties</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="n">disjoint_sites</span><span class="p">]</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">(),</span><span class="n">labels</span><span class="p">[</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">()]))</span>   <span class="c"># only keep the ones in graph</span>
        <span class="c"># colors</span>
        <span class="n">vmin</span><span class="p">,</span><span class="n">vmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="c"># shapes o = circle, d = diamond, s = square</span>
        <span class="c"># only one per plot --&gt; need to plot on top, not implemented yet</span>
        <span class="c">##common_nodes = [n for n in H.nodes_iter() if self.node_properties[n].common]</span>
        <span class="c">## #node_shape=&#39;o&#39;,nodelist=common_nodes,</span>

        <span class="c"># for edge_color to work need networkx-0.37: https://networkx.lanl.gov/ticket/144</span>
        <span class="c"># reorder graphnumbers so that active graph is last (and drawn on top)</span>
        <span class="n">ordered_graphnumbers</span> <span class="o">=</span> <span class="n">graphnumbers</span><span class="p">[:]</span>
        <span class="n">ordered_graphnumbers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">igraph</span><span class="p">)</span>
        <span class="n">ordered_graphnumbers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">igraph</span><span class="p">)</span>
        <span class="c"># node size proportional to occupancy:</span>
        <span class="c"># find normalization from all graphs (but exclude bulk)</span>
        <span class="n">occ_max</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">occupancy</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">occupancy_avg</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c"># compute it</span>
                <span class="n">g</span><span class="o">.</span><span class="n">compute_site_occupancy</span><span class="p">()</span>
                <span class="n">occupancy</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">occupancy_avg</span>
            <span class="n">realsites</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">occupancy</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
            <span class="n">realsites</span><span class="p">[[</span><span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;interstitial&#39;</span><span class="p">],</span><span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;bulk&#39;</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">occ_max</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">occupancy</span><span class="p">[</span><span class="n">realsites</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>  <span class="c"># masked out interstitial and bulk</span>
        <span class="n">occupancy_max</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">occ_max</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">occ_max</span>

        <span class="c"># add something based on is_connected() to highlight sites NOT</span>
        <span class="c"># connected to bulk, eg use different shape or heavier outline for</span>
        <span class="c"># symbol</span>
        <span class="c">#for ig,g in enumerate(self.graphs):</span>
        <span class="c">#    g.has_bulkconnection = {}</span>
        <span class="c">#    for n in g.nodes():</span>
        <span class="c">#        g.has_bulkconnection[n] = self.is_connected(ig,n,SITELABEL[&#39;bulk&#39;])</span>

        <span class="k">def</span> <span class="nf">edgecolor</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_properties</span><span class="p">[(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">)][</span><span class="s">&#39;common&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="s">&#39;r&#39;</span>
            <span class="k">return</span> <span class="s">&#39;k&#39;</span>
        <span class="k">def</span> <span class="nf">graph_parameters</span><span class="p">(</span><span class="n">ig</span><span class="p">,</span><span class="n">igraph</span><span class="o">=</span><span class="n">igraph</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Return dict of optional parameters for NX.draw.</span>
<span class="sd">            Extra function for interactive debugging.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">ig</span> <span class="o">==</span> <span class="n">igraph</span><span class="p">:</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span>
            <span class="n">node_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span><span class="o">.</span><span class="n">distance</span><span class="p">[</span><span class="n">G</span><span class="p">[</span><span class="n">ig</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">()]</span> <span class="c"># only keep the ones in graph</span>
            <span class="n">gnodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combined2graph</span><span class="p">(</span><span class="n">ig</span><span class="p">,</span><span class="n">G</span><span class="p">[</span><span class="n">ig</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span>     <span class="c"># nodes in original graph</span>
            <span class="n">occupancy</span> <span class="o">=</span> <span class="n">max_node_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">[</span><span class="n">ig</span><span class="p">]</span><span class="o">.</span><span class="n">occupancy_avg</span><span class="p">[</span><span class="n">gnodes</span><span class="p">]</span><span class="o">/</span><span class="n">occupancy_max</span>
            <span class="n">edge_color</span> <span class="o">=</span> <span class="p">[</span><span class="n">edgecolor</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">G</span><span class="p">[</span><span class="n">ig</span><span class="p">]</span><span class="o">.</span><span class="n">edges_iter</span><span class="p">()]</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span>
                        <span class="n">node_color</span><span class="o">=</span><span class="n">node_color</span><span class="p">,</span>
                        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="s">&#39;node&#39;</span><span class="p">],</span>
                        <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                        <span class="n">node_size</span><span class="o">=</span><span class="n">occupancy</span><span class="p">,</span>
                        <span class="n">edge_color</span><span class="o">=</span><span class="n">edge_color</span><span class="p">,</span>
                        <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                        <span class="p">)</span>

        <span class="n">cax</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ig</span> <span class="ow">in</span> <span class="n">ordered_graphnumbers</span><span class="p">:</span>
            <span class="n">gp</span> <span class="o">=</span> <span class="n">graph_parameters</span><span class="p">(</span><span class="n">ig</span><span class="p">)</span>
            <span class="n">gp</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">drawargs</span><span class="p">)</span>
            <span class="n">NX</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="n">ig</span><span class="p">],</span>
                    <span class="c"># ax=cax,   ## needs to be commented out, otherwise empty frame</span>
                    <span class="o">**</span><span class="n">gp</span><span class="p">)</span>
        <span class="n">imgfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">format</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">imgfile</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CombinedGraph.export"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.CombinedGraph.export">[docs]</a>    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">igraph</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="s">&#39;XGMML&#39;</span><span class="p">,</span><span class="n">imageformat</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">use_filtered_graph</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Layout the combined graph and highlight the chosen graph.</span>

<span class="sd">        h.export(igraph=0)</span>

<span class="sd">        :Arguments:</span>
<span class="sd">        graph        0 or 1, selects which graph is to be highlighted</span>
<span class="sd">        filename     name for the output files; appropriate suffixes are added</span>
<span class="sd">                     automatically</span>
<span class="sd">        format       XGMML or dot</span>
<span class="sd">        imageformat  graphics output format (png, jpg, ps, svg, ... see below)</span>
<span class="sd">        use_filtered_graph</span>
<span class="sd">                     By default, the filtered graph (see the filter() method) is</span>
<span class="sd">                     plotted. If set to False then the original HoppingGraph is</span>
<span class="sd">                     used instead.</span>

<span class="sd">        Common nodes are always highlighted in red and shown with the</span>
<span class="sd">        common label. Nodes and edges belonging to the selected graph</span>
<span class="sd">        are shown in black; the other graph is only shown in light</span>
<span class="sd">        gray.</span>

<span class="sd">        The graph is only written to an image file if an image format</span>
<span class="sd">        is supplied. See</span>
<span class="sd">        https://networkx.lanl.gov/reference/pygraphviz/pygraphviz.agraph.AGraph-class.html#draw</span>
<span class="sd">        for possible output formats but png, jpg, ps are safe bets.</span>

<span class="sd">        :Format:</span>
<span class="sd">        XGMML      http://www.cs.rpi.edu/~puninj/XGMML/draft-xgmml.html#Intro and</span>
<span class="sd">                   GML http://www.infosun.fim.uni-passau.de/Graphlet/GML/</span>
<span class="sd">        dot        See http://graphviz.org/doc/info/attrs.html for attributes.</span>

<span class="sd">        Note: On Mac OS X 10.3.9+fink the pygraphviz rendering is</span>
<span class="sd">        buggy and does not include node labels. Simply use the</span>
<span class="sd">        exported .dot file and use Mac OS X graphviz from</span>
<span class="sd">        http://www.pixelglow.com/graphviz/</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># copy &amp; paste and modified HoppingGraph.export() because I can&#39;t be bothered to write</span>
        <span class="c"># a more generic version (or use site_properties properly?)</span>
        <span class="kn">import</span> <span class="nn">pygraphviz</span>

        <span class="n">graphnumbers</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">igraph</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graphnumbers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;igraph must be 0 or 1.&#39;</span><span class="p">)</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_graph</span><span class="p">(</span><span class="n">use_filtered_graph</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">format</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_export_formats</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Only the following formats are supported for export:&#39;</span><span class="o">+</span>
                             <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_export_formats</span><span class="p">))</span>
        <span class="n">activegraph</span> <span class="o">=</span> <span class="n">igraph</span>            <span class="c"># index key for active graph</span>
        <span class="n">graphnumbers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">igraph</span><span class="p">)</span>
        <span class="n">inactivegraph</span> <span class="o">=</span> <span class="n">graphnumbers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c"># index key for inactive graph</span>
        <span class="n">graphnumbers</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">))</span> <span class="c"># need them all again</span>

        <span class="n">G</span> <span class="o">=</span> <span class="n">pygraphviz</span><span class="o">.</span><span class="n">AGraph</span><span class="p">(</span><span class="n">directed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>   <span class="c"># no multi edges??</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">([(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges_iter</span><span class="p">()])</span> <span class="c"># n1 n2</span>

        <span class="c"># attributes: http://www.graphviz.org/doc/info/attrs.html</span>
        <span class="c"># colors: http://www.graphviz.org/doc/info/colors.html</span>
        <span class="n">color</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;edge&#39;</span><span class="p">:</span>     <span class="p">{</span><span class="s">&#39;on&#39;</span> <span class="p">:</span> <span class="s">&#39;gray20&#39;</span><span class="p">,</span>
                              <span class="s">&#39;off&#39;</span><span class="p">:</span> <span class="s">&#39;gray75&#39;</span><span class="p">,</span>
                              <span class="s">&#39;common&#39;</span><span class="p">:</span> <span class="s">&#39;red&#39;</span><span class="p">,</span>
                              <span class="p">},</span>
                 <span class="s">&#39;nodefill&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;on&#39;</span> <span class="p">:</span> <span class="s">&#39;gray60&#39;</span><span class="p">,</span>
                              <span class="s">&#39;off&#39;</span><span class="p">:</span> <span class="s">&#39;gray90&#39;</span><span class="p">,</span>
                              <span class="s">&#39;common&#39;</span><span class="p">:</span> <span class="s">&#39;black&#39;</span><span class="p">,</span>
                              <span class="p">},</span>
                 <span class="p">}</span>
        <span class="c"># default to &#39;off&#39; colours</span>
        <span class="n">G</span><span class="o">.</span><span class="n">graph_attr</span><span class="p">[</span><span class="s">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#39;, k in 1/ns (N)&#39;</span>
        <span class="n">G</span><span class="o">.</span><span class="n">graph_attr</span><span class="p">[</span><span class="s">&#39;splines&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;true&#39;</span>
        <span class="n">G</span><span class="o">.</span><span class="n">node_attr</span><span class="p">[</span><span class="s">&#39;fontcolor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;white&#39;</span>
        <span class="n">G</span><span class="o">.</span><span class="n">node_attr</span><span class="p">[</span><span class="s">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;circle&#39;</span>
        <span class="n">G</span><span class="o">.</span><span class="n">node_attr</span><span class="p">[</span><span class="s">&#39;fillcolor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="s">&#39;nodefill&#39;</span><span class="p">][</span><span class="s">&#39;off&#39;</span><span class="p">]</span>
        <span class="n">G</span><span class="o">.</span><span class="n">node_attr</span><span class="p">[</span><span class="s">&#39;style&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;filled&#39;</span>
        <span class="n">G</span><span class="o">.</span><span class="n">edge_attr</span><span class="p">[</span><span class="s">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="s">&#39;edge&#39;</span><span class="p">][</span><span class="s">&#39;off&#39;</span><span class="p">]</span>
        <span class="n">G</span><span class="o">.</span><span class="n">edge_attr</span><span class="p">[</span><span class="s">&#39;dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;forward&#39;</span>

        <span class="c"># colouring and labeling of edges</span>
        <span class="c"># attach k_ji to edge (printed in 1/ns), number of transitions in ()</span>
        <span class="n">xedgeattr</span> <span class="o">=</span> <span class="p">{}</span>     <span class="c"># helper dict for XMMLG</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
            <span class="n">u</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>        <span class="c"># need nodes as integers</span>
            <span class="n">xedgeattr</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>            <span class="c"># hack for XMMLG</span>
            <span class="n">xattr</span> <span class="o">=</span> <span class="n">xedgeattr</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">v</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>          <span class="c">#  TODO: currently only chooses first edge 0 XXX</span>
            <span class="n">k</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">fit</span><span class="p">,</span><span class="n">graph_number</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="s">&#39;k&#39;</span><span class="p">],</span> <span class="n">p0</span><span class="p">[</span><span class="s">&#39;N&#39;</span><span class="p">],</span> <span class="n">p0</span><span class="p">[</span><span class="s">&#39;fit&#39;</span><span class="p">],</span> <span class="n">p0</span><span class="p">[</span><span class="s">&#39;graph&#39;</span><span class="p">]</span> <span class="c"># extract k from HoppingGraph</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fit</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>         <span class="c"># get two rates if double exp</span>
                <span class="n">a</span><span class="p">,</span><span class="n">k1</span><span class="p">,</span><span class="n">k2</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">parameters</span>
                <span class="n">kns</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="n">k1</span><span class="p">,</span><span class="n">k2</span><span class="p">])</span> <span class="c"># rate in 1/ns</span>
                <span class="n">k_dominant</span> <span class="o">=</span> <span class="n">kns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>              <span class="c"># only display fastest rate</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">k_dominant</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="n">k</span>              <span class="c"># rate in 1/ns</span>
            <span class="n">k_legend</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(k_dominant).1f</span><span class="s"> (</span><span class="si">%(N)d</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="nb">locals</span><span class="p">()</span>
            <span class="n">e</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s">&#39;headlabel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k_legend</span>
            <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k_dominant</span>           <span class="c"># for XMMLG</span>
            <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span>                       <span class="c"># for XMMLG</span>
            <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;graphnumbers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">graph_number</span><span class="p">]</span>  <span class="c"># for XMMLG, filter on graphnumber</span>
            <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;graph&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph_number</span>
            <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;common&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;active&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_properties</span><span class="p">[(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">)][</span><span class="s">&#39;common&#39;</span><span class="p">]:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="s">&#39;edge&#39;</span><span class="p">][</span><span class="s">&#39;common&#39;</span><span class="p">]</span>
                <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;graphnumbers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">graphnumbers</span>
                <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;common&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;active&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">graph_number</span> <span class="o">==</span> <span class="n">igraph</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="s">&#39;edge&#39;</span><span class="p">][</span><span class="s">&#39;on&#39;</span><span class="p">]</span>
                <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;active&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># colouring and labeling of nodes</span>
        <span class="n">xnodeattr</span> <span class="o">=</span> <span class="p">{}</span>     <span class="c"># helper dict for XMMLG</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="n">common_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_properties</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">equivalence_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">node_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g_labels</span><span class="p">[</span><span class="n">activegraph</span><span class="p">,</span><span class="n">label</span><span class="p">]</span>
            <span class="n">xnodeattr</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>            <span class="c"># hack for XMMLG</span>
            <span class="n">xattr</span> <span class="o">=</span> <span class="n">xnodeattr</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
            <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;common&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>          <span class="c"># for XMMLG</span>
            <span class="k">if</span> <span class="n">common_label</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">common_label</span><span class="p">)</span>
                <span class="n">node</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s">&#39;fillcolor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="s">&#39;nodefill&#39;</span><span class="p">][</span><span class="s">&#39;common&#39;</span><span class="p">]</span>
                <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;graphnumbers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">graphnumbers</span>     <span class="c"># for XMMLG</span>
                <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;common&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>                   <span class="c"># for XMMLG</span>
                <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;active&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>                   <span class="c"># for XMMLG</span>
                <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;graph&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">activegraph</span>
            <span class="k">elif</span> <span class="n">node_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">node_label</span><span class="p">)</span>
                <span class="n">node</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s">&#39;fillcolor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="s">&#39;nodefill&#39;</span><span class="p">][</span><span class="s">&#39;on&#39;</span><span class="p">]</span>
                <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;graphnumbers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">activegraph</span><span class="p">]</span> <span class="c"># for XMMLG, filter on graphnumber (list with dot?)</span>
                <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;active&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>                      <span class="c"># for XMMLG</span>
                <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;graph&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">activegraph</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g_labels</span><span class="p">[</span><span class="n">inactivegraph</span><span class="p">,</span><span class="n">label</span><span class="p">])</span>
                <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;graphnumbers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">inactivegraph</span><span class="p">]</span> <span class="c"># for XMMLG, filter on graphnumber (list with dot?)</span>
                <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;active&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>                     <span class="c"># for XMMLG</span>
                <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;graph&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inactivegraph</span>

        <span class="k">if</span> <span class="n">format</span> <span class="o">==</span> <span class="s">&#39;XGMML&#39;</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;.xgmml&#39;</span><span class="p">)</span>
            <span class="n">xml</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
                      <span class="sd">&quot;&quot;&quot;&lt;!DOCTYPE graph PUBLIC &quot;-//John Punin//DTD graph description//EN&quot; &quot;http://www.cs.rpi.edu/~puninj/XGMML/xgmml.dtd&quot;&gt;\n&quot;&quot;&quot;</span>
                      <span class="sd">&quot;&quot;&quot;&lt;graph label=&quot;CombinedGraph&quot; directed=&quot;1&quot; id=&quot;CombinedGraph&quot; &quot;&quot;&quot;</span>
                      <span class="sd">&quot;&quot;&quot;xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; &quot;&quot;&quot;</span>
                      <span class="sd">&quot;&quot;&quot;xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot; &quot;&quot;&quot;</span>
                      <span class="sd">&quot;&quot;&quot;xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot; &quot;&quot;&quot;</span>
                      <span class="sd">&quot;&quot;&quot;xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot; &quot;&quot;&quot;</span>
                      <span class="sd">&quot;&quot;&quot;xmlns=&quot;http://www.cs.rpi.edu/XGMML&quot; &quot;&quot;&quot;</span>
                      <span class="sd">&quot;&quot;&quot;Vendor=&quot;hop.sitemap.CombinedGraph.export&quot;&gt;\n&quot;&quot;&quot;</span>
                      <span class="sd">&quot;&quot;&quot;\t&lt;att name=&quot;documentVersion&quot; value=&quot;1.0&quot;/&gt;\n&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t</span><span class="s">&lt;att name=&quot;activeGraph&quot; type=&quot;integer&quot; value=&quot;</span><span class="si">%d</span><span class="s">&quot;/&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">activegraph</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="n">xattr</span> <span class="o">=</span> <span class="n">xnodeattr</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
                <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t</span><span class="s">&lt;node id=&quot;</span><span class="si">%d</span><span class="s">&quot; label=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">node</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s">&#39;label&#39;</span><span class="p">]))</span>
                <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t</span><span class="s">&lt;att type=&quot;list&quot; name=&quot;graphs&quot;&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">graphnumber</span> <span class="ow">in</span> <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;graphnumbers&#39;</span><span class="p">]:</span>
                    <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t\t</span><span class="s">&lt;att type=&quot;integer&quot; name=&quot;graphnumber&quot; value=&quot;</span><span class="si">%d</span><span class="s">&quot;/&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> \
                                  <span class="o">%</span> <span class="n">graphnumber</span><span class="p">)</span>
                <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t</span><span class="s">&lt;/att&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
                <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t</span><span class="s">&lt;att type=&quot;integer&quot; name=&quot;graph&quot; value=&quot;</span><span class="si">%(graph)d</span><span class="s">&quot;/&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">xattr</span><span class="p">)</span>
                <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t</span><span class="s">&lt;att type=&quot;integer&quot; name=&quot;common&quot; value=&quot;</span><span class="si">%(common)d</span><span class="s">&quot;/&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">xattr</span><span class="p">)</span>
                <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t</span><span class="s">&lt;att type=&quot;integer&quot; name=&quot;active&quot; value=&quot;</span><span class="si">%(active)d</span><span class="s">&quot;/&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">xattr</span><span class="p">)</span>
<span class="c">#                xml.write(&quot;&quot;&quot;\t\t&lt;att type=&quot;&quot; name=&quot;&quot; value=&quot;&quot;/&gt;\n&quot;&quot;&quot;)</span>
                <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t</span><span class="s">&lt;/node&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
                <span class="n">u</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
                <span class="n">xattr</span> <span class="o">=</span> <span class="n">xedgeattr</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
                <span class="n">subst</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;u&#39;</span><span class="p">:</span><span class="n">u</span><span class="p">,</span><span class="s">&#39;v&#39;</span><span class="p">:</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;label&#39;</span><span class="p">:</span><span class="n">e</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s">&#39;headlabel&#39;</span><span class="p">],</span><span class="s">&#39;id&#39;</span><span class="p">:</span><span class="s">&quot;</span><span class="si">%d</span><span class="s"> -&gt; </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">)}</span>
                <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t</span><span class="s">&lt;edge source=&quot;</span><span class="si">%(u)d</span><span class="s">&quot; target=&quot;</span><span class="si">%(v)d</span><span class="s">&quot; label=&quot;</span><span class="si">%(label)s</span><span class="s">&quot;&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> \
                              <span class="o">%</span> <span class="n">subst</span><span class="p">)</span>
                <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t</span><span class="s">&lt;att type=&quot;string&quot; name=&quot;EDGE_TYPE&quot; value=&quot;DirectedEdge&quot;/&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
                <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t</span><span class="s">&lt;att type=&quot;string&quot; name=&quot;interaction&quot; value=&quot;DirectedEdge&quot;/&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
                <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t</span><span class="s">&lt;att type=&quot;integer&quot; name=&quot;N&quot; value=&quot;</span><span class="si">%(N)d</span><span class="s">&quot;/&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">xattr</span><span class="p">)</span>
                <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t</span><span class="s">&lt;att type=&quot;real&quot; name=&quot;rate&quot; value=&quot;</span><span class="si">%(rate)f</span><span class="s">&quot;/&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">xattr</span><span class="p">)</span>
                <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t</span><span class="s">&lt;att type=&quot;list&quot; name=&quot;graphs&quot;&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">graphnumber</span> <span class="ow">in</span> <span class="n">xattr</span><span class="p">[</span><span class="s">&#39;graphnumbers&#39;</span><span class="p">]:</span>
                    <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t\t</span><span class="s">&lt;att type=&quot;integer&quot; name=&quot;graphnumber&quot; value=&quot;</span><span class="si">%d</span><span class="s">&quot;/&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> \
                                  <span class="o">%</span> <span class="n">graphnumber</span><span class="p">)</span>
                <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t</span><span class="s">&lt;/att&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
                <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t</span><span class="s">&lt;att type=&quot;integer&quot; name=&quot;graph&quot; value=&quot;</span><span class="si">%(graph)d</span><span class="s">&quot;/&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">xattr</span><span class="p">)</span>
                <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t</span><span class="s">&lt;att type=&quot;integer&quot; name=&quot;common&quot; value=&quot;</span><span class="si">%(common)d</span><span class="s">&quot;/&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">xattr</span><span class="p">)</span>
                <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t</span><span class="s">&lt;att type=&quot;integer&quot; name=&quot;active&quot; value=&quot;</span><span class="si">%(active)d</span><span class="s">&quot;/&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">xattr</span><span class="p">)</span>
                <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t</span><span class="s">&lt;/edge&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;&lt;/graph&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">format</span> <span class="o">==</span> <span class="s">&#39;dot&#39;</span><span class="p">:</span>
            <span class="n">dotname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;.dot&#39;</span><span class="p">)</span>       <span class="c"># load into graphviz</span>
            <span class="n">G</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dotname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">imageformat</span><span class="p">:</span>
                <span class="n">gfxname</span> <span class="o">=</span> <span class="n">filename</span><span class="o">+</span><span class="s">&#39;.&#39;</span><span class="o">+</span><span class="n">format</span>
                <span class="n">G</span><span class="o">.</span><span class="n">layout</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="s">&#39;dot&#39;</span><span class="p">)</span>
                <span class="n">G</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">gfxname</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">)</span>  <span class="c"># buggy on Mac OS X</span>
</div>
    <span class="k">def</span> <span class="nf">plot_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
    <span class="k">def</span> <span class="nf">export3D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
    <span class="k">def</span> <span class="nf">tabulate_k</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
<div class="viewcode-block" id="CombinedGraph.equivalent_sites_stats"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.CombinedGraph.equivalent_sites_stats">[docs]</a>    <span class="k">def</span> <span class="nf">equivalent_sites_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">graphnumber</span><span class="p">,</span><span class="n">elabels</span><span class="p">,</span><span class="n">equivalence</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print statistics about one or a list of equivalence sites for the numbered graph.</span>

<span class="sd">        CombinedGraph.equivalent_sites_stats(graphnumber,elabels)</span>

<span class="sd">        :Arguments:</span>
<span class="sd">        graphnumber       index into CombinedGraph.graphs (typically, 0 or 1)</span>
<span class="sd">        elabels           single label or list of labels of equivalence sites</span>
<span class="sd">                          (without a &#39;*&#39; if the default identifier is used)</span>
<span class="sd">        equivalence       True: interprete elabels as equivalence labels</span>
<span class="sd">                          False: elabels are labels local to the graph (as used</span>
<span class="sd">                                 in the output of this method)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">[</span><span class="n">graphnumber</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;graphnumber must correspond to a graph in the CombinedGraph, one of &#39;</span><span class="o">+</span>
                             <span class="nb">str</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">))))</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">equivalent_sites_stats</span><span class="p">(</span><span class="n">elabels</span><span class="p">,</span><span class="n">equivalence</span><span class="o">=</span><span class="n">equivalence</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="fit_func"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.fit_func">[docs]</a><span class="k">class</span> <span class="nc">fit_func</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fit a function f to data (x,y) using the method of least squares.</span>

<span class="sd">    Attributes:</span>

<span class="sd">    parameters     list of parameters of the fit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># NOTE: this class must stay in the same file as HoppingGraph. Otherwise</span>
    <span class="c">#       cPickle does not work on HoppingGraph (and one needs to implement</span>
    <span class="c">#       custom pickling)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">scipy.optimize</span>
        <span class="n">_x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">_y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_values</span><span class="p">()</span>
        <span class="n">fitfunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_factory</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">errfunc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
            <span class="k">return</span>  <span class="n">fitfunc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span>     <span class="c"># residuals</span>
        <span class="n">p</span><span class="p">,</span><span class="n">msg</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">leastsq</span><span class="p">(</span><span class="n">errfunc</span><span class="p">,</span><span class="n">p0</span><span class="p">[:],</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span><span class="n">_y</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">p</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span><span class="ne">IndexError</span><span class="p">,):</span>
            <span class="c"># TypeError for int p, IndexError for numpy scalar (new scipy)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">msg</span>

<div class="viewcode-block" id="fit_func.f_factory"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.fit_func.f_factory">[docs]</a>    <span class="k">def</span> <span class="nf">f_factory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stub for fit function factory, which returns the fit function.</span>
<span class="sd">        Override for derived classes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">fitfunc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
            <span class="c"># return f(p,x); should be a numpy ufunc</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;base class must be extended for each fit function&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fitfunc</span>
</div>
<div class="viewcode-block" id="fit_func.initial_values"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.fit_func.initial_values">[docs]</a>    <span class="k">def</span> <span class="nf">initial_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of initital guesses for all parameters p[]&quot;&quot;&quot;</span>
        <span class="c"># return [1.0, 2.0, 0.5]</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;base class must be extended for each fit function&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="fit_func.fit"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.fit_func.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Applies the fit to all x values&quot;&quot;&quot;</span>
        <span class="n">fitfunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_factory</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fitfunc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</div></div>
<div class="viewcode-block" id="fitExp"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.fitExp">[docs]</a><span class="k">class</span> <span class="nc">fitExp</span><span class="p">(</span><span class="n">fit_func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;y = f(x) = exp(-p[0]*x)&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">f_factory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">fitfunc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>   <span class="c"># exp(-B*x)</span>
        <span class="k">return</span> <span class="n">fitfunc</span>
    <span class="k">def</span> <span class="nf">initial_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;fitExp &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;&gt;&quot;</span>
</div>
<div class="viewcode-block" id="fitExp2"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.fitExp2">[docs]</a><span class="k">class</span> <span class="nc">fitExp2</span><span class="p">(</span><span class="n">fit_func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;y = f(x) = p[0]*exp(-p[1]*x) + (1-p[0])*exp(-p[2]*x)&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">f_factory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">fitfunc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fitfunc</span>
    <span class="k">def</span> <span class="nf">initial_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">1e-4</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;fitExp2&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;&gt;&quot;</span>
</div>
<div class="viewcode-block" id="fitlin"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.fitlin">[docs]</a><span class="k">class</span> <span class="nc">fitlin</span><span class="p">(</span><span class="n">fit_func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;y = f(x) = p[0]*x + p[1]&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">f_factory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">fitfunc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">fitfunc</span>
    <span class="k">def</span> <span class="nf">initial_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;fitlin&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;&gt;&quot;</span>

</div>
<div class="viewcode-block" id="survivalfunction"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.survivalfunction">[docs]</a><span class="k">def</span> <span class="nf">survivalfunction</span><span class="p">(</span><span class="n">waitingtimes</span><span class="p">,</span> <span class="n">block_w</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">block_t</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the survival function S(t), defined by a list of waiting times.</span>

<span class="sd">       survival([t0, t1, ..., tN]) --&gt; S(t)</span>

<span class="sd">    S(t) is a function that gives the fractional number of particles that</span>
<span class="sd">    have not yet left the site after time t. It is 1 at t=0 and decays to 0.</span>

<span class="sd">    :Arguments:</span>
<span class="sd">       waitingtimes</span>
<span class="sd">          sequence of the waiting times from the simulations</span>
<span class="sd">      block_w</span>
<span class="sd">          reduce memory consumption by working on chunks of</span>
<span class="sd">          the waiting times of size &lt;block_w&gt;; reduce block_w if</span>
<span class="sd">          the code crashes with :Exception:`MemoryError`.</span>
<span class="sd">      block_t</span>
<span class="sd">          chunk input function arguments into blocks of size block_t</span>

<span class="sd">    :TODO: Make S(t) an interpolation function: massive speedup and fewer memory problems</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">S_doc</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;Survival function S(t).  t can be a array.</span>

<span class="s">    S(t) = &lt;Theta(t0 - t)&gt;_{t0} = &lt;1-Theta(t-t0)&gt;_{t0}</span>
<span class="s">    &quot;&quot;&quot;</span>

    <span class="c"># NOTE: These big functions S_numpy or S_lowmem are *evaluated</span>
    <span class="c"># every time* S(t) is called. Should be optimized eventually.</span>

    <span class="c"># straightforward version</span>
    <span class="k">def</span> <span class="nf">S_numpy</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">Unitstep</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t0</span> <span class="ow">in</span> <span class="n">waitingtimes</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">waitingtimes</span><span class="p">)</span>

    <span class="c"># work on chunks of waitingtimes of size block_w and chunks of times of size block_t</span>
    <span class="k">def</span> <span class="nf">S_lowmem</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="n">_t</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">N_t</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_t</span><span class="p">)</span>
        <span class="n">func_values</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_t</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>    <span class="c"># final result S(t) = func_values[:]</span>
        <span class="c"># need to block t, too, as it can be very large</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N_t</span><span class="p">,</span> <span class="n">block_t</span><span class="p">):</span>
            <span class="n">tmp_t</span> <span class="o">=</span> <span class="n">_t</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="n">block_t</span><span class="p">]</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp_t</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">waitingtimes</span><span class="p">),</span> <span class="n">block_w</span><span class="p">):</span>
                <span class="c"># the list comprehension can blow up in memory (so we block it)</span>
                <span class="c"># TODO: rewrite this completely in a better way (cumsum?? Theta -&gt; cumsum Delta)</span>
                <span class="n">values</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">Unitstep</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">tmp_t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t0</span> <span class="ow">in</span> <span class="n">waitingtimes</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">block_w</span><span class="p">]],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">func_values</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)]</span> <span class="o">=</span> <span class="n">values</span>
        <span class="n">func_values</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">waitingtimes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func_values</span>

    <span class="c"># Perhaps only use S_lowmem ?? Would be more robust.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">waitingtimes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">block_w</span><span class="p">:</span>
        <span class="c"># print &quot;survivalfunction(): using standard version (len(tau)=%d &lt; block_w=%d)&quot; % (len(waitingtimes),block_w)</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">S_numpy</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># TODO: should really check if something like len(waitingtimes) * len(t) &gt;</span>
        <span class="c"># available memory but at this time t isn&#39;t known; I would have to put the</span>
        <span class="c"># switching logic into the function S(t) itself The problem is really that for</span>
        <span class="c"># long trajectories, len(t) can be very large (eg 100ns * 1000 frames/ns = 10^5)</span>
        <span class="c"># when there are bound water molecules (with tau ~ t_sim); one way to solve it</span>
        <span class="c"># would be to use a larger dt when evaluating S(t). Right now we are trying to be</span>
        <span class="c"># somewhat robust by simply blocking both waitingtimes (&#39;block_w&#39;) and times t</span>
        <span class="c"># (&#39;block_t&#39;)</span>

        <span class="c"># print &quot;survivalfunction(): using lowmem version (len(tau)=%d &gt;= block_w=%d)&quot; % (len(waitingtimes),block_w)</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">S_lowmem</span>
    <span class="n">S</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">S_doc</span>
    <span class="k">return</span> <span class="n">S</span>
</div>
<div class="viewcode-block" id="Unitstep"><a class="viewcode-back" href="../../hop/graph.html#hop.graph.Unitstep">[docs]</a><span class="k">def</span> <span class="nf">Unitstep</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">x0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Heaviside step function</span>
<span class="sd">                                       / 1    if x &gt;= x0</span>
<span class="sd">    Unitstep(x,x0) == Theta(x - x0) = {  0.5  if x == x0</span>
<span class="sd">                                       \ 0    if x &lt;  x0</span>

<span class="sd">    This is a numpy ufunc.</span>

<span class="sd">    :CAVEAT:    If both x and x0 are arrays of length &gt; 1 then weird things are</span>
<span class="sd">                going to happen because of broadcasting.</span>
<span class="sd">                Using nD arrays can also lead to surprising results.</span>

<span class="sd">    :See also:  http://mathworld.wolfram.com/HeavisideStepFunction.html</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">_x0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="k">return</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">_x</span> <span class="o">-</span> <span class="n">_x0</span><span class="p">))</span>
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Hop 0.3.3 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Thomas B. Woolf, Oliver Beckstein.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>