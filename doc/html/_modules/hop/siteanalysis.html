

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>hop.siteanalysis &mdash; Hop 0.3.3 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.3.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Hop 0.3.3 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Hop 0.3.3 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for hop.siteanalysis</h1><div class="highlight"><pre>
<span class="c"># $Id$</span>
<span class="c"># Hop --- a framework to analyze solvation dynamics from MD simulations</span>
<span class="c"># Copyright (c) 2009 Oliver Beckstein &lt;orbeckst@gmail.com&gt;</span>
<span class="c">#</span>
<span class="c"># This program is free software: you can redistribute it and/or modify</span>
<span class="c"># it under the terms of the GNU General Public License as published by</span>
<span class="c"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c"># (at your option) any later version.</span>
<span class="c">#</span>
<span class="c"># This program is distributed in the hope that it will be useful,</span>
<span class="c"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c"># GNU General Public License for more details.</span>
<span class="c">#</span>
<span class="c"># You should have received a copy of the GNU General Public License</span>
<span class="c"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">hop</span>
<span class="kn">import</span> <span class="nn">hop.utilities</span>
<span class="kn">import</span> <span class="nn">hop.trajectory</span>
<span class="kn">from</span> <span class="nn">hop.utilities</span> <span class="kn">import</span> <span class="n">set_verbosity</span><span class="p">,</span><span class="n">msg</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">IntrospectiveDict</span>
<span class="kn">from</span> <span class="nn">hop.constants</span> <span class="kn">import</span> <span class="n">SITELABEL</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="c">## For launching into the debugger, add &#39;debug_here()&#39; in the code</span>
<span class="c">#from IPython.Debugger import Tracer; debug_here = Tracer()</span>

<div class="viewcode-block" id="SiteArray"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteArray">[docs]</a><span class="k">class</span> <span class="nc">SiteArray</span><span class="p">(</span><span class="n">hop</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">Saveable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class to implement containers that hold observables from a trajectory. </span>

<span class="sd">    The base class is not useful on its own and must be derived from.</span>

<span class="sd">    :API: </span>

<span class="sd">    Subclasses should define at least the following so that the plot functions work:</span>

<span class="sd">      self._data         #  numpy.array with sites on axis=0 (including &#39;rubbish&#39; rows etc)</span>
<span class="sd">      self.data          #  typically a view on _data; the data that makes sense to the user</span>
<span class="sd">      self.distribution  # a &#39;normalized&#39; version of the data (probably only sensible for histograms)</span>

<span class="sd">    See comments in __init__ about self.site2indx on indexing in self._data.</span>

<span class="sd">    Subclasses must call the super init at the start of their own __init__():</span>

<span class="sd">        super(cls,self).__init__(name,sites,maxsites,parameters,properties=properties,**kwargs)</span>

<span class="sd">    The following methods must be defined:</span>

<span class="sd">       add()        Add data from a time step.</span>
<span class="sd">       reset()      Clear all data and be ready to acquire new data with the next add() call.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_saved_attributes</span> <span class="o">=</span> <span class="s">&#39;all&#39;</span>
    <span class="n">default_plotproperties</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;xlabel&#39;</span><span class="p">:</span><span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="s">&#39;ylabel&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span>
                              <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="s">&quot;Site-resolved distributions&quot;</span><span class="p">,</span>
                              <span class="s">&#39;legend_fontsize&#39;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> 
                              <span class="s">&#39;xticks_indexed&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span> 
                              <span class="s">&#39;im_yticks_site&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span> <span class="s">&#39;im_yticks_fontsize&#39;</span><span class="p">:</span><span class="mi">6</span> <span class="c"># imshow</span>
                              <span class="p">}</span>  <span class="c"># can be changed by subclasses and properties argument</span>
    <span class="n">fixed_plotproperties</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c"># cannot be changed by subclasses</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c">## super(SiteArray,self).__init__(*args,**kwargs) # TODO: Saveable does not work this way yet!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>          <span class="c"># TODO: change this crap to keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sites</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxsites</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Nsites</span> <span class="o">=</span> <span class="n">Nsites</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">)</span>

        <span class="c"># Setting up the translation table &#39;site --&gt; index in array&#39;:</span>
        <span class="c">#   self.site2indx[]</span>
        <span class="c"># Lookup table for the index in the results data array corresponding to a</span>
        <span class="c"># site label (=the number stored in the hopping trajectory and the hopping graph)</span>
        <span class="c"># IMPORTANT: site labels that are NOT in &lt;sites&gt; point to the index &#39;Nsites&#39; and</span>
        <span class="c"># we add one additional data row = Nsites into which all data are dumped</span>
        <span class="c"># that are not selected; this allows for more efficient, vectorized array access;</span>
        <span class="c"># see longer comment in SiteHistogramArray.__init__().</span>
        <span class="n">site2indx</span> <span class="o">=</span> <span class="n">Nsites</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxsites</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>  <span class="c"># initialize to Nsites      </span>
        <span class="n">site2indx</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Nsites</span><span class="p">)</span>            <span class="c"># set selected sites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">site2indx</span> <span class="o">=</span> <span class="n">site2indx</span>    <span class="c"># maps site label to its array row (=indx)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indx2site</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span>   <span class="c"># &lt;-- without uncollected site array aindx=Nsites</span>

        <span class="c"># properties: customization of plots etc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_plotproperties</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">arg_properties</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;properties&#39;</span><span class="p">,{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">arg_properties</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixed_plotproperties</span><span class="p">)</span>

        <span class="c"># specialized setup must be done in subclasses, in particular self._data</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="SiteArray.mean"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteArray.mean">[docs]</a>    <span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mean for each site.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SiteArray.std"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteArray.std">[docs]</a>    <span class="k">def</span> <span class="nf">std</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Standard deviation for each site.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SiteArray.mean_std"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteArray.mean_std">[docs]</a>    <span class="k">def</span> <span class="nf">mean_std</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Returns site labels, mean, and standard deviation for each site.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="SiteArray.plot"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteArray.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">sites</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="s">&#39;pdf&#39;</span><span class="p">,</span><span class="n">with_legend</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
             <span class="n">use_midpoints</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">step</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the distribution(s) or histogram(s) for sites.</span>
<span class="sd">        </span>
<span class="sd">        :Arguments:</span>
<span class="sd">        filename      write to file filename; suffix determines type</span>
<span class="sd">        sites         site label or list of site labels; if None then all</span>
<span class="sd">                      collected sites are plotted.</span>
<span class="sd">        normalize     True: distribution; False: histogram</span>
<span class="sd">        format        determine output format if filename is derived from the</span>
<span class="sd">                      default filename</span>
<span class="sd">        with_legend   True | False</span>
<span class="sd">        use_midpoints True: plot distribution at midpoints of histogram bins</span>
<span class="sd">                      False: plot at lower edge</span>
<span class="sd">        step          plot only every &lt;step&gt; datapoints (along x); None: auto</span>

<span class="sd">        :Limitations:</span>
<span class="sd">        * sites must be a list of integers and a subset of Collection.sites.</span>
<span class="sd">          It would be nice if one could use the same selection syntax as for</span>
<span class="sd">          the constructor (which is just passed on to</span>
<span class="sd">          Density.site_labels()). The reason why this is not implemented in</span>
<span class="sd">          plot is because when loading from a pickled file the density is not</span>
<span class="sd">          available and neither is the site_labels() method.</span>
<span class="sd">        * The legend overflows with many sites; it should also show the</span>
<span class="sd">          equivalence site name if there is one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pylab</span>
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="c"># sanity check</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">site2indx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">raise</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">raise</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;No normalized data available, try normalize=False.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">hop</span><span class="o">.</span><span class="n">MissingDataError</span><span class="p">(</span><span class="s">&quot;Cannot plot histograms because data are missing. Run compute() first.&quot;</span><span class="p">)</span>

        <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoset_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,::</span><span class="n">step</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">sites</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> 
            <span class="n">sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span>            
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">iterable</span><span class="p">(</span><span class="n">sites</span><span class="p">):</span> 
            <span class="n">sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">sites</span><span class="p">]</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">use_midpoints</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">midpoints</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">site2indx</span><span class="p">[</span><span class="n">s</span><span class="p">]],</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
                     <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">missing_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">]</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;No data for sites &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">missing_sites</span><span class="p">)</span><span class="o">+</span>
                             <span class="s">&quot; (probably they need to be included in SiteAnalysis(sites=...) first.&quot;</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;xlabel&#39;</span><span class="p">])</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">with_legend</span><span class="p">:</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="n">pylab</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">font_manager</span><span class="o">.</span><span class="n">FontProperties</span><span class="p">(</span>
                    <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;legend_fontsize&#39;</span><span class="p">]))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="n">format</span><span class="p">,</span><span class="n">use_my_ext</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="n">msg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="s">&quot;Saved figure to </span><span class="si">%s</span><span class="s">.</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">fig</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">msg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;Cannot save figure without a filename.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SiteArray.imshow"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteArray.imshow">[docs]</a>    <span class="k">def</span> <span class="nf">imshow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">sites</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="s">&#39;pdf&#39;</span><span class="p">,</span><span class="n">step</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the distribution(s) or histogram(s) for sites as color grid.</span>
<span class="sd">        </span>
<span class="sd">        :Arguments:</span>
<span class="sd">        filename      write to file filename; suffix determines type</span>
<span class="sd">        sites         site label or list of site labels; if None then all</span>
<span class="sd">                      collected sites are plotted.</span>
<span class="sd">        normalize     True: distribution; False: histogram</span>
<span class="sd">        format        determine output format if filename is derived from the</span>
<span class="sd">                      default filename</span>
<span class="sd">        step          plot only every &lt;step&gt; datapoints (along x); None: auto</span>
<span class="sd">        **kwargs      keyword arguments are passed directly to pylab.imshow()</span>

<span class="sd">        :Limitations:</span>
<span class="sd">        * sites must be a list of integers and a subset of Collection.sites.</span>
<span class="sd">          It would be nice if one could use the same selection syntax as for</span>
<span class="sd">          the constructor (which is just passe on to</span>
<span class="sd">          Density.site_labels()). The reason why this is not implemented in</span>
<span class="sd">          plot because when loading from a pickled file the density is not</span>
<span class="sd">          available and neither is the site_labels() method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pylab</span>
        <span class="c"># kwargs are passed to pylab.imshow():</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;aspect&#39;</span><span class="p">,</span><span class="s">&#39;auto&#39;</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;interpolation&#39;</span><span class="p">,</span><span class="s">&#39;nearest&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;vmin&#39;</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;vmax&#39;</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="c"># sanity check</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">site2indx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">raise</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">raise</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">hop</span><span class="o">.</span><span class="n">MissingDataError</span><span class="p">(</span><span class="s">&quot;Cannot plot histograms because data are missing. Run compute() first.&quot;</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoset_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,::</span><span class="n">step</span><span class="p">]</span>

        <span class="c"># sites list: note that sites[row] is the proper label of this row in the image</span>
        <span class="k">if</span> <span class="n">sites</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> 
            <span class="n">sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">iterable</span><span class="p">(</span><span class="n">sites</span><span class="p">):</span> 
            <span class="n">sites</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sites</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sites</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span>
        <span class="n">xdelta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">shifted_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">xdelta</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">site2indx</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">]],</span>
                               <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">shifted_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shifted_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">sites</span><span class="p">),</span><span class="mi">0</span><span class="p">),</span>
                               <span class="n">origin</span><span class="o">=</span><span class="s">&#39;upper&#39;</span><span class="p">,</span>
                               <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">missing_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">]</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;No data for sites &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">missing_sites</span><span class="p">)</span><span class="o">+</span>
                             <span class="s">&quot; (probably they need to be included in SiteAnalysis(sites=...) first.&quot;</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_axes</span><span class="p">()</span>        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;xticks_indexed&#39;</span><span class="p">]:</span>
            <span class="n">xintegerLocator</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">IndexLocator</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">offset</span><span class="o">=-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">xdelta</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">xintegerLocator</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;im_yticks_site&#39;</span><span class="p">]:</span>
            <span class="n">_sites_as_str</span><span class="o">=</span><span class="n">sites</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;|S10&#39;</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">_idx2site</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pos</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">_sites_as_str</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s">&#39;&#39;</span>
            <span class="n">idx2siteFormatter</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="n">_idx2site</span><span class="p">)</span>
            <span class="n">yintegerLocator</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">IndexLocator</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">offset</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">yintegerLocator</span><span class="p">)</span>  <span class="c"># have sep. locs for diff axes (y and x)!</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">idx2siteFormatter</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_ticklabels</span><span class="p">():</span>
                <span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;im_yticks_fontsize&#39;</span><span class="p">])</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;site label&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;ylabel&#39;</span><span class="p">])</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;xlabel&#39;</span><span class="p">])</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">])</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">draw_if_interactive</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="n">format</span><span class="p">,</span><span class="n">use_my_ext</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="n">msg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="s">&quot;Saved figure to </span><span class="si">%s</span><span class="s">.</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">fig</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">msg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;Cannot save figure without a filename.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">autoset_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">step</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">step</span>
        <span class="n">maxwidth</span> <span class="o">=</span> <span class="mi">800</span>               <span class="c"># plot graphs up to &lt;maxwidth&gt; pixels wide</span>
        <span class="n">ndata</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ndata</span> <span class="o">&gt;</span> <span class="n">maxwidth</span><span class="p">:</span>         <span class="c"># autoset step</span>
            <span class="n">step</span> <span class="o">=</span> <span class="n">ndata</span><span class="o">/</span><span class="n">maxwidth</span>
            <span class="n">msg</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="s">&#39;Auto-set step to </span><span class="si">%(step)d</span><span class="s">.</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">locals</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">step</span>

</div>
<div class="viewcode-block" id="SiteTrajectoryArray"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteTrajectoryArray">[docs]</a><span class="k">class</span> <span class="nc">SiteTrajectoryArray</span><span class="p">(</span><span class="n">SiteArray</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The whole trajectory, split by site.</span>

<span class="sd">    Organized as one BIG numpy array. The first axis correponds to the site</span>
<span class="sd">    index, the second axis corresponds to the frames. Note that the array is</span>
<span class="sd">    kept in memory. If the trajectory is long and/or many atoms have been</span>
<span class="sd">    selected then the machine may crash due to insufficient memory.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fixed_plotproperties</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;xlabel&#39;</span><span class="p">:</span><span class="s">r&quot;time $t$/ps&quot;</span><span class="p">,</span>
                            <span class="s">&#39;xticks_indexed&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span> 
                            <span class="p">}</span>
    <span class="n">_excluded_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;_next_frame_number&#39;</span><span class="p">]</span>   <span class="c"># hack for Saveable</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">sites</span><span class="p">,</span><span class="n">maxsites</span><span class="p">,</span><span class="n">parameters</span><span class="p">,</span><span class="n">properties</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the SiteTrajectoryArray.</span>

<span class="sd">        A = SiteTrajectoryArray(sites,maxsites,properties=dict(n_frames=&lt;int&gt;))</span>

<span class="sd">        :Arguments:</span>
<span class="sd">        name           name of the observable</span>
<span class="sd">        sites          list of all site labels</span>
<span class="sd">        maxsites       highest site label encountered in the trajectory</span>
<span class="sd">        parameters     dict(n_frames=&lt;number of frames that are going to be saved&gt;,</span>
<span class="sd">                            totaltime=&lt;length of trajectory&gt;,</span>
<span class="sd">                            delta_t=&lt;length of one frame&gt;)</span>
<span class="sd">        properties     dict to customize the plot (xlabel, legend_fontsize, ...).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SiteTrajectoryArray</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">sites</span><span class="p">,</span><span class="n">maxsites</span><span class="p">,</span><span class="n">parameters</span><span class="p">,</span>
                                                 <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span>
                                                 <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s">&#39;n_frames&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">totaltime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s">&#39;totaltime&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s">&#39;delta_t&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="c"># only edges makes really sense</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">midpoints</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>    <span class="c"># but for compatibility...</span>

        <span class="c"># allocate array (with one additional row to dump data from not-selected sites)</span>
        <span class="n">msg</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="s">&#39;SiteTrajectoryArray.__init__(): &#39;</span>
            <span class="s">&#39;Allocating float data array of size </span><span class="si">%d</span><span class="s"> x </span><span class="si">%d</span><span class="s"> [</span><span class="si">%.1f</span><span class="s"> MiB]&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nsites</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nsites</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span><span class="o">*</span><span class="mf">32.0</span><span class="o">/</span><span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Nsites</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="c"># keep track of frame number internally</span>
        <span class="c"># TODO: This makes save() fail (need to filter type(&#39;method-wrapper&#39;))</span>
        <span class="c"># (put this into _excluded_attributes[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_frame_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frame_number_generator</span><span class="p">()</span><span class="o">.</span><span class="n">next</span>

    <span class="k">def</span> <span class="nf">_frame_number_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Supply a new frame number for each call of add().&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">i</span>

<div class="viewcode-block" id="SiteTrajectoryArray.add"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteTrajectoryArray.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">site_data</span><span class="p">,</span><span class="n">sites</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add one frame of data to the site trajectory.</span>

<span class="sd">        site_data     numpy array; axis=0 indexes the sites</span>
<span class="sd">                      For scalars, site_data.shape == (N,), with N == len(sites)</span>
<span class="sd">                      For vectors, site_data.shape == (N,3).</span>
<span class="sd">        sites         numpy array of the site labels that correspond to the slices </span>
<span class="sd">                      along axis=0 in site_data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">site_data</span><span class="p">),</span> <span class="s">&quot;incompatible sites and site_data&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># self.site2indx[sites] adds any data for not-selected sites to the &#39;rubbish&#39; row</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">site2indx</span><span class="p">[</span><span class="n">sites</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_next_frame_number</span><span class="p">()]</span> <span class="o">=</span> <span class="n">site_data</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Trying to read more frames than specified in n_frames=</span><span class="si">%d</span><span class="s">. &quot;</span>
                               <span class="s">&quot;You need to &#39;reset()&#39; the observable &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> 
                               <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="c">#debug_here()</span>
</div>
<div class="viewcode-block" id="SiteTrajectoryArray.reset"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteTrajectoryArray.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Erases all accumulated data and restarts the frame counter.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">*=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_frame_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frame_number_generator</span><span class="p">()</span><span class="o">.</span><span class="n">next</span>
</div>
<div class="viewcode-block" id="SiteTrajectoryArray.autocorrelation"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteTrajectoryArray.autocorrelation">[docs]</a>    <span class="k">def</span> <span class="nf">autocorrelation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">stop</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">step</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculates the auto correlation function for all site trajectories.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">hop.utilities</span> <span class="kn">import</span> <span class="n">autocorrelation_fft</span> <span class="k">as</span> <span class="n">ACF</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ACF</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">traj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">step</span><span class="p">]])</span>
</div>
<div class="viewcode-block" id="SiteTrajectoryArray.averaged_autocorrelation"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteTrajectoryArray.averaged_autocorrelation">[docs]</a>    <span class="k">def</span> <span class="nf">averaged_autocorrelation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">step</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculates the ACF or each site by resampling from the whole trajectory.</span>

<span class="sd">        mean(acf), standardev(acf) = averaged_autocorrelation(**kwargs)</span>

<span class="sd">        :Arguments:</span>
<span class="sd">        step            only take every &lt;step&gt; from the trajectory (None == 1)</span>
<span class="sd">                        ??? step &gt; 1 seems to take LONGER ???</span>
<span class="sd">        length          length (in frames) of the ACF (default: 1/2*len(series))</span>
<span class="sd">        sliding_window  repeat ACF calculation every N frames (default: len(series)/100)</span>

<span class="sd">        :Returns:</span>
<span class="sd">        mean_acf        average over all resampled acfs per site,  shape = (Nsites,length)</span>
<span class="sd">        std_acf         standard deviation or the resampled acfs,  shape = (Nsites,length)</span>

<span class="sd">        See also for kwargs:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">hop.utilities</span> <span class="kn">import</span> <span class="n">averaged_autocorrelation</span> <span class="k">as</span> <span class="n">avACF</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">avACF</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">traj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,::</span><span class="n">step</span><span class="p">]])</span>  <span class="c"># [(mean,std),...]</span>
        <span class="k">return</span> <span class="n">tmp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>

    <span class="c">#averaged_autocorrelation.func_doc += hop.utilities.averaged_autocorrelation.func_doc</span>
</div>
    <span class="k">def</span> <span class="nf">_calculate_normalization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Normalize each site to its highest value.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalization</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c"># does not include rubbish rows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalization</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">normalization</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c"># fix for normalization of empty rows</span>

<div class="viewcode-block" id="SiteTrajectoryArray.distribution"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteTrajectoryArray.distribution">[docs]</a>    <span class="k">def</span> <span class="nf">distribution</span><span class="p">():</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;Numpy array of the trajectory, with each site normalized by its maximum value.&quot;&quot;&quot;</span>
        <span class="c"># implement as computed attribute to save memory for large trajectories</span>
        <span class="k">def</span> <span class="nf">fget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalization</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_normalization</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">normalization</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span></div>
    <span class="n">distribution</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="o">**</span><span class="n">distribution</span><span class="p">())</span>

<div class="viewcode-block" id="SiteTrajectoryArray.trajectory"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteTrajectoryArray.trajectory">[docs]</a>    <span class="k">def</span> <span class="nf">trajectory</span><span class="p">():</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;Numpy array with N sites on axis 0 and n_frames values on axis 1&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">fget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">def</span> <span class="nf">fset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span></div>
    <span class="n">trajectory</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="o">**</span><span class="n">trajectory</span><span class="p">())</span>

<div class="viewcode-block" id="SiteTrajectoryArray.site_trajectory"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteTrajectoryArray.site_trajectory">[docs]</a>    <span class="k">def</span> <span class="nf">site_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sites</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns numpy array with N sites on axis 0 and n_frames values on axis 1; indexed by the site label&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">site2indx</span><span class="p">[</span><span class="n">sites</span><span class="p">]]</span>
</div>
<div class="viewcode-block" id="SiteTrajectoryArray.site_distribution"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteTrajectoryArray.site_distribution">[docs]</a>    <span class="k">def</span> <span class="nf">site_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sites</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the distributions for the array &lt;sites&gt;.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">site2indx</span><span class="p">[</span><span class="n">sites</span><span class="p">]]</span>

    <span class="c"># interface to the super class:</span></div>
    <span class="n">data</span> <span class="o">=</span> <span class="n">trajectory</span>
    <span class="n">site_data</span> <span class="o">=</span> <span class="n">site_trajectory</span>
</div>
<div class="viewcode-block" id="SiteHistogramArray"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteHistogramArray">[docs]</a><span class="k">class</span> <span class="nc">SiteHistogramArray</span><span class="p">(</span><span class="n">SiteArray</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A collection of histograms (or distributions), one for each site.</span>

<span class="sd">    Organized as a big numpy array. The first axis corresponds to the site</span>
<span class="sd">    index, the second axis contains the bins. The first and the last bin</span>
<span class="sd">    contain counts for data below and above the first (lo_bin) and last bin</span>
<span class="sd">    edge (hi_bin).</span>

<span class="sd">    :Methods:</span>
<span class="sd">    normalize()    create the distribution</span>
<span class="sd">    plot()         plot the distribution</span>
<span class="sd">    save()         save to a pickled file</span>
<span class="sd">    load()         load from a pickled file</span>

<span class="sd">    :Attributes:</span>

<span class="sd">    Arrays are 0-indexed and correspond to the sites. In order to access data</span>
<span class="sd">    with the site label s use SiteAnalysis.site2indx[s] as the index.</span>

<span class="sd">    histogram      the histograms as one array of shape (Nsites,Nbins), i.e. histogram[k]</span>
<span class="sd">                   is the k-th histogram. NOTE: to get the histogram of site s use</span>
<span class="sd">                   histogram[SiteAnalysis.site2indx[s]]</span>
<span class="sd">    distribution   normalized histogram, created with normalize()</span>
<span class="sd">    normalization  total number of counts for the sites</span>
<span class="sd">    edges          bin edges</span>
<span class="sd">    midpoints      bin centers </span>
<span class="sd">    delta          bin sizes</span>
<span class="sd">    site2indx      mapping of site label to an index used in all the arrays</span>
<span class="sd">    sites          mapping of index to site label</span>
<span class="sd">    &quot;&quot;&quot;</span>
        
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">sites</span><span class="p">,</span><span class="n">maxsites</span><span class="p">,</span><span class="n">parameters</span><span class="p">,</span><span class="n">properties</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the SiteHistogramArray.</span>

<span class="sd">        H = SiteHistogramArray(name,sites,maxsites,</span>
<span class="sd">                               parameters=dict(Nbins=&lt;int&gt;,lo_bin=&lt;float&gt;,hi_bin=&lt;float&gt;),</span>
<span class="sd">                               properties=&lt;dict&gt;)</span>

<span class="sd">        :Arguments:</span>
<span class="sd">        sites          list of all site labels</span>
<span class="sd">        maxsites       highest site label encountered in the trajectory</span>
<span class="sd">        parameters     dict of</span>
<span class="sd">                         Nbins          number of bins</span>
<span class="sd">                         lo_bin         lower edge of first bin</span>
<span class="sd">                         hi_bin         upper edge of last bin</span>
<span class="sd">        properties     dict to customize the plot (xlabel, legend_fontsize, ...).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SiteHistogramArray</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">sites</span><span class="p">,</span><span class="n">maxsites</span><span class="p">,</span><span class="n">parameters</span><span class="p">,</span>
                                                <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span>
                                                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c"># packaged as a dict for a cleaner interface</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Nbins</span><span class="p">,</span><span class="n">lo_bin</span><span class="p">,</span><span class="n">hi_bin</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s">&#39;Nbins&#39;</span><span class="p">],</span><span class="n">parameters</span><span class="p">[</span><span class="s">&#39;lo_bin&#39;</span><span class="p">],</span><span class="n">parameters</span><span class="p">[</span><span class="s">&#39;hi_bin&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;parameters must be a dict containing Nbins, lo_bin, hi_bin&#39;</span><span class="p">)</span>

        <span class="c"># +1 histogram for all sites not collected (idx=Nsites),+2 bins (0 and</span>
        <span class="c"># Nbins+1) for outliers. Uses array instead of dict (wastes space but</span>
        <span class="c"># allows direct indexing, eg &#39;site2indx[sites]&#39;; excluded sites index</span>
        <span class="c"># into the &#39;overflow&#39; histogram idx=Nsites); unfortunatley, because the</span>
        <span class="c"># site label is used as the index into the array, we need to make the</span>
        <span class="c"># array big enough to encompass ALL site labels that could come up in</span>
        <span class="c"># the trajectory (maxsites). This small memory waste allows us to do fast </span>
        <span class="c"># lookup calculations on whole numpy arrays instead of using slow loops on dicts.</span>

        <span class="c"># All Nsites histograms have the same bins; have to add an extra edge</span>
        <span class="c"># (for digitize), assuming that all bins have the same width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bins</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lo_bin</span><span class="p">,</span><span class="n">hi_bin</span><span class="p">,</span><span class="n">Nbins</span><span class="p">,</span><span class="n">endpoint</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>  <span class="c"># same as in numpy.histogram</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]]))</span> <span class="c"># for digitize()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">midpoints</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c"># _histogram holds the raw data. axis 0 = sites, axis 1 = bins</span>
        <span class="c"># i = site2indx[s] --&gt; indexes site s into _histogram[i,:]</span>
        <span class="c"># s = sites[i]      --&gt; index i in histogram corresponds to site s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_histogram</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Nsites</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nbins</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="c"># outlier sites&amp;values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Nsites</span><span class="p">,</span> <span class="n">Nbins</span><span class="p">))</span>             <span class="c"># normalized,no outliers</span>

<div class="viewcode-block" id="SiteHistogramArray.reset"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteHistogramArray.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Erases all accumulated data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_histogram</span> <span class="o">*=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">*=</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="SiteHistogramArray.digitize"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteHistogramArray.digitize">[docs]</a>    <span class="k">def</span> <span class="nf">digitize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">site_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the bin for each value X(site).&quot;&quot;&quot;</span>
        <span class="c"># NOTE: site_data[] contains a single value per site</span>
        <span class="c"># (Perhaps should accumulate and digitize larger lists?  E.g. use a</span>
        <span class="c"># buffer array and once one row fills up, accumulate the histograms;</span>
        <span class="c"># this _might_ allow for more efficient histogramming.)</span>
        <span class="k">return</span> <span class="p">[</span> <span class="n">numpy</span><span class="o">.</span><span class="n">digitize</span><span class="p">([</span><span class="n">x</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">site_data</span> <span class="p">]</span>  <span class="c"># too slow? use buffer?</span>
</div>
<div class="viewcode-block" id="SiteHistogramArray.add"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteHistogramArray.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">site_data</span><span class="p">,</span><span class="n">sites</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add one frame of data to the site histogram.</span>

<span class="sd">        site_data     numpy array; axis=0 indexes the sites</span>
<span class="sd">                      For scalars, site_data.shape == (N,), with N == len(sites)</span>
<span class="sd">                      For vectors, site_data.shape == (N,3).</span>
<span class="sd">        sites         numpy array of the site labels that correspond to the slices </span>
<span class="sd">                      along axis=0 in site_data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># For each site in sites, add +1 to the bin corresponding to site_data[site].</span>
        <span class="c"># sites and site_data must have the same shape, i.e. (len(sites),)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_histogram</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">site2indx</span><span class="p">[</span><span class="n">sites</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">site_data</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
    </div>
<div class="viewcode-block" id="SiteHistogramArray.normalize"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteHistogramArray.normalize">[docs]</a>    <span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate normalization (including outliers) and distribution.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalization</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_histogram</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c"># includes outliers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalization</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">normalization</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c"># fix for normalization of empty histos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">histogram</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalization</span><span class="p">[:,</span><span class="n">numpy</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SiteHistogramArray.histogram"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteHistogramArray.histogram">[docs]</a>    <span class="k">def</span> <span class="nf">histogram</span><span class="p">():</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;Numpy array with N sites on axis 0 and Nbin bins on axis 1 (view on _histogram)&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">fget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_histogram</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">def</span> <span class="nf">fset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_histogram</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span></div>
    <span class="n">histogram</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="o">**</span><span class="n">histogram</span><span class="p">())</span>        

<div class="viewcode-block" id="SiteHistogramArray.site_histogram"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteHistogramArray.site_histogram">[docs]</a>    <span class="k">def</span> <span class="nf">site_histogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sites</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns numpy array with N sites on axis 0 and Nbin bins on axis 1; indexed by the site label&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">histogram</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">site2indx</span><span class="p">[</span><span class="n">sites</span><span class="p">]]</span>
</div>
<div class="viewcode-block" id="SiteHistogramArray.site_distribution"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteHistogramArray.site_distribution">[docs]</a>    <span class="k">def</span> <span class="nf">site_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sites</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the distributions for the array &lt;sites&gt;.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">site2indx</span><span class="p">[</span><span class="n">sites</span><span class="p">]]</span>

    <span class="c"># interface to the super class:</span></div>
    <span class="n">data</span> <span class="o">=</span> <span class="n">histogram</span>
    <span class="n">site_data</span> <span class="o">=</span> <span class="n">site_histogram</span>

<div class="viewcode-block" id="SiteHistogramArray.mean"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteHistogramArray.mean">[docs]</a>    <span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mean for each site &lt;X&gt; (first moment of distribution, &lt;X&gt; = sum x*p(x)).&quot;&quot;&quot;</span>
        <span class="c"># use self.bins instead of self.midpoints as this is arguably more correct for</span>
        <span class="c"># occupancies (and makes it consistent with occupancy from trajectory)</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SiteHistogramArray.std"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteHistogramArray.std">[docs]</a>    <span class="k">def</span> <span class="nf">std</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Standard deviation for each site sqrt(&lt;(X-&lt;X&gt;)**2&gt;), from second moment sum x**2*p(x).&quot;&quot;&quot;</span>
        <span class="n">EX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">EXX</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">EXX</span> <span class="o">-</span> <span class="n">EX</span><span class="o">*</span><span class="n">EX</span><span class="p">)</span>
        
</div></div>
<div class="viewcode-block" id="SiteAnalysisObservable"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteAnalysisObservable">[docs]</a><span class="k">class</span> <span class="nc">SiteAnalysisObservable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class to implement &#39;plugin&#39; analysis for site-based trajectory analysis.</span>

<span class="sd">    Derive a class, register it in the global observable_registry, and use the</span>
<span class="sd">    instance in the compute() method of the Collection class.</span>

<span class="sd">    The subclasses override __init__ with the following argument list:</span>

<span class="sd">    Observable(collection, histogram_parameters, trajectory=False, **kwargs)</span>

<span class="sd">    collection            hop.siteanalysis.Collection to which the observable belongs</span>
<span class="sd">                          (uses many attributes for setup)</span>
<span class="sd">    histogram_parameters  defines bins and range of histograms</span>
<span class="sd">    trajectory            True: also collect time series of the observable, resolved </span>
<span class="sd">                                by site i: observable_i(t)</span>
<span class="sd">                          False: only compute the histograms (default)</span>
<span class="sd">    **kwargs              additional data (subclasses pick what they need)</span>

<span class="sd">    The subclass picks anything it needs from the auxiliary kwargs dict and adds it as</span>
<span class="sd">    attributes so that its own compute() method can access it; they must silently ignore</span>
<span class="sd">    anything they don&#39;t need.</span>

<span class="sd">    Also override the class-variables</span>
<span class="sd">        defaultbinwidth      (for automatic setting of Nbins)</span>
<span class="sd">        plot_properties      dict, see below</span>
<span class="sd">        name                 same name as used in hop.siteanalysis.ObservablesRegistry (IMPORTANT!!!)</span>

<span class="sd">    :Attributes:</span>
<span class="sd">    (mainly from &lt;collection&gt;)</span>

<span class="sd">    sites        selection of site labels; only on these sites histograms are built</span>
<span class="sd">    max_site     the highest site label that occurs in the trajectory</span>
<span class="sd">    idcd2ihop    translation between dcd indices to hop indices</span>
<span class="sd">                 sites[self.idcd2ihop[[2,3,5]] -&gt; sites of dcd 2,3,5 </span>
<span class="sd">    data_indices == MDAnalysis.select_atoms(...).indices() (atom indices of selected atoms)</span>
<span class="sd">    data_ts      (pointer to) the data trajectory time step instance</span>
<span class="sd">    hop_ts       (pointer to) the hop trajectory time step instance</span>

<span class="sd">    (from __init__)</span>
<span class="sd">    histogram_parameters = {&#39;Nbin&#39;: &lt;number of bins in histogram&gt;, &#39;lo_bin&#39;:&lt;&gt;, &#39;hi_bin&#39;:&lt;&gt;}</span>
<span class="sd">    plot_properties      = {&#39;xlabel&#39;: &lt;&gt;, &#39;title&#39;: &lt;&gt;, ...}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">defaultbinwidth</span> <span class="o">=</span> <span class="mf">0.5</span>    <span class="c"># set default bindwidth for each subclass</span>
    <span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>              <span class="c"># name used in ObservablesRegistry</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">collection</span><span class="p">,</span><span class="n">histogram_parameters</span><span class="p">,</span><span class="n">plot_properties</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">trajectory</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up an observable (a class describing how a histogrammed site property is computed).</span>

<span class="sd">        o = SiteAnalysisObservable(collection,histogram_parameters,plot_properties)</span>

<span class="sd">        :Arguments:</span>
<span class="sd">        collection            hop.siteanalysis.Collection instance            </span>
<span class="sd">        histogram_parameters  {&#39;Nbin&#39;: &lt;number of bins in histogram&gt;, &#39;lo_bin&#39;:&lt;float&gt;, </span>
<span class="sd">                               &#39;hi_bin&#39;:&lt;float&gt;}</span>
<span class="sd">        trajectory            False: do not set up SiteTrajectoryArray (i.e. do not store the</span>
<span class="sd">                              whole site trajectory) or True (allocate enough space to hold</span>
<span class="sd">                              the _whole_ trajectory!)</span>
<span class="sd">        plot_properties       {&#39;xlabel&#39;: &lt;string&gt;, &#39;title&#39;: &lt;string&gt;, ...}        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SiteAnalysisObservable</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>  <span class="c"># necessary for classes with super()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sites</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">siteselection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_sites</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">_all_sites</span>       <span class="c"># all &#39;default&#39; sites in the trajectory (from density)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_site</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">_all_sites</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>  <span class="c"># largest site label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idcd2ihop</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">idcd2ihop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_indices</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">data_indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_ts</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">data_ts</span>        <span class="c"># pointers to changing Timestep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hop_ts</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">hop_ts</span>

        <span class="k">if</span> <span class="n">plot_properties</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">plot_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_properties</span>  <span class="c"># self.plot_properties should be set in subclass</span>

        <span class="c"># set up site histograms</span>
        <span class="k">if</span> <span class="n">histogram_parameters</span><span class="p">[</span><span class="s">&#39;hi_bin&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">histogram_parameters</span><span class="p">[</span><span class="s">&#39;lo_bin&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;histogram parameters must be hi_bin &gt; lo_bin, but &quot;</span>
                             <span class="s">&quot;lo_bin=</span><span class="si">%(lo_bin)g</span><span class="s"> and hi_bin=</span><span class="si">%(hi_bin)g</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="n">histogram_parameters</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">histogram_parameters</span><span class="p">[</span><span class="s">&#39;Nbins&#39;</span><span class="p">]:</span>    <span class="c"># fill in default for Nbins</span>
            <span class="n">histogram_parameters</span><span class="p">[</span><span class="s">&#39;Nbins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>\
                <span class="p">(</span><span class="n">histogram_parameters</span><span class="p">[</span><span class="s">&#39;hi_bin&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">histogram_parameters</span><span class="p">[</span><span class="s">&#39;lo_bin&#39;</span><span class="p">])</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">defaultbinwidth</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">histograms</span> <span class="o">=</span> <span class="n">SiteHistogramArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">max_site</span><span class="p">,</span>
                                             <span class="n">histogram_parameters</span><span class="p">,</span>
                                             <span class="n">properties</span><span class="o">=</span><span class="n">plot_properties</span><span class="p">)</span>

        <span class="c"># set up site trajectory arrays (if requested)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_trajectories</span> <span class="o">=</span> <span class="n">trajectory</span>
        <span class="k">if</span> <span class="n">trajectory</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">collection</span><span class="o">.</span><span class="n">data_dcd</span><span class="o">.</span><span class="n">n_frames</span> <span class="o">==</span> <span class="n">collection</span><span class="o">.</span><span class="n">hop_dcd</span><span class="o">.</span><span class="n">n_frames</span>
            <span class="n">trajectory_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;n_frames&#39;</span><span class="p">:</span> <span class="n">collection</span><span class="o">.</span><span class="n">hop_dcd</span><span class="o">.</span><span class="n">n_frames</span><span class="p">,</span>
                                     <span class="s">&#39;totaltime&#39;</span><span class="p">:</span> <span class="n">hop</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">totaltime</span><span class="p">(</span><span class="n">collection</span><span class="o">.</span><span class="n">hop_dcd</span><span class="p">,</span><span class="s">&#39;ps&#39;</span><span class="p">),</span>
                                     <span class="s">&#39;delta_t&#39;</span><span class="p">:</span>   <span class="n">hop</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">delta_t</span><span class="p">(</span><span class="n">collection</span><span class="o">.</span><span class="n">hop_dcd</span><span class="p">,</span><span class="s">&#39;ps&#39;</span><span class="p">)}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span> <span class="o">=</span> <span class="n">SiteTrajectoryArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">max_site</span><span class="p">,</span><span class="n">trajectory_parameters</span><span class="p">,</span>
                                                    <span class="n">properties</span><span class="o">=</span><span class="n">plot_properties</span><span class="p">)</span>

<div class="viewcode-block" id="SiteAnalysisObservable.compute"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteAnalysisObservable.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the histograms (and trajectories) for selected sites for the given time step.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_histograms</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_trajectories</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_trajectories</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c"># may depend on values computed in build_histograms()</span>
</div>
<div class="viewcode-block" id="SiteAnalysisObservable.build_histograms"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteAnalysisObservable.build_histograms">[docs]</a>    <span class="k">def</span> <span class="nf">build_histograms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># see Orbit.build_histograms() with self._compute_distance() as an example</span>
        <span class="sd">&quot;&quot;&quot;Override this method. It must silently ignore any keyword args that it does not use.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Internal Error: The build_histograms() method of class </span><span class="si">%r</span><span class="s"> was not implemented.&quot;</span> <span class="o">%</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SiteAnalysisObservable.build_trajectories"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteAnalysisObservable.build_trajectories">[docs]</a>    <span class="k">def</span> <span class="nf">build_trajectories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override this method. It must silently ignore any keyword args that it does not use.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Internal Error: The build_trajectorie() method of class </span><span class="si">%r</span><span class="s"> was not implemented.&quot;</span> <span class="o">%</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="SiteAnalysisObservable.reset"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.SiteAnalysisObservable.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear all computed data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_histograms</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_trajectories</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">reset_histograms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">histograms</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">reset_trajectories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> <span class="k">pass</span>

    <span class="c"># utility methods:</span>
    <span class="c"># Try to avoid reallocating numpy arrays: use assignments to buffer arrays</span>
    <span class="c"># self._NAME (which are allocated in &#39;try: ... except AttributeError: ...&#39; constructs) </span>

    <span class="k">def</span> <span class="nf">_get_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">hop_pos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make selected site labels of the time step available in self._sites[]. They</span>
<span class="sd">        are arranged in the same order as the SiteHistogramArray and the</span>
<span class="sd">        SiteTrajectoryArray.&quot;&quot;&quot;</span>
        <span class="c"># (Perhaps this should be made a class variable (cache) and only computed once</span>
        <span class="c"># for ALL observables?)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># site label for each selected data atom</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sites</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">hop_pos</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">idcd2ihop</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c"># allocate for the first time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sites</span> <span class="o">=</span> <span class="n">hop_pos</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">idcd2ihop</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Distance"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.Distance">[docs]</a><span class="k">class</span> <span class="nc">Distance</span><span class="p">(</span><span class="n">SiteAnalysisObservable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Observable: distance of atom from the centre of a site while on the site.</span>

<span class="sd">    o = Distance(Collection,histogram_parameters,site_centers=site_centers)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">defaultbinwidth</span> <span class="o">=</span> <span class="mf">0.1</span>   <span class="c"># 0.1 A because distance is typically 0 &lt;= d &lt; 4 A</span>
    <span class="n">plot_properties</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;xlabel&#39;</span><span class="p">:</span><span class="s">&quot;distance [Angstrom]&quot;</span><span class="p">,</span><span class="s">&#39;title&#39;</span><span class="p">:</span><span class="s">&quot;Distance from site&quot;</span><span class="p">}</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;distance&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Distance</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_site_centers</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;density&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">build_histograms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_distance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hop_ts</span><span class="o">.</span><span class="n">_x</span><span class="p">)</span>  <span class="c"># use instantaneous site s(t)</span>

    <span class="k">def</span> <span class="nf">build_trajectories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># TODO: Must reduce data for site, eg average, max, min, median, ...</span>
        <span class="c"># THIS IS WRONG (just chooses one of the values)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Current implementation of distance site traj is broken.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dist</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_sites</span><span class="p">)</span>

    <span class="c"># auxiliary functions that can be directly used by subclasses</span>
    <span class="c"># (_compute_distance() shows an example implementation of build_histograms() )</span>
    <span class="k">def</span> <span class="nf">_compute_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">hop_pos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Accumulate site histograms for distance site--coord.</span>

<span class="sd">        pos          sites from the hopping trajectory</span>

<span class="sd">        Uses self.site_centers centers of all sites (i.e. site_properties.center)) </span>
<span class="sd">        which must be initialized with _init_site_centers(density).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># allocate arrays when needed (but only once so that we can use fast assignment)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_sites</span><span class="p">(</span><span class="n">hop_pos</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_distvec</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_centers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_sites</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_ts</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_indices</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_distvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_centers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_sites</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_ts</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_indices</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">,</span><span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s">&quot;Encountered a site in the hop trajectory that was not listed &quot;</span>
                             <span class="s">&quot;in the density (&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;). Check the consistency of the &quot;</span>
                             <span class="s">&quot;input data.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dist</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distvec</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">distvec</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="c"># observable</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dist</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_distvec</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_distvec</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="c"># observable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">histograms</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dist</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_sites</span><span class="p">)</span>           <span class="c"># accumulate in histograms for each site</span>

    <span class="k">def</span> <span class="nf">_init_site_centers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">density</span><span class="p">):</span>
        <span class="c"># site centers: reformat array: </span>
        <span class="c"># (1) 2D array, (2) [NaN,NaN,NaN] instead of None</span>
        <span class="n">site_centers</span> <span class="o">=</span> <span class="n">density</span><span class="o">.</span><span class="n">site_properties</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">site_centers</span><span class="p">[</span><span class="n">SITELABEL</span><span class="p">[</span><span class="s">&#39;interstitial&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">NaN</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">site_centers</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">site_centers</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>  <span class="c"># shape == (num_sites,3)</span>
</div>
<div class="viewcode-block" id="Orbit"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.Orbit">[docs]</a><span class="k">class</span> <span class="nc">Orbit</span><span class="p">(</span><span class="n">Distance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Observable: distance of atom from the centre of the site while orbiting the site.</span>

<span class="sd">    o = Orbit(Collection,histogram_parameters,site_centers=site_centers)</span>

<span class="sd">    (A particle orbits a site if it has been on the site at a previous time step but has </span>
<span class="sd">    not entered another site since.)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">defaultbinwidth</span> <span class="o">=</span> <span class="mf">0.2</span>    <span class="c"># A, typical ranges for orbit 0 &lt;= o &lt; 15 A</span>
    <span class="n">plot_properties</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;xlabel&#39;</span><span class="p">:</span><span class="s">&quot;distance [Angstrom]&quot;</span><span class="p">,</span>
                       <span class="s">&#39;title&#39;</span><span class="p">:</span><span class="s">&quot;Site orbit&quot;</span><span class="p">,</span>
                       <span class="p">}</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;orbit&quot;</span>

    <span class="k">def</span> <span class="nf">build_histograms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_distance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hop_ts</span><span class="o">.</span><span class="n">_y</span><span class="p">)</span>  <span class="c"># use orbit o(t) from hoptraj</span>
</div>
<div class="viewcode-block" id="Occupancy"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.Occupancy">[docs]</a><span class="k">class</span> <span class="nc">Occupancy</span><span class="p">(</span><span class="n">SiteAnalysisObservable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Observable: occupancy (number of particles on the site).</span>

<span class="sd">    o = Occupancy(Collection,histogram_parameters,trajectory=False)</span>

<span class="sd">    histogram_parameters    dict with lo_bin, hi_bin, [Nbins]</span>
<span class="sd">    trajectory              True: also extract the site occupancy as a function of</span>
<span class="sd">                                  time (or frame), s_i(t)</span>
<span class="sd">                            False: only do the histogram</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">defaultbinwidth</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c"># one bin for each particle per site (only integers)</span>
    <span class="c">#plot_properties = {&#39;xlabel&#39;:r&quot;$\nu_\mathrm{site}$&quot;,&#39;title&#39;:&quot;Site occupancy distribution&quot;}</span>
    <span class="n">plot_properties</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;xlabel&#39;</span><span class="p">:</span><span class="s">r&quot;$\nu$&quot;</span><span class="p">,</span>
                       <span class="s">&#39;title&#39;</span><span class="p">:</span><span class="s">&quot;Site occupancy distribution&quot;</span><span class="p">,</span>
                       <span class="s">&#39;xticks_indexed&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;occupancy&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Occupancy</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c"># quick and dirty: histogram on ALL sites</span>
        <span class="c"># Add one additional bin at the higher end which holds the outliers at the upper</span>
        <span class="c"># end; the ones at the lower end are automatically discarded</span>
        <span class="n">hmin</span><span class="p">,</span> <span class="n">hmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_sites</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_sites</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bins</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">hmin</span><span class="p">,</span><span class="n">hmax</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="n">hmax</span><span class="o">-</span><span class="n">hmin</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">endpoint</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c"># histogrammed_sites[]: index in bins --&gt; site label (includes unselected sites!)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">histogrammed_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bins</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c"># remove last bin = outliers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_histo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occupancy_histogram</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>  <span class="c"># initialize histogram</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_histo</span> <span class="o">*=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_occupancy_histogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the histogram with the outlier bin discarded.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_bins</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_compute_occupancy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">hop_pos</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_sites</span><span class="p">(</span><span class="n">hop_pos</span><span class="p">)</span>   <span class="c"># --&gt; self._sites</span>
        <span class="c"># X(s) where s: selected site, X: number of particles on site</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_histo</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occupancy_histogram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sites</span><span class="p">)</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">histograms</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_histo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">histogrammed_sites</span><span class="p">)</span>    <span class="c"># accumulate in histograms for each site</span>

    <span class="k">def</span> <span class="nf">build_histograms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_occupancy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hop_ts</span><span class="o">.</span><span class="n">_x</span><span class="p">)</span>  <span class="c"># x: occ, y: orbit_occup</span>

    <span class="k">def</span> <span class="nf">build_trajectories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># Make sure that this runs AFTER build_histograms(): needs _histo!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_histo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">histogrammed_sites</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="OrbitOccupancy"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.OrbitOccupancy">[docs]</a><span class="k">class</span> <span class="nc">OrbitOccupancy</span><span class="p">(</span><span class="n">Occupancy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Observable: occupancy, based on orbit.</span>

<span class="sd">    o = OrbitOccupancy(Collection,histogram_parameters)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c">#plot_properties = {&#39;xlabel&#39;:r&quot;$\nu_\mathrm{site}$&quot;,&#39;title&#39;:&quot;Site orbit occupancy distribution&quot;}</span>
    <span class="n">plot_properties</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;xlabel&#39;</span><span class="p">:</span><span class="s">r&quot;$\nu$&quot;</span><span class="p">,</span><span class="s">&#39;title&#39;</span><span class="p">:</span><span class="s">&quot;Site orbit occupancy distribution&quot;</span><span class="p">}</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;orbitoccupancy&quot;</span>

    <span class="k">def</span> <span class="nf">build_histograms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_occupancy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hop_ts</span><span class="o">.</span><span class="n">_y</span><span class="p">)</span>  <span class="c"># x: occ, y: orbit_occup</span>
    

<span class="c"># dict of SiteAnalysisObservable classes</span></div>
<span class="n">ObservablesRegistry</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;distance&#39;</span><span class="p">:</span><span class="n">Distance</span><span class="p">,</span> 
                       <span class="s">&#39;orbit&#39;</span><span class="p">:</span><span class="n">Orbit</span><span class="p">,</span> 
                       <span class="s">&#39;occupancy&#39;</span><span class="p">:</span><span class="n">Occupancy</span><span class="p">,</span>
                       <span class="s">&#39;orbitoccupancy&#39;</span><span class="p">:</span><span class="n">OrbitOccupancy</span><span class="p">,</span>
                       <span class="p">}</span>

<div class="viewcode-block" id="Collection"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.Collection">[docs]</a><span class="k">class</span> <span class="nc">Collection</span><span class="p">(</span><span class="n">hop</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">Saveable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A Collection of observables to be calculated for a hopping trajectory.</span>
<span class="sd">    (the central object of the siteanalysis module)</span>

<span class="sd">      C = Collection(...)</span>
<span class="sd">      C.add_observable(...)</span>
<span class="sd">      C.add_observable(...)</span>
<span class="sd">      ...</span>
<span class="sd">      C.compute()</span>
<span class="sd">      C.plot()</span>

<span class="sd">    The general outline is:</span>

<span class="sd">    (1) Load dcd with selection that contains the atoms in the hopping</span>
<span class="sd">    trajectory. Note that each residue in this selection must have exactly one</span>
<span class="sd">    atom in the hopping trajectory (or the selection must be identical to the</span>
<span class="sd">    hopping selection); also load the corresponding hopping trajectory:</span>

<span class="sd">      C = Collection(selection=universe.select_atoms(&#39;name OH2&#39;),</span>
<span class="sd">                     hoptraj=HoppingTrajectory(filename=&#39;hoptraj&#39;),</span>
<span class="sd">                     density=Density(filename=&#39;water.pickle&#39;))</span>

<span class="sd">    (2) Register observables with the Collection:</span>

<span class="sd">      C.add_observable(&#39;distance&#39;, lo_bin=0, hi_bin=3)</span>

<span class="sd">    Note that only observables listed in ObservablesRegistry can be used. In</span>
<span class="sd">    order to use new observables derive from the class SiteAnalysisObservable</span>
<span class="sd">    and look at the source code for the Distance class as an example.</span>

<span class="sd">    (3) At each time step, calculate the observable X for all atoms a in the</span>
<span class="sd">    selection and associate the value X(a) with the site s(a).</span>

<span class="sd">      C.compute()</span>

<span class="sd">    :Methods:</span>
<span class="sd">    add_observable()   Add another observable to the Colletion</span>

<span class="sd">    compute()          Do the analysis. Specify the observables here.</span>
<span class="sd">    imshow()           Plot 2D histograms.</span>
<span class="sd">    plot()             Plot histograms.</span>
<span class="sd">    load()             Instantiate from pickled file.</span>
<span class="sd">    save()             Pickle histograms to file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_saved_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;siteselection&#39;</span><span class="p">,</span><span class="s">&#39;site_properties&#39;</span><span class="p">,</span><span class="s">&#39;_all_sites&#39;</span><span class="p">,</span>
                         <span class="s">&#39;SiteHistograms&#39;</span><span class="p">,</span><span class="s">&#39;SiteTrajectories&#39;</span><span class="p">,</span>
                         <span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">selection</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">hoptraj</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">density</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">include_sites</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">,</span><span class="n">exclude_sites</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;default&#39;</span><span class="p">,</span><span class="s">&#39;bulk&#39;</span><span class="p">],</span>
                 <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up analysis on a per-site basis.</span>
<span class="sd">        </span>
<span class="sd">        C = Collection(selection=universe.select_atoms(&#39;name OH2&#39;),</span>
<span class="sd">                  hoptraj=HoppingTrajectory(filename=&#39;hoptraj&#39;),</span>
<span class="sd">                  density=Density(filename=&#39;water.pickle&#39;),</span>
<span class="sd">                  include_sites=&#39;default&#39;,exclude_sites=[&#39;default&#39;,&#39;bulk&#39;],</span>
<span class="sd">                  filename=None, verbosity=None)</span>

<span class="sd">        :Arguments:</span>
<span class="sd">        selection          MDAnalysis.select_atoms selection (from psf+dcd)</span>
<span class="sd">        hoptraj            hop.trajectory.HoppingTrajectory instance (from psf+dcd)</span>
<span class="sd">        density            hop.sitemap.Density instance with a sitemap defined</span>
<span class="sd">        include_sites      any valid argument to </span>
<span class="sd">        exclude_sites      Density.site_labels(include=include_sites,exclude=exclude_sites)</span>
<span class="sd">                           The default accumulates data for all the sites in the trajectory</span>
<span class="sd">                           except for the bulk site.</span>
<span class="sd">                           Histograms will only be produced for those sites. Note that</span>
<span class="sd">                           the calculation will not be much faster for fewer sites, only memory</span>
<span class="sd">                           requirements for the histograms will be lower.</span>
<span class="sd">        filename           filename to write to or read histograms from</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">set_verbosity</span><span class="p">(</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">selection</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">hoptraj</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">density</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="c"># calculate anew from raw data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">universe</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">universe</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_dcd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">trajectory</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hop_dcd</span> <span class="o">=</span> <span class="n">hoptraj</span><span class="o">.</span><span class="n">hoptraj</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dcd</span><span class="o">.</span><span class="n">ts</span>   <span class="c"># pointers to the changing time step object</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hop_ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hop_dcd</span><span class="o">.</span><span class="n">ts</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="n">density</span>  <span class="c"># needed for specific observables AND for ALL the sitelabels</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">siteselection</span> <span class="o">=</span> <span class="n">density</span><span class="o">.</span><span class="n">site_labels</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="n">include_sites</span><span class="p">,</span><span class="n">exclude</span><span class="o">=</span><span class="n">exclude_sites</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site_properties</span> <span class="o">=</span> <span class="n">density</span><span class="o">.</span><span class="n">site_properties</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_all_sites</span> <span class="o">=</span> <span class="n">density</span><span class="o">.</span><span class="n">site_labels</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span> <span class="c"># all the proper sites in a trajectory</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site_labels_cache</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;all_sites&#39;</span><span class="p">:</span> <span class="n">density</span><span class="o">.</span><span class="n">site_labels</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">),</span>
                                      <span class="s">&#39;subsites&#39;</span><span class="p">:</span> <span class="n">density</span><span class="o">.</span><span class="n">site_labels</span><span class="p">(</span><span class="s">&#39;subsites&#39;</span><span class="p">),</span>
                                      <span class="p">}</span>
            <span class="c"># indices in ts._pos of the selected atoms (used for &#39;ts._pos[data_indices]&#39; which is </span>
            <span class="c"># slightly faster than &#39;self.selection.coordinates()&#39; because it avoids a copy)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">indices</span><span class="p">()</span>  <span class="c"># needed for Observables compute()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SiteHistograms</span> <span class="o">=</span> <span class="p">{}</span> <span class="c">#IntrospectiveDict()     # will hold the results after compute()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SiteTrajectories</span> <span class="o">=</span> <span class="p">{}</span> <span class="c">#IntrospectiveDict()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">observable_plugins</span> <span class="o">=</span> <span class="p">{}</span> <span class="c">#IntrospectiveDict() # observable (name:instance) for compute()</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">set_default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="c"># sanity checks</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dcd</span><span class="o">.</span><span class="n">n_frames</span> <span class="o">&lt;&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">hop_dcd</span><span class="o">.</span><span class="n">n_frames</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Data trajectory and hopping trajectory differ in length: &quot;</span>
                                 <span class="s">&quot;</span><span class="si">%d</span><span class="s"> vs </span><span class="si">%d</span><span class="s"> frames&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dcd</span><span class="o">.</span><span class="n">n_frames</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">hop_dcd</span><span class="o">.</span><span class="n">n_frames</span><span class="p">))</span>

            <span class="c"># compute index arrays between sites, atoms, and histograms</span>
            <span class="n">hopSR2A</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">ihop</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hoptraj</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="n">sr_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sr_index</span> <span class="ow">in</span> <span class="n">hopSR2A</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Each residue should only have a single atom in the &quot;</span>
                                     <span class="s">&quot;HoppingTrajectory. Detected a collision:</span><span class="se">\n</span><span class="s">&quot;</span>
                                     <span class="s">&quot;Previous atom index &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hopSR2A</span><span class="p">[</span><span class="n">sr_index</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span>\
                                         <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">hoptraj</span><span class="o">.</span><span class="n">group</span><span class="p">[</span><span class="n">hopSR2A</span><span class="p">[</span><span class="n">sr_index</span><span class="p">]])</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
                                     <span class="s">&quot;New atom index &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ihop</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;:    &quot;</span>\
                                         <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="n">hopSR2A</span><span class="p">[</span><span class="n">sr_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ihop</span>
            <span class="n">idcd2ihop</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c"># map index in data dcd to index in hop (many-to-one!)</span>
            <span class="k">for</span> <span class="n">idcd</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="n">sr_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">idcd2ihop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hopSR2A</span><span class="p">[</span><span class="n">sr_index</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&quot;Atom with index &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idcd</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span><span class="o">+</span>\
                                       <span class="s">&quot; in the data trajectory belongs to a &quot;</span>
                                   <span class="s">&quot;residue that has no atom in the hop trajectory. Change the &quot;</span>
                                   <span class="s">&quot;selection appropriately.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">idcd2ihop</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idcd2ihop</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">idcd2ihop</span>
            <span class="k">del</span> <span class="n">hopSR2A</span>
        <span class="k">elif</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Not enough data in argument list. Either supply selection, &quot;</span>
                             <span class="s">&quot;hoptraj, and density or load from a pickled file &lt;filename&gt;.pickle&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Collection.add_observable"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.Collection.add_observable">[docs]</a>    <span class="k">def</span> <span class="nf">add_observable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">lo_bin</span><span class="p">,</span><span class="n">hi_bin</span><span class="p">,</span><span class="n">Nbins</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add observable &lt;name&gt; to the Collection.</span>

<span class="sd">        add_observable(&lt;name&gt;,&lt;lo_bin&gt;,&lt;hi_bin&gt;,Nbins=&lt;Nbins&gt;,**kwargs)</span>

<span class="sd">        The observable &lt;name&gt; is added to the collection so that &lt;name&gt; is</span>
<span class="sd">        histogrammed for all selected sites over the trajectory when the</span>
<span class="sd">        Collection.compute() method is run. The number of bins, &lt;Nbins&gt;, and the</span>
<span class="sd">        lower edge of the first bin, &lt;lo_bin&gt;, and the upper edge of the last</span>
<span class="sd">        bin, &lt;hi_bin&gt;, must be supplied.</span>

<span class="sd">        :Arguments:</span>
<span class="sd">        name        name of observable (see hop.siteanalysis.ObservablesRegistry)</span>
<span class="sd">        lo_bin      value for the lower edge of the first bin</span>
<span class="sd">        hi_bin      value for the upper edge of the last bin</span>
<span class="sd">        Nbins       number of bins (None sets it to a default value, depending on &lt;name&gt;)</span>
<span class="sd">        kwargs      keyword arguments specifying additional parameters for the particular</span>
<span class="sd">                    observable (see docs for the observables)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">histogram_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;Nbins&#39;</span><span class="p">:</span><span class="n">Nbins</span><span class="p">,</span><span class="s">&#39;lo_bin&#39;</span><span class="p">:</span><span class="n">lo_bin</span><span class="p">,</span><span class="s">&#39;hi_bin&#39;</span><span class="p">:</span><span class="n">hi_bin</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">observable_plugins</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">ObservablesRegistry</span><span class="p">[</span><span class="n">name</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span><span class="n">histogram_parameters</span><span class="p">,</span><span class="n">density</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Observable &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">+</span><span class="s">&#39; not implemented. Choose one of &#39;</span>
                             <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ObservablesRegistry</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
</div>
<div class="viewcode-block" id="Collection.del_observable"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.Collection.del_observable">[docs]</a>    <span class="k">def</span> <span class="nf">del_observable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove observable plugins &lt;name&gt; or [&lt;name1&gt;,&lt;name2&gt;,...] from the list of computed observables.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_observables</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">observable_plugins</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Collection.reset_observable"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.Collection.reset_observable">[docs]</a>    <span class="k">def</span> <span class="nf">reset_observable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset observable histograms to initial empty values; None means &#39;all&#39;.&quot;&quot;&quot;</span>
        <span class="n">msg</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="s">&#39;Resetting all observables so that we can accumulate new data.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_observables</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
            <span class="n">o</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>            
</div>
    <span class="k">def</span> <span class="nf">_observables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">observable_plugins</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">iterable</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">observable_plugins</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">observable_plugins</span><span class="p">[</span><span class="n">names</span><span class="p">]]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Only observables defined in </span><span class="si">%r</span><span class="s"> can be used as &lt;observables&gt;.&quot;</span> <span class="o">%</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">observable_plugins</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<div class="viewcode-block" id="Collection.compute"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.Collection.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">observables</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">stop</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">progress_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute histograms of the observables.</span>

<span class="sd">        :Arguments:</span>
<span class="sd">        observables   list of names of observables to compute; None means &#39;all&#39;</span>
<span class="sd">        start         0...n_frames-1  NOTE: 0-based frame indexing</span>
<span class="sd">        stop          1...n_frames</span>
<span class="sd">        step          1</span>
<span class="sd">        progress_interval   10 (print progress every &lt;interval&gt; steps)</span>
<span class="sd">          </span>
<span class="sd">        :Attributes:</span>
<span class="sd">        The method populates the dict SiteHistograms with the results.</span>

<span class="sd">        SiteHistograms Dict of the histograms, one for each observable. Each</span>
<span class="sd">                       entry o contains one SiteHistogramArray o, which holds</span>
<span class="sd">                       an array of shape (Nsites,Nbins), i.e. o.histogram[k] is</span>
<span class="sd">                       the k-th histogram. NOTE: to get the histogram of site s</span>
<span class="sd">                       use o.site_histogram(s)</span>
<span class="sd">        SiteTrajectories</span>
<span class="sd">                       If the observable has the &#39;trajectory=True&#39; flag enabled, the</span>
<span class="sd">                       value of the observable for each site and time frame is stored.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># sanity check</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_dcd</span><span class="o">.</span><span class="n">n_frames</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hop_dcd</span><span class="o">.</span><span class="n">n_frames</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">site_properties</span><span class="o">.</span><span class="n">center</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c"># typically triggered when Collection was recreated from a pickled file</span>
            <span class="k">raise</span> <span class="n">hop</span><span class="o">.</span><span class="n">MissingDataError</span><span class="p">(</span><span class="s">&quot;Cannot compute() histograms because trajectory &quot;</span>
                                       <span class="s">&quot;data is missing.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>   <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dcd</span><span class="o">.</span><span class="n">n_frames</span> <span class="o">+</span> <span class="n">start</span>
        <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>  <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dcd</span><span class="o">.</span><span class="n">n_frames</span>
        <span class="k">elif</span> <span class="n">stop</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>    <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dcd</span><span class="o">.</span><span class="n">n_frames</span> <span class="o">+</span> <span class="n">stop</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">n_frames</span> <span class="o">=</span> <span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">step</span>

        <span class="n">_observables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_observables</span><span class="p">(</span><span class="n">observables</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_observable</span><span class="p">(</span><span class="n">observables</span><span class="p">)</span>
        <span class="n">msg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="s">&#39;Computing observables </span><span class="si">%r</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">_observables</span><span class="p">])</span>

        <span class="c"># loop through all frames and add data (compute) for each frame</span>
        <span class="k">for</span> <span class="n">iframe</span><span class="p">,</span><span class="n">percentage</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_synchronous_trajectories_iter</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="p">,</span><span class="n">step</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">_observables</span><span class="p">:</span>
                <span class="n">o</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">iframe</span> <span class="o">%</span> <span class="n">progress_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">msg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="s">&quot;Data/Hop frame </span><span class="si">%4d</span><span class="s">  [</span><span class="si">%4.1f%%</span><span class="s">]</span><span class="se">\r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iframe</span><span class="p">,</span> <span class="n">percentage</span><span class="p">))</span>
        <span class="n">msg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="s">&quot;Data/Hop frame </span><span class="si">%4d</span><span class="s">  [</span><span class="si">%4.1f%%</span><span class="s">]</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iframe</span><span class="p">,</span> <span class="n">percentage</span><span class="p">))</span>
        <span class="n">msg</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="s">&#39;Creating normalized distributions.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">_observables</span><span class="p">:</span>
            <span class="n">o</span><span class="o">.</span><span class="n">histograms</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
        <span class="c"># only keep SiteHistogramArrays and SiteTrajectoryArrays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SiteHistograms</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">([(</span><span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">o</span><span class="o">.</span><span class="n">histograms</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">_observables</span><span class="p">]))</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">SiteTrajectories</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">([(</span><span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">o</span><span class="o">.</span><span class="n">trajectories</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">_observables</span> 
                                           <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">has_trajectories</span><span class="p">]))</span>
                                    
</div>
<div class="viewcode-block" id="Collection.plot"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.Collection.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">observable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot all histograms or trajectories (or a selection of sites).</span>

<span class="sd">        plot(observable, filename=None,sites=None,format=&#39;pdf&#39;,with_legend=True)</span>

<span class="sd">        :Arguments:</span>
<span class="sd">        observable     name of the observable to plot</span>
<span class="sd">        filename       output graphic filename (extension determines format or use format=...)</span>
<span class="sd">        sites          None: everything in the Collection; or a list of numeric site labels</span>
<span class="sd">        trajectory     False: plot histogram, True: plot trajectory (if computed)</span>
<span class="sd">        with_legend    True or False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_with</span><span class="p">(</span><span class="s">&#39;plot&#39;</span><span class="p">,</span><span class="n">observable</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Collection.imshow"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.Collection.imshow">[docs]</a>    <span class="k">def</span> <span class="nf">imshow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot all histograms or trajectories (or a selection of sites) as a 2D density map.</span>

<span class="sd">        imshow(observable, filename=None,sites=None,format=&#39;pdf&#39;)</span>

<span class="sd">        :Arguments:</span>
<span class="sd">        observable     name of the observable to plot</span>
<span class="sd">        filename       output graphic filename (extension determines format or use format=...)</span>
<span class="sd">        sites          None: everything in the Collection; or a list of numeric site labels</span>
<span class="sd">        trajectory     False: plot histogram, True: plot trajectory (if computed)</span>
<span class="sd">        normalize      True: distribution; False: histogram</span>
<span class="sd">        format         determine output format if filename is derived from the</span>
<span class="sd">                       default filename</span>
<span class="sd">        **kwargs       keyword arguments are passed directly to pylab.imshow()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_with</span><span class="p">(</span><span class="s">&#39;imshow&#39;</span><span class="p">,</span><span class="n">observable</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_plot_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">methodname</span><span class="p">,</span><span class="n">observable</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">trajectory</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;trajectory&#39;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trajectory</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SiteTrajectories</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SiteHistograms</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sitearray</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">observable</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;&#39;observable&#39; must be one of &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">plotfunctions</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;plot&#39;</span><span class="p">:</span><span class="n">sitearray</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span>
                         <span class="s">&#39;imshow&#39;</span><span class="p">:</span><span class="n">sitearray</span><span class="o">.</span><span class="n">imshow</span><span class="p">,</span>
                         <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>  <span class="n">filename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;filename&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span> <span class="c"># no filename in argument list: use our default</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">()</span>        

        <span class="n">plotfunctions</span><span class="p">[</span><span class="n">methodname</span><span class="p">](</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_next_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data_ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dcd</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="n">hop_ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hop_dcd</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># or should this be coded with repeated next() to avoid random access bugs?</span>
            <span class="n">data_ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dcd</span><span class="p">[</span><span class="n">start</span><span class="p">]</span>
            <span class="n">hop_ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hop_dcd</span><span class="p">[</span><span class="n">start</span><span class="p">]</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">data_ts</span><span class="o">.</span><span class="n">frame</span> <span class="o">==</span> <span class="n">hop_ts</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_synchronous_trajectories_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="p">,</span><span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Go through hop and data frames by only using the next() method thus</span>
<span class="sd">        avoiding possible problems with random-access of big trajectories or non-RA</span>
<span class="sd">        formats such as XTC.&quot;&quot;&quot;</span>
        <span class="n">total_frames</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_frame</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>          <span class="c"># advance to first frame</span>
        <span class="k">for</span> <span class="n">iframe</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="p">,</span><span class="n">step</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">iframe</span><span class="p">,</span><span class="mf">100.0</span><span class="o">*</span><span class="p">(</span><span class="n">iframe</span><span class="o">-</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">total_frames</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_next_frame</span><span class="p">()</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">step</span><span class="p">)]</span>   <span class="c"># advance at the end of loop!</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">StopIteration</span>

<div class="viewcode-block" id="Collection.interactive"><a class="viewcode-back" href="../../hop/siteanalysis.html#hop.siteanalysis.Collection.interactive">[docs]</a>    <span class="k">def</span> <span class="nf">interactive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn SiteHistograms and SiteTrajectories into introspection-friendly objects cls.H and cls.T</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">IntrospectiveDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SiteHistograms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">IntrospectiveDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SiteTrajectories</span><span class="p">)</span>
        <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;H contains </span><span class="si">%r</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">msg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;T contains </span><span class="si">%r</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="c">#</span>
<span class="c">#----------------------------------------------------------------------</span>
<span class="c">#</span>
</div></div>
<span class="k">class</span> <span class="nc">test</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">psf</span><span class="o">=</span><span class="s">&#39;inp/ifabp_water.psf&#39;</span><span class="p">,</span><span class="n">dcd</span><span class="o">=</span><span class="s">&#39;trj/rmsfit_ifabp_water_1.dcd&#39;</span><span class="p">,</span>
                 <span class="n">density</span><span class="o">=</span><span class="s">&quot;analysis/water&quot;</span><span class="p">,</span><span class="n">hoptrj</span><span class="o">=</span><span class="s">&quot;trj/hoptrj&quot;</span><span class="p">,</span><span class="n">with_observables</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test typical setup for SiteAnalysis. Supply filenames for</span>
<span class="sd">        psf and dcd (the data trajectory), density (a pickled Density</span>
<span class="sd">        object with a sitemap), and the name of the hopping trajectory</span>
<span class="sd">        (it assumes that the hopping psf has the same name with the</span>
<span class="sd">        psf prefix)&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">MDAnalysis</span>
        <span class="kn">import</span> <span class="nn">hop.utilities</span>
        <span class="c">#hop.utilities.matplotlib_interactive(False)</span>
        <span class="kn">import</span> <span class="nn">hop.sitemap</span><span class="o">,</span> <span class="nn">hop.trajectory</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">MDAnalysis</span><span class="o">.</span><span class="n">Universe</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span><span class="n">dcd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="s">&#39;name OH2&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hoptraj</span> <span class="o">=</span> <span class="n">hop</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">HoppingTrajectory</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">hoptrj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dens</span> <span class="o">=</span> <span class="n">hop</span><span class="o">.</span><span class="n">sitemap</span><span class="o">.</span><span class="n">Density</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">density</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Collection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">hoptraj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dens</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_observables</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">add_observable</span><span class="p">(</span><span class="s">&#39;distance&#39;</span><span class="p">,</span> <span class="n">lo_bin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hi_bin</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">add_observable</span><span class="p">(</span><span class="s">&#39;orbit&#39;</span><span class="p">,</span> <span class="n">lo_bin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hi_bin</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">add_observable</span><span class="p">(</span><span class="s">&#39;occupancy&#39;</span><span class="p">,</span> <span class="n">lo_bin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hi_bin</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">trajectory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">add_observable</span><span class="p">(</span><span class="s">&#39;orbitoccupancy&#39;</span><span class="p">,</span> <span class="n">lo_bin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hi_bin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">trajectory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">print</span> <span class="s">&quot;defined observables: </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">observable_plugins</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot;data acquistion for observables: T.A.compute(...)&quot;</span>
        <span class="k">print</span> <span class="s">&quot;plot results: T.A.plot(T.A.sites)&quot;</span>
        <span class="k">print</span> <span class="s">&quot;ATTENTION: is the density really correct? Should be &#39;remapped&#39; for holo&quot;</span>\
            <span class="s">&quot; density name = </span><span class="si">%(density)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">locals</span><span class="p">()</span>
        
        <span class="c"># self.A.compute()</span>
        <span class="c"># self.A.plot(self.A.sites)</span>

<span class="k">def</span> <span class="nf">_fix_old</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s">&#39;analysis/siteanalysis&#39;</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">hop</span><span class="o">.</span><span class="n">siteanalysis</span><span class="o">.</span><span class="n">Collection</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="n">A</span><span class="o">.</span><span class="n">SiteHistograms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">default_plotproperties</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">properties</span><span class="p">)</span>
        <span class="n">x</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">p</span>
        <span class="k">print</span> <span class="n">n</span>
        <span class="k">print</span> <span class="n">x</span><span class="o">.</span><span class="n">properties</span>

    <span class="n">A</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">A</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">&#39;distance&#39;</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&#39;figs/site_distance2.pdf&#39;</span><span class="p">)</span>
    <span class="n">A</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">&#39;orbit&#39;</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&#39;figs/site_orbit2.pdf&#39;</span><span class="p">)</span>
    <span class="n">A</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">&#39;occupancy&#39;</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&#39;figs/site_occupancy.pdf&#39;</span><span class="p">)</span>
    <span class="n">A</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">&#39;orbitoccupancy&#39;</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&#39;figs/site_orbitoccupancy.pdf&#39;</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Hop 0.3.3 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Thomas B. Woolf, Oliver Beckstein.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>