

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>hop.utilities &mdash; Hop 0.3.3 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.3.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Hop 0.3.3 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Hop 0.3.3 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for hop.utilities</h1><div class="highlight"><pre>
<span class="c"># $Id$</span>
<span class="c"># Hop --- a framework to analyze solvation dynamics from MD simulations</span>
<span class="c"># Copyright (c) 2009 Oliver Beckstein &lt;orbeckst@gmail.com&gt;</span>
<span class="c">#</span>
<span class="c"># This program is free software: you can redistribute it and/or modify</span>
<span class="c"># it under the terms of the GNU General Public License as published by</span>
<span class="c"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c"># (at your option) any later version.</span>
<span class="c">#</span>
<span class="c"># This program is distributed in the hope that it will be useful,</span>
<span class="c"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c"># GNU General Public License for more details.</span>
<span class="c">#</span>
<span class="c"># You should have received a copy of the GNU General Public License</span>
<span class="c"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">&quot;&quot;&quot;Random mix of convenience functions that don&#39;t fit anywhere</span>
<span class="sd">else. For messages I should probably use python&#39;s logger module but</span>
<span class="sd">this is working so far (even though it&#39;s pretty crappy).&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">cPickle</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">hop</span>

<div class="viewcode-block" id="unlink_f"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.unlink_f">[docs]</a><span class="k">def</span> <span class="nf">unlink_f</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Unlink path but do not complain if file does not exist.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">:</span>
            <span class="k">raise</span>
</div>
<div class="viewcode-block" id="mkdir_p"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.mkdir_p">[docs]</a><span class="k">def</span> <span class="nf">mkdir_p</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a directory *path* with subdirs but do not complain if it exists.</span>

<span class="sd">    This is like GNU ``mkdir -p path``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span><span class="p">:</span>
            <span class="k">raise</span>


<span class="c"># unbound methods filename_function(), to be used in other</span>
<span class="c"># classes; the plan is to make all classes that require them</span>
<span class="c"># subclasses of hop.utilities.Saveable and bind them to this super</span>
<span class="c"># class. (load() and save() are already tentatively XXXed out)</span>

<span class="c"># used in many classes for filename handling (not all are Saveable yet)</span>
<span class="c">#   filename = hop.utilities.filename_function</span>
<span class="c"># (adds the _filename attribute to the class self!)</span>
<span class="c"># NOTE: filename_function is not developed anymore and deprecated</span>
<span class="c">#       Try to derive classes from Saveable.</span></div>
<div class="viewcode-block" id="filename_function"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.filename_function">[docs]</a><span class="k">def</span> <span class="nf">filename_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">set_default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">use_my_ext</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Supply a file name for the object.</span>

<span class="sd">    fn = filename()             ---&gt; &lt;default_filename&gt;</span>
<span class="sd">    fn = filename(&#39;name.ext&#39;)   ---&gt; &#39;name&#39;</span>
<span class="sd">    fn = filename(ext=&#39;pickle&#39;) ---&gt; &lt;default_filename&gt;&#39;.pickle&#39;</span>
<span class="sd">    fn = filename(&#39;name.inp&#39;,&#39;pdf&#39;) --&gt; &#39;name.pdf&#39;</span>
<span class="sd">    fn = filename(&#39;foo.pdf&#39;,ext=&#39;png&#39;,use_my_ext=True) --&gt; &#39;foo.pdf&#39;</span>

<span class="sd">    The returned filename is stripped of the extension (use_my_ext=False) and</span>
<span class="sd">    if provided, another extension is appended. Chooses a default if no</span>
<span class="sd">    filename is given.  Raises a ValueError exception if no default file name</span>
<span class="sd">    is known.</span>

<span class="sd">    If set_default=True then the default filename is also set.</span>

<span class="sd">    use_my_ext=True lets the suffix of a provided filename take priority over a</span>
<span class="sd">    default ext(tension).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;_filename&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="bp">None</span>        <span class="c"># add attribute to class</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;A file name is required because no default file name was defined.&quot;</span><span class="p">)</span>
        <span class="n">my_ext</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filename</span><span class="p">,</span> <span class="n">my_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">set_default</span><span class="p">:</span>                  <span class="c"># replaces existing default file name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">filename</span>
    <span class="k">if</span> <span class="n">my_ext</span> <span class="ow">and</span> <span class="n">use_my_ext</span><span class="p">:</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">my_ext</span>
    <span class="k">if</span> <span class="n">ext</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">):</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>  <span class="c"># strip a dot to avoid annoying mistakes</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">ext</span>
    <span class="k">return</span> <span class="n">filename</span>
</div>
<div class="viewcode-block" id="fileextension"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.fileextension">[docs]</a><span class="k">def</span> <span class="nf">fileextension</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the file extension without the leading dot or the default.&quot;&quot;&quot;</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">):</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">ext</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default</span>

<span class="c"># load() and save() are unbound plugin methods for other classes</span>
<span class="c"># (Once the code has been cleaned up they will ONLY exist as methods of Saveable)</span></div>
<div class="viewcode-block" id="XXXsave"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.XXXsave">[docs]</a><span class="k">def</span> <span class="nf">XXXsave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save as a pickled python object.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_attributes</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;No data save: the object declared empty &#39;_saved_attributes&#39;.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="c"># TODO: need to properly design this whole pickling stuff</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_attributes</span> <span class="o">==</span> <span class="s">&#39;all&#39;</span><span class="p">:</span>
        <span class="c"># HACK: manually filter out some attributes such as type(&#39;method-wrapper&#39;)</span>
        <span class="c">#       objects that cannot be pickled</span>
        <span class="n">saved_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_excluded_attributes</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">saved_attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_attributes</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">saved_attributes</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Attribute &#39;&quot;</span><span class="o">+</span><span class="n">attr</span><span class="o">+</span><span class="s">&quot;&#39; has not been computed and will not be saved.&quot;</span><span class="p">,</span>
                          <span class="n">category</span><span class="o">=</span><span class="n">hop</span><span class="o">.</span><span class="n">MissingDataWarning</span><span class="p">)</span>
    <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;pickle&#39;</span><span class="p">,</span><span class="n">set_default</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span><span class="s">&#39;wb&#39;</span><span class="p">)</span>  <span class="c"># 2.5: with open(..) as fh:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">fh</span><span class="p">,</span><span class="n">cPickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">del</span> <span class="n">data</span>
</div>
<div class="viewcode-block" id="XXXload"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.XXXload">[docs]</a><span class="k">def</span> <span class="nf">XXXload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">merge</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reinstantiate class from a pickled file (produced with save()).&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_attributes</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;No data loaded: the object declared empty &#39;_saved_attributes&#39;.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;pickle&#39;</span><span class="p">,</span><span class="n">set_default</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span><span class="s">&#39;rb&#39;</span><span class="p">)</span>  <span class="c"># 2.5: with open(..) as fh:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_attributes</span> <span class="o">==</span> <span class="s">&#39;all&#39;</span><span class="p">:</span>
        <span class="n">saved_attributes</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">saved_attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_attributes</span>
    <span class="c"># restore attributes from the temporary instance (works but not elegant...)</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">saved_attributes</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">merge</span> <span class="ow">and</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">_merge_attributes</span><span class="p">:</span> <span class="c"># only works for type(attr)==dict</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Expected attribute &#39;&quot;</span><span class="o">+</span><span class="n">attr</span><span class="o">+</span><span class="s">&quot;&#39; was not found in saved file &#39;&quot;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s">&quot;&#39;.&quot;</span><span class="p">,</span>
                          <span class="n">category</span><span class="o">=</span><span class="n">hop</span><span class="o">.</span><span class="n">MissingDataWarning</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">data</span>

</div>
<div class="viewcode-block" id="Saveable"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.Saveable">[docs]</a><span class="k">class</span> <span class="nc">Saveable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Baseclass that supports save()ing and load()ing.</span>

<span class="sd">    Override the class variables</span>

<span class="sd">      _saved_attributes = [] # list attributes to be pickled</span>
<span class="sd">      _merge_attributes = [] # list dicts to be UPDATED from the pickled file with load(merge=True)</span>
<span class="sd">      _excluded_attributes = [] # list attributes that should never be pickled</span>

<span class="sd">    Note:</span>

<span class="sd">      _saved_attributes = &#39;all&#39; # pickles ALL attributes, equivalent to self.__dict__.keys()</span>
<span class="sd">                                # (use _excluded_attributes with &#39;all&#39;!)</span>

<span class="sd">     Use _excluded_attributes to filter out some attributes such as</span>
<span class="sd">     type(&#39;method-wrapper&#39;) objects that cannot be pickled (e.g. when using properties).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_saved_attributes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_merge_attributes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_excluded_attributes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c"># TODO: could I use __new__ to load the pickled file?</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># TODO: should initialize _XXX_attributes[] via __init__() and use super(cls,Saveable).__init__()</span>
        <span class="c">#       in subclasses</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;filename&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="c"># Multiple Inheritance is probably NOT going to work...</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Saveable</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>        <span class="c"># XXX: ... shouldn&#39;t this take *args,**kwargs ?? OB-2009-06-10</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;filename&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;filename&#39;</span><span class="p">],</span><span class="s">&#39;pickle&#39;</span><span class="p">)</span>   <span class="c"># sets _saved_attributes in __dict__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c"># do the initialization from the data</span>

    <span class="c"># basic pickle protocol</span>
    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_attributes</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;No data saved: the class declared empty &#39;_saved_attributes&#39;.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_attributes</span> <span class="o">==</span> <span class="s">&#39;all&#39;</span><span class="p">:</span>
            <span class="c"># HACK: filter out some attributes such as type(&#39;method-wrapper&#39;) objects that</span>
            <span class="c">#       cannot be pickled</span>
            <span class="n">saved_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_excluded_attributes</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">saved_attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_attributes</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">saved_attributes</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Attribute &#39;&quot;</span><span class="o">+</span><span class="n">attr</span><span class="o">+</span><span class="s">&quot;&#39; has not been computed and will not be saved.&quot;</span><span class="p">,</span>
                              <span class="n">category</span><span class="o">=</span><span class="n">hop</span><span class="o">.</span><span class="n">MissingDataWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
        <span class="c"># Simple:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c"># could check for _saved_attributes</span>

<div class="viewcode-block" id="Saveable.filename"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.Saveable.filename">[docs]</a>    <span class="k">def</span> <span class="nf">filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">set_default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">use_my_ext</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Supply a file name for the object.</span>

<span class="sd">        fn = filename()             ---&gt; &lt;default_filename&gt;</span>
<span class="sd">        fn = filename(&#39;name.ext&#39;)   ---&gt; &#39;name&#39;</span>
<span class="sd">        fn = filename(ext=&#39;pickle&#39;) ---&gt; &lt;default_filename&gt;&#39;.pickle&#39;</span>
<span class="sd">        fn = filename(&#39;name.inp&#39;,&#39;pdf&#39;) --&gt; &#39;name.pdf&#39;</span>
<span class="sd">        fn = filename(&#39;foo.pdf&#39;,ext=&#39;png&#39;,use_my_ext=True) --&gt; &#39;foo.pdf&#39;</span>

<span class="sd">        The returned filename is stripped of the extension (use_my_ext=False) and</span>
<span class="sd">        if provided, another extension is appended. Chooses a default if no</span>
<span class="sd">        filename is given.  Raises a ValueError exception if no default file name</span>
<span class="sd">        is known.</span>

<span class="sd">        If set_default=True then the default filename is also set.</span>

<span class="sd">        use_my_ext=True lets the suffix of a provided filename take priority over a</span>
<span class="sd">        default ext(tension).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;_filename&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="bp">None</span>        <span class="c"># add attribute to class</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;A file name is required because no default file name was defined.&quot;</span><span class="p">)</span>
            <span class="n">my_ext</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">my_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">set_default</span><span class="p">:</span>                  <span class="c"># replaces existing default file name</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">if</span> <span class="n">my_ext</span> <span class="ow">and</span> <span class="n">use_my_ext</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">my_ext</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">):</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>  <span class="c"># strip a dot to avoid annoying mistakes</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">ext</span>
        <span class="k">return</span> <span class="n">filename</span>
</div>
<div class="viewcode-block" id="Saveable.save"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.Saveable.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save class to a pickled file.&quot;&quot;&quot;</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;pickle&#39;</span><span class="p">,</span><span class="n">set_default</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span><span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="c"># 2.5: with open(..) as fh:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fh</span><span class="p">,</span><span class="n">cPickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Saveable.load"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.Saveable.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">merge</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reinstantiate class from a pickled file (produced with save()).&quot;&quot;&quot;</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;pickle&#39;</span><span class="p">,</span><span class="n">set_default</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span><span class="s">&#39;rb&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">__dict__</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Loading an old-style save file.&quot;</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">tmp</span>  <span class="c"># just hope we got all attributes...</span>
            <span class="c"># backwards-compatibility hacks:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s">&#39;P&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;parameters&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">del</span> <span class="n">tmp</span>
        <span class="c"># restore attributes from the temporary instance</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_attributes</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;No data loaded: the object declared empty &#39;_saved_attributes&#39;.&quot;</span><span class="p">,</span>
                          <span class="n">category</span><span class="o">=</span><span class="n">hop</span><span class="o">.</span><span class="n">MissingDataWarning</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_attributes</span> <span class="o">==</span> <span class="s">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">saved_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_excluded_attributes</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">saved_attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_attributes</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">saved_attributes</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">merge</span> <span class="ow">and</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_attributes</span><span class="p">:</span> <span class="c"># only works for type(attr)==dict</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Expected attribute &#39;&quot;</span><span class="o">+</span><span class="n">attr</span><span class="o">+</span><span class="s">&quot;&#39; was not found in saved file &#39;&quot;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s">&quot;&#39;.&quot;</span><span class="p">,</span>
                              <span class="n">category</span><span class="o">=</span><span class="n">hop</span><span class="o">.</span><span class="n">MissingDataWarning</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">data</span>
        <span class="k">return</span> <span class="bp">True</span>
</div></div>
<div class="viewcode-block" id="easy_load"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.easy_load">[docs]</a><span class="k">def</span> <span class="nf">easy_load</span><span class="p">(</span><span class="n">names</span><span class="p">,</span><span class="n">baseclass</span><span class="p">,</span><span class="n">keymethod</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Instantiate a class either from an existing instance or a pickled file.</span>

<span class="sd">    instance_list = easy_load(names,baseclass,keymethod)</span>

<span class="sd">    &gt;&gt;&gt; x = easy_load(&lt;filename&gt;,Xclass,&#39;my_method_name&#39;)</span>
<span class="sd">    &gt;&gt;&gt; [x1,x2,...] = easy_load([&lt;filename1&gt;, &lt;fn2&gt;,...], Xclass,&#39;my_method_name&#39;)</span>
<span class="sd">    &gt;&gt;&gt; [x1,x2,...] = easy_load([x1, x2, ..], Xclass,&#39;my_method_name&#39;)</span>

<span class="sd">    If the argument does not implement the keymethod then try loading</span>
<span class="sd">    from a file.</span>

<span class="sd">    API:</span>

<span class="sd">    For this to work, the baseclass (eg Saveable) must be able to instantiate</span>
<span class="sd">    itself using</span>

<span class="sd">    x = baseclass(filename=name)</span>

<span class="sd">    If a single name is given, a singlet is returned, otherwise a list of instances.</span>

<span class="sd">    (The docs are longer than the code...)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">keymethod</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">baseclass</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">iterable</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">load</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">load</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>

<span class="c">#------------------------------------------------------------</span>
<span class="c"># status message functions</span>
<span class="c">#------------------------------------------------------------</span>
<span class="c"># Set the global verbosity = 0 to define the default verbosity level.</span>
<span class="c"># I haven&#39;t found a way to make this a class -- unless I let every</span>
<span class="c"># other class inherit from the base class (eg &#39;interactive&#39;) and make</span>
<span class="c"># verbosity a class-level variable (or whatever it is called) .</span>
<span class="c">#</span>
<span class="c"># (NOTE: this will be removed once we use logger)</span>
</div>
<span class="n">verbosity</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">logfile</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">LOGFILENAME</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="set_verbosity"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.set_verbosity">[docs]</a><span class="k">def</span> <span class="nf">set_verbosity</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">logfilename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;set_verbosity([level],logfilename=&lt;filename&gt;)</span>
<span class="sd">    Set the verbosity level</span>
<span class="sd">    level &lt; 0 : level &lt;- abs(level) but output is also appended to logfile</span>
<span class="sd">    level == 0: minimum</span>
<span class="sd">    level == 3: verbose</span>
<span class="sd">    level &gt; 3 : debugging&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">verbosity</span><span class="p">,</span><span class="n">logfile</span><span class="p">,</span><span class="n">LOGFILENAME</span>
    <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">verbosity</span>
    <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c"># this really should be a class, with the destructor closing the file</span>
        <span class="k">if</span> <span class="n">logfilename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">logfilename</span> <span class="o">=</span> <span class="n">LOGFILENAME</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGFILENAME</span> <span class="o">=</span> <span class="n">logfilename</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">logfilename</span><span class="p">,</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;Failed to open logfile; provide a filename when level&lt;0.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">verbosity</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c"># close the logfile if we don&#39;t write to it anymore</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">close_log</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="n">verbosity</span> <span class="o">=</span> <span class="n">level</span>
    <span class="k">return</span> <span class="n">verbosity</span>
</div>
<div class="viewcode-block" id="close_log"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.close_log">[docs]</a><span class="k">def</span> <span class="nf">close_log</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Close open logfile; must be done manually.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">logfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;no open logfile; use negative verbosity.&quot;</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">get_verbosity</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">verbosity</span>

<div class="viewcode-block" id="msg"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.msg">[docs]</a><span class="k">def</span> <span class="nf">msg</span><span class="p">(</span><span class="n">level</span><span class="p">,</span><span class="n">m</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;msg(level,[m])</span>

<span class="sd">    1) Print message string if the level &lt;= verbose. level describes the</span>
<span class="sd">    priority with lower = more important.</span>

<span class="sd">    Terminate string with \\n if a newline is desired or \\r to overwrite</span>
<span class="sd">    the current line (eg for output progress indication)</span>

<span class="sd">    Note that if the global verbosity level is &lt; 0 then the message is also</span>
<span class="sd">    written to the logfile.</span>

<span class="sd">    2) If called without a string then msg(level) returns True if it would</span>
<span class="sd">    print a message, and False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">verbosity</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="c"># terminate string with \n if newline desired</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="fixedwidth_bins"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.fixedwidth_bins">[docs]</a><span class="k">def</span> <span class="nf">fixedwidth_bins</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return bins of width delta that cover xmin,xmax (or a larger range).</span>

<span class="sd">    dict = fixedwidth_bins(delta,xmin,xmax)</span>

<span class="sd">    The dict contains &#39;Nbins&#39;, &#39;delta&#39;, &#39;min&#39;, and &#39;max&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">xmin</span> <span class="o">&lt;</span> <span class="n">xmax</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Boundaries are not sane: should be xmin &lt; xmax.&#39;</span><span class="p">)</span>
    <span class="n">_delta</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float_</span><span class="p">)</span>
    <span class="n">_xmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float_</span><span class="p">)</span>
    <span class="n">_xmax</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float_</span><span class="p">)</span>
    <span class="n">_length</span> <span class="o">=</span> <span class="n">_xmax</span> <span class="o">-</span> <span class="n">_xmin</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">_length</span><span class="o">/</span><span class="n">_delta</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">int_</span><span class="p">)</span>      <span class="c"># number of bins</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">_delta</span> <span class="o">-</span> <span class="n">_length</span><span class="p">)</span>   <span class="c"># add half of the excess to each end</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">&#39;Nbins&#39;</span><span class="p">:</span><span class="n">N</span><span class="p">,</span> <span class="s">&#39;delta&#39;</span><span class="p">:</span><span class="n">_delta</span><span class="p">,</span><span class="s">&#39;min&#39;</span><span class="p">:</span><span class="n">_xmin</span><span class="o">-</span><span class="n">dx</span><span class="p">,</span> <span class="s">&#39;max&#39;</span><span class="p">:</span><span class="n">_xmax</span><span class="o">+</span><span class="n">dx</span><span class="p">}</span>


</div>
<div class="viewcode-block" id="flatiter"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.flatiter">[docs]</a><span class="k">def</span> <span class="nf">flatiter</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns an iterator that flattens a sequence of sequences of sequences...</span>
<span class="sd">    (c) 2005 Peter Otten, at  http://www.thescripts.com/forum/thread23631.html</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># avoid infinite recursion with strings</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">seq</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">flatiter</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">k</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">seq</span>
</div>
<div class="viewcode-block" id="flatten"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.flatten">[docs]</a><span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;flatten(sequence) -&gt; list</span>

<span class="sd">    Returns a single, flat list which contains all elements retrieved</span>
<span class="sd">    from the sequence and all recursively contained sub-sequences</span>
<span class="sd">    (iterables).</span>

<span class="sd">    Examples:</span>
<span class="sd">    &gt;&gt;&gt; [1, 2, [3,4], (5,6)]</span>
<span class="sd">    [1, 2, [3, 4], (5, 6)]</span>
<span class="sd">    &gt;&gt;&gt; flatten([[[1,2,3], (42,None)], [4,5], [6], 7, MyVector(8,9,10)])</span>
<span class="sd">    [1, 2, 3, 42, None, 4, 5, 6, 7, 8, 9, 10]</span>

<span class="sd">    From http://kogs-www.informatik.uni-hamburg.de/~meine/python_tricks</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="c">#if isinstance(el, (list, tuple)):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="s">&quot;__iter__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">flatten</span><span class="p">(</span><span class="n">el</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

</div>
<span class="k">def</span> <span class="nf">matplotlib_interactive</span><span class="p">(</span><span class="n">interactive</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">interactive</span><span class="p">:</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s">&#39;Agg&#39;</span><span class="p">)</span>  <span class="c"># allows running without X11 on compute nodes</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">interactive</span><span class="p">(</span><span class="n">interactive</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">interactive</span>

<div class="viewcode-block" id="iterable"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.iterable">[docs]</a><span class="k">def</span> <span class="nf">iterable</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns True if obj can be iterated over and is NOT a string.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>    <span class="c"># avoid iterating over characters of a string</span>
    <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="asiterable"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.asiterable">[docs]</a><span class="k">def</span> <span class="nf">asiterable</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return an object that is an iterable: object itself or wrapepd in a list.</span>

<span class="sd">    iterable &lt;-- asiterable(something)</span>

<span class="sd">    Treats strings as NOT-iterable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">iterable</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">obj</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">obj</span>
</div>
<div class="viewcode-block" id="Pearson_r"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.Pearson_r">[docs]</a><span class="k">def</span> <span class="nf">Pearson_r</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Pearson&#39;s r (correlation coefficient)</span>

<span class="sd">    r = Pearson(x,y)</span>

<span class="sd">    x and y are arrays of same length</span>

<span class="sd">    Historical note:</span>
<span class="sd">    Naive implementation of Pearson&#39;s r:</span>

<span class="sd">    Ex = scipy.stats.mean(x)</span>
<span class="sd">    Ey = scipy.stats.mean(y)</span>

<span class="sd">    covxy = numpy.sum((x-Ex)*(y-Ey))</span>
<span class="sd">    r = covxy/math.sqrt(numpy.sum((x-Ex)**2)*numpy.sum((y-Ey)**2))</span>
<span class="sd">    return r</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="linfit"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.linfit">[docs]</a><span class="k">def</span> <span class="nf">linfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">dy</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;Fit a straight line y = a + bx to the data in x and y; errors</span>
<span class="sd">    on y should be provided in dy in order to assess the goodness of</span>
<span class="sd">    the fit and derive errors on the parameters.</span>

<span class="sd">    result_dict = linfit(x,y[,dy])</span>

<span class="sd">    Fit y = a + bx to the data in x and y by analytically minimizing</span>
<span class="sd">    chi^2. dy holds the standard deviations of the individual y_i. If</span>
<span class="sd">    dy is not given, they are assumed to be constant (note that in</span>
<span class="sd">    this case Q is set to 1 and it is meaningless and chi2 is</span>
<span class="sd">    normalised to unit standard deviation on all points!).</span>

<span class="sd">    Returns the parameters a and b, their uncertainties sigma_a and</span>
<span class="sd">    sigma_b, and their correlation coefficient r_ab; it also returns</span>
<span class="sd">    the chi-squared statistic and the goodness-of-fit probability Q</span>
<span class="sd">    (that the fit would have chi^2 this large or larger; Q &lt; 10^-2</span>
<span class="sd">    indicates that the model is bad --- Q is the probability that a</span>
<span class="sd">    value of chi-square as _poor_ as the calculated statistic chi2</span>
<span class="sd">    should occur by chance.)</span>

<span class="sd">    result_dict =</span>
<span class="sd">       intercept, sigma_intercept    a +/- sigma_a</span>
<span class="sd">       slope, sigma_slope            b +/- sigma_b</span>
<span class="sd">       parameter_correlation         correlation coefficient r_ab</span>
<span class="sd">                                     between a and b</span>
<span class="sd">       chi_square                    chi^2 test statistic</span>
<span class="sd">       Q_fit                         goodness-of-fit probability</span>

<span class="sd">    Based on &#39;Numerical Recipes in C&#39;, Ch 15.2.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">math</span>
    <span class="kn">import</span> <span class="nn">numpy</span>
    <span class="kn">import</span> <span class="nn">scipy.stats</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;lengths of x and y must match: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">have_dy</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">have_dy</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">have_dy</span><span class="p">:</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n</span><span class="p">),</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

    <span class="n">x</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>

    <span class="n">s2</span>  <span class="o">=</span> <span class="n">dy</span><span class="o">*</span><span class="n">dy</span>
    <span class="n">S</span>   <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">s2</span><span class="p">)</span>
    <span class="n">Sx</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">s2</span><span class="p">)</span>
    <span class="n">Sy</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="n">s2</span><span class="p">)</span>
    <span class="n">Sxx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="n">s2</span><span class="p">)</span>
    <span class="n">Sxy</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="o">/</span><span class="n">s2</span><span class="p">)</span>

    <span class="n">t</span>   <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">Sx</span><span class="o">/</span><span class="n">S</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span>
    <span class="n">Stt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>

    <span class="n">b</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="n">y</span><span class="o">/</span><span class="n">dy</span><span class="p">)</span><span class="o">/</span><span class="n">Stt</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">Sy</span> <span class="o">-</span> <span class="n">Sx</span><span class="o">*</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="n">S</span>

    <span class="n">sa</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">Sx</span><span class="o">*</span><span class="n">Sx</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">S</span><span class="o">*</span><span class="n">Stt</span><span class="p">))</span><span class="o">/</span><span class="n">S</span><span class="p">)</span>
    <span class="n">sb</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">Stt</span><span class="p">)</span>

    <span class="n">covab</span> <span class="o">=</span> <span class="o">-</span><span class="n">Sx</span><span class="o">/</span><span class="p">(</span><span class="n">S</span><span class="o">*</span><span class="n">Stt</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">covab</span><span class="o">/</span><span class="p">(</span><span class="n">sa</span><span class="o">*</span><span class="n">sb</span><span class="p">)</span>

    <span class="n">chi2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(((</span><span class="n">y</span><span class="o">-</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">have_dy</span><span class="p">:</span>
        <span class="c"># estimate error if none were provided</span>
        <span class="n">sigmadata</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">chi2</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">sa</span> <span class="o">*=</span> <span class="n">sigmadata</span>
        <span class="n">sb</span> <span class="o">*=</span> <span class="n">sigmadata</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">chisqprob</span><span class="p">(</span><span class="n">chi2</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s">&quot;intercept&quot;</span><span class="p">:</span><span class="n">a</span><span class="p">,</span><span class="s">&quot;slope&quot;</span><span class="p">:</span><span class="n">b</span><span class="p">,</span>
            <span class="s">&quot;sigma_intercept&quot;</span><span class="p">:</span><span class="n">sa</span><span class="p">,</span><span class="s">&quot;sigma_slope&quot;</span><span class="p">:</span><span class="n">sb</span><span class="p">,</span>
            <span class="s">&quot;parameter_correlation&quot;</span><span class="p">:</span><span class="n">r</span><span class="p">,</span> <span class="s">&quot;chi_square&quot;</span><span class="p">:</span><span class="n">chi2</span><span class="p">,</span> <span class="s">&quot;Q&quot;</span><span class="p">:</span><span class="n">Q</span><span class="p">}</span>
</div>
<div class="viewcode-block" id="autocorrelation_fft"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.autocorrelation_fft">[docs]</a><span class="k">def</span> <span class="nf">autocorrelation_fft</span><span class="p">(</span><span class="n">series</span><span class="p">,</span><span class="n">include_mean</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">periodic</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">start</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">stop</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate the auto correlation function.</span>

<span class="sd">    acf = autocorrelation_fft(series,include_mean=False,**kwargs)</span>

<span class="sd">    The time series is correlated with itself across its whole length. It is 0-padded</span>
<span class="sd">    and the ACF is corrected for the 0-padding (the values for larger lags are</span>
<span class="sd">    increased) unless mode=&#39;valid&#39; (see below).</span>
<span class="sd">    Only the [0,len(series)[ interval is returned. The series is normalized to ots 0-th</span>
<span class="sd">    element.</span>

<span class="sd">    Note that the series for mode=&#39;same&#39;|&#39;full&#39; is inaccurate for long times and</span>
<span class="sd">    should probably be truncated at 1/2*len(series). Alternatively, only sample a</span>
<span class="sd">    subseries with the stop keyword.</span>

<span class="sd">    :Arguments:</span>
<span class="sd">    series        (time) series, a 1D numpy array</span>
<span class="sd">    include_mean  False: subtract mean(series) from series</span>
<span class="sd">    periodic      False: corrected for 0-padding</span>
<span class="sd">                  True: return as is</span>
<span class="sd">    start,stop    If set, calculate the ACF of series[start:stop] with series;</span>
<span class="sd">                  in this case mode=&#39;valid&#39; is enforced</span>
<span class="sd">    kwargs        keyword arguments for scipy.signal.fftconvolve</span>
<span class="sd">                  mode = &#39;full&#39; | &#39;same&#39; | &#39;valid&#39;  (see there)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span>
    <span class="kn">import</span> <span class="nn">scipy.signal</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;mode&#39;</span><span class="p">,</span><span class="s">&#39;full&#39;</span><span class="p">)</span>
    <span class="n">series</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>   <span class="c"># must copy because de-meaning modifies it</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">include_mean</span><span class="p">:</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">series</span> <span class="o">-=</span> <span class="n">mean</span>
    <span class="k">if</span> <span class="n">start</span> <span class="ow">or</span> <span class="n">stop</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;valid&#39;</span>   <span class="c"># makes sense to only return the true unpolluted ACF</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">start</span> <span class="ow">or</span> <span class="mi">0</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">stop</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="n">stop</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Must be start &lt; stop but start = </span><span class="si">%(start)d</span><span class="s"> &gt;= stop = </span><span class="si">%(stop)d</span><span class="s">.&#39;</span>
                             <span class="o">%</span> <span class="nb">locals</span><span class="p">())</span>

    <span class="n">ac</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">series</span><span class="p">,</span><span class="n">series</span><span class="p">[</span><span class="n">stop</span><span class="p">:</span><span class="n">start</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">...</span><span class="p">],</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;valid&#39;</span><span class="p">:</span>
        <span class="c"># origin at start+1</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">ac</span><span class="p">[</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="mf">1.0</span>   <span class="c"># to guard against ACFs of zero arrays</span>
        <span class="c"># Note that this is periodic (and symmetric) over result[0,stop-start+1] and so we</span>
        <span class="c"># only return one half:</span>
        <span class="c">##return numpy.concatenate( (ac[start+1:], ac[:start+1]) )[:len(ac)/2] / norm</span>
        <span class="c"># ac is symmetric around start+1 so we average the two halves (just in case):</span>
        <span class="n">ac</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">ac</span><span class="p">[</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">:],</span> <span class="n">ac</span><span class="p">[:</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span> <span class="o">/</span> <span class="n">norm</span>
        <span class="n">ac</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="c"># make space for replicated 0-th element</span>
        <span class="n">ac</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c"># orig ac was even</span>
            <span class="k">return</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">ac</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">ac</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># orig ac was odd: replicate the least important datapoint for second half</span>
            <span class="k">return</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">ac</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">ac</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>        <span class="c"># should work for both odd and even len(series)</span>
        <span class="n">ac</span> <span class="o">=</span> <span class="n">ac</span><span class="p">[</span><span class="n">origin</span><span class="p">:]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">),</span> <span class="s">&quot;Oops: len(ac)=</span><span class="si">%d</span><span class="s">  len(series)=</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ac</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">periodic</span><span class="p">:</span>
            <span class="n">ac</span> <span class="o">*=</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">scipy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ac</span><span class="p">)))</span>   <span class="c"># correct for 0 padding</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">ac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="mf">1.0</span>  <span class="c"># to guard against ACFs of zero arrays</span>
    <span class="k">return</span> <span class="n">ac</span><span class="o">/</span><span class="n">norm</span>
</div>
<div class="viewcode-block" id="averaged_autocorrelation"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.averaged_autocorrelation">[docs]</a><span class="k">def</span> <span class="nf">averaged_autocorrelation</span><span class="p">(</span><span class="n">series</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">sliding_window</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the averaged ACF of a series.</span>

<span class="sd">    mean(acf), std(acf) = averaged_autocorrelation(series,length=None,sliding_window=None):</span>

<span class="sd">    Calculate the ACF of a series for only a fraction of the total length, &lt;length&gt; but</span>
<span class="sd">    repeat the calculation by setting the origin progressively every &lt;sliding_window&gt;</span>
<span class="sd">    steps and average over all the ACFs.</span>

<span class="sd">    :Arguments:</span>
<span class="sd">    series          time series (by default, mean will be removed)</span>
<span class="sd">    length          length (in frames) of the ACF (default: 1/2*len(series))</span>
<span class="sd">    sliding_window  repeat ACF calculation every N frames (default: len(series)/100)</span>
<span class="sd">    kwargs          additional arguments to autocorrelation_fft()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;start&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span> <span class="c"># must filter those kwargs as we set them ourselves</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;stop&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">nframes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">length</span> <span class="ow">or</span> <span class="n">nframes</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">_length</span> <span class="o">=</span> <span class="n">nframes</span> <span class="o">-</span> <span class="n">length</span>   <span class="c"># _length is the length of the comparison series</span>
    <span class="n">sliding_window</span> <span class="o">=</span> <span class="n">sliding_window</span> <span class="ow">or</span> <span class="n">nframes</span><span class="o">/</span><span class="mi">100</span>
    <span class="c"># note: do NOT be tempted to change nframes-_length to nframes-_length+1</span>
    <span class="c">#       (this will make the last acf 1 step longer, see series[stop:start:-1] !)</span>
    <span class="n">acfs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">autocorrelation_fft</span><span class="p">(</span><span class="n">series</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="o">=</span><span class="n">start</span><span class="o">+</span><span class="n">_length</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nframes</span><span class="o">-</span><span class="n">_length</span><span class="p">,</span><span class="n">sliding_window</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">acfs</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">acfs</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


<span class="c"># Compatibility layer for running in python 2.3</span>

<span class="c"># sorted()</span>
<span class="c"># --- (can also use numpy.sort function instead) ---</span></div>
<span class="k">try</span><span class="p">:</span>
    <span class="nb">sorted</span><span class="p">([])</span>
    <span class="nb">sorted</span> <span class="o">=</span> <span class="nb">sorted</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="nb">cmp</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;sorted(iterable, cmp=None, key=None, reverse=False) --&gt; new sorted list</span>
<span class="sd">        Naive pre python 2.4 compatibility fudge.</span>

<span class="sd">        With key, cmp must make use of triplets (key,int,value).</span>
<span class="sd">        It&#39;s a fudge after all.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">L</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">if</span> <span class="nb">cmp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="nb">cmp</span><span class="p">,)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">L</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># decorate-sort-undecorate</span>
            <span class="n">deco</span> <span class="o">=</span> <span class="p">[(</span><span class="n">key</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">L</span><span class="p">)]</span>
            <span class="n">deco</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="n">L</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">deco</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
            <span class="n">L</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">L</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">collections</span>
    <span class="k">class</span> <span class="nc">Fifo</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">):</span>
        <span class="n">pop</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="o">.</span><span class="n">popleft</span>

    <span class="k">class</span> <span class="nc">Ringbuffer</span><span class="p">(</span><span class="n">Fifo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ring buffer of size capacity; &#39;pushes&#39; data from left and discards</span>
<span class="sd">        on the right.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#  See http://mail.python.org/pipermail/tutor/2005-March/037149.html.</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">capacity</span><span class="p">,</span><span class="n">iterable</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">iterable</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">iterable</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">Ringbuffer</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">capacity</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">capacity</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">:</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">Ringbuffer</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>   <span class="c"># prune initial loading</span>
        <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">:</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">Ringbuffer</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">Ringbuffer</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;Ringbuffer(capacity=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;, &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span><span class="o">+</span><span class="s">&quot;)&quot;</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
<div class="viewcode-block" id="Ringbuffer"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.Ringbuffer">[docs]</a>    <span class="k">class</span> <span class="nc">Ringbuffer</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ringbuffer that can be treated as a list. Note that the real queuing</span>
<span class="sd">        order is only obtained with the tolist() method.</span>

<span class="sd">        Based on</span>
<span class="sd">        http://www.onlamp.com/pub/a/python/excerpt/pythonckbk_chap1/index1.html</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="n">iterable</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">capacity</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">capacity</span>
            <span class="k">if</span> <span class="n">iterable</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[:]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">iterable</span><span class="p">)[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">:]</span>

        <span class="k">class</span> <span class="nc">__Full</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
                <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span>
            <span class="k">def</span> <span class="nf">tolist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Return a list of elements from the oldest to the newest.&quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="p">:]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">Ringbuffer</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c"># Permanently change self&#39;s class from non-full to full</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__Full</span>
        <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">iterable</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">iterable</span><span class="p">)[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">:]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">tolist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Return a list of elements from the oldest to the newest.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;Ringbuffer(capacity=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;, &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span><span class="o">+</span><span class="s">&quot;)&quot;</span>
</div>
<div class="viewcode-block" id="DefaultDict"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.DefaultDict">[docs]</a><span class="k">class</span> <span class="nc">DefaultDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dictionary based on defaults and updated with keys/values from user.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">defaultdict</span><span class="p">,</span><span class="n">userdict</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DefaultDict</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">defaultdict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">userdict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">userdict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IntrospectiveDict"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.IntrospectiveDict">[docs]</a><span class="k">class</span> <span class="nc">IntrospectiveDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dictionary that contains its keys as attributes for easier introspection.</span>

<span class="sd">    Keys that collide with dict methods or attributes are _not_ added as attributes.</span>

<span class="sd">    The implementation is simple and certainly not optimized for larger dictionaries</span>
<span class="sd">    or ones which are often accessed. Only use it for &#39;final results&#39; collections</span>
<span class="sd">    that you are likely to investigate interactively.</span>

<span class="sd">    ARGH: This cannot be pickled safely.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">IntrospectiveDict</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__reserved</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>  <span class="c"># don&#39;t know how to use super here?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span>   <span class="c"># maybe something changed? Can&#39;t be bothered to subclass update,etc</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">IntrospectiveDict</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__getattr__</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c"># initialisation of the attributes from the keys</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reserved</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__setattr__</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>

</div>
<span class="kn">import</span> <span class="nn">MDAnalysis.core.log</span>
<div class="viewcode-block" id="CustomProgressMeter"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.CustomProgressMeter">[docs]</a><span class="k">class</span> <span class="nc">CustomProgressMeter</span><span class="p">(</span><span class="n">MDAnalysis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">ProgressMeter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ProgressMeter that uses addition &#39;%(other)s&#39; in format string.</span>

<span class="sd">    .. SeeAlso:: :class:`MDAnalysis.core.log.ProgressMeter`</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="CustomProgressMeter.echo"><a class="viewcode-back" href="../../hop/utilities.html#hop.utilities.CustomProgressMeter.echo">[docs]</a>    <span class="k">def</span> <span class="nf">echo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Output status for *step* with additional information *other*.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">other</span> <span class="o">=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CustomProgressMeter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">step</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Hop 0.3.3 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Thomas B. Woolf, Oliver Beckstein.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>